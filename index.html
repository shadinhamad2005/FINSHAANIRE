<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finshaanire v2.5 | Wealth Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script>
        window.onerror = function (msg, url, line, col, error) {
            const box = document.createElement('div');
            box.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,0,0,0.9);color:white;padding:20px;z-index:9999;font-weight:bold;text-align:left;overflow:auto;display:flex;flex-direction:column;justify-content:center;align-items:center;';
            box.innerHTML = `<div style="background:white;color:black;padding:20px;border-radius:10px;max-width:90%;"><h3>‚ö†Ô∏è Critical Error</h3><p>${msg}</p><p>Line: ${line} Col: ${col}</p><pre style="background:#f0f0f0;padding:10px;border-radius:5px;margin-top:10px;text-align:left;overflow-x:auto;">${error ? error.stack : ''}</pre><button onclick="window.location.reload()" style="background:#10b981;color:white;padding:10px 20px;margin-top:20px;border-radius:5px;font-weight:bold;">Reload App</button></div>`;
            document.body.appendChild(box);
            return false;
        };

        // Helper: Currency Conversion (INR/Other -> AED Base)
        window.convert = function (amt, currency) {
            let r = 22.75; // Fallback
            if (typeof state !== 'undefined' && state.data && state.data.settings) {
                r = state.data.settings.rate;
            }
            if (currency === 'AED') return parseFloat(amt);
            if (currency === 'INR') return parseFloat(amt) / r;
            return parseFloat(amt);
        };
    </script>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');

        :root {
            /* Default: Emerald (Wealth) */
            --primary: #10b981;
            --primary-dark: #059669;
            --primary-light: #ecfdf5;
            --primary-rgb: 16, 185, 129;

            --bg-main: #f8fafc;
            --bg-card: #ffffff;
            --bg-sub: #f1f5f9;
            --bg-input: #f8fafc;

            --text-main: #0f172a;
            --text-muted: #94a3b8;
            --text-inv: #ffffff;

            --btn-solid: #0f172a;
            --btn-text: #ffffff;
            --border-color: #e2e8f0;
        }

        /* THEME OVERRIDES Engine */
        .bg-emerald-500 {
            background-color: var(--primary) !important;
        }

        .hover\:bg-emerald-500:hover {
            background-color: var(--primary) !important;
        }

        .text-emerald-500 {
            color: var(--primary) !important;
        }

        .bg-emerald-600 {
            background-color: var(--primary-dark) !important;
        }

        .text-emerald-600 {
            color: var(--primary-dark) !important;
        }

        .hover\:text-emerald-600:hover {
            color: var(--primary-dark) !important;
        }

        .bg-emerald-50 {
            background-color: var(--primary-light) !important;
        }

        .border-emerald-100 {
            border-color: var(--primary-light) !important;
        }

        .ring-emerald-100 {
            --tw-ring-color: var(--primary-light) !important;
        }

        .shadow-emerald-500\/20 {
            box-shadow: 0 10px 15px -3px rgba(var(--primary-rgb), 0.2) !important;
        }

        /* Dark Mode / Layout Adaptation */
        body,
        .bg-slate-50 {
            background-color: var(--bg-main) !important;
            transition: background-color 0.5s ease;
        }

        .bg-white {
            background-color: var(--bg-card) !important;
            color: var(--text-main) !important;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        .bg-slate-100 {
            background-color: var(--bg-sub) !important;
        }

        .text-slate-900 {
            color: var(--text-main) !important;
        }

        .text-slate-500,
        .text-slate-400 {
            color: var(--text-muted) !important;
        }

        .bg-slate-900 {
            background-color: var(--btn-solid) !important;
            color: var(--btn-text) !important;
        }

        input,
        select {
            background-color: var(--bg-input) !important;
            color: var(--text-main) !important;
            border-color: var(--border-color) !important;
        }

        .border-slate-200,
        /* CYBER-SLATE IDENTITY */
        .logo-text {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 50%, var(--text-main) 100%);
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            /* Standard method */
            font-weight: 900;
            position: relative;
        }

        /* MODERN FINTECH LOGO */
        .fs-logo-modern {
            position: relative;
            background-color: #0f172a;
            /* Deep Charcoal Slate */
            color: white;
            font-weight: 900;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--primary);
            box-shadow: 0 0 15px -3px rgba(var(--primary-rgb), 0.4);
            transition: all 0.5s ease;
        }

        .fs-logo-modern::after {
            content: '';
            position: absolute;
            top: 0;
            left: -150%;
            width: 150%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transform: skewX(-20deg);
            animation: modernScan 4s infinite linear;
            pointer-events: none;
        }

        @keyframes modernScan {
            0% {
                left: -150%;
            }

            20% {
                left: 150%;
            }

            /* Fast sweep */
            100% {
                left: 150%;
            }

            /* Wait */
        }

        /* Scanning Light Effect */
        .scan-light {
            position: relative;
            overflow: hidden;
        }

        .scan-light::after {
            content: '';
            position: absolute;
            top: 0;
            left: -150%;
            width: 50%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transform: skewX(-20deg);
            animation: scan 4s infinite ease-in-out;
            pointer-events: none;
        }

        @keyframes scan {
            0% {
                left: -150%;
            }

            20% {
                left: 150%;
            }

            /* Fast sweep */
            100% {
                left: 150%;
            }

            /* Wait */
        }

        /* Smooth UI Transitions */
        .card-enter {
            animation: cardEnter 0.4s cubic-bezier(0.16, 1, 0.3, 1) backwards;
        }

        @keyframes cardEnter {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Hover Lifts */
        .hover-lift {
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .hover-lift:hover {
            transform: translateY(-4px) scale(1.01);
        }

        .active-press:active {
            transform: scale(0.95);
        }

        /* Standard Utils */
        body {
            font-family: 'Outfit', sans-serif;
            overflow-x: hidden;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #app-content,
        #auth-screen {
            display: none;
        }

        .num-font,
        .money-font {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-variant-numeric: tabular-nums;
            letter-spacing: -0.02em;
            font-weight: 700;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900 text-center selection:bg-emerald-500/30">

    <!-- 1. AUTH SCREEN -->
    <div id="auth-screen" class="min-h-screen flex flex-col items-center justify-center p-6 bg-white">
        <div class="w-full max-w-md space-y-10 text-center">
            <div>
                <div class="fs-logo-modern w-20 h-20 text-4xl mx-auto mb-6">FS</div>
                <h1 class="text-4xl font-extrabold tracking-tight text-slate-900 text-center">Finshaanire</h1>
                <p class="text-slate-500 mt-2 font-medium text-center">Wealth Management and Budgeting.</p>
            </div>
            <div class="bg-white p-8 rounded-3xl shadow-2xl border border-slate-100 space-y-6 text-center">
                <div id="auth-error-msg"
                    class="hidden p-4 bg-red-50 text-red-700 text-xs font-bold rounded-2xl border border-red-100 text-center">
                </div>
                <div class="space-y-4 text-left">
                    <div>
                        <label
                            class="text-xs font-bold text-slate-400 uppercase tracking-widest ml-1 text-center">Email</label>
                        <input type="email" id="login-email"
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none text-center"
                            placeholder="name@email.com">
                    </div>
                    <div>
                        <label
                            class="text-xs font-bold text-slate-400 uppercase tracking-widest ml-1 text-center">Password</label>
                        <input type="password" id="login-pass"
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none transition-all text-center"
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                </div>
                <div class="space-y-3 text-center">
                    <button id="login-btn" onclick="window.handleLogin()"
                        class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold hover:bg-emerald-600 transition-all shadow-lg flex items-center justify-center space-x-2 text-center text-center">
                        <span id="btn-text">Sign In</span>
                        <div id="btn-loader" class="hidden loader border-white"></div>
                    </button>
                    <button onclick="window.handleRegister()"
                        class="w-full py-2 text-sm text-slate-400 hover:text-emerald-600 font-bold transition-all text-center text-center">Create
                        Account</button>
                </div>
            </div>
        </div>
    </div>

    <!-- CUSTOM MODALS -->
    <!-- 1. Confirmation Modal -->
    <div id="confirm-modal"
        class="fixed inset-0 z-[110] hidden items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm fade-in">
        <div class="bg-white rounded-[2rem] p-8 max-w-sm w-full text-center shadow-2xl scale-in">
            <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="alert-triangle" class="w-8 h-8 text-red-500"></i>
            </div>
            <h3 id="confirm-title" class="text-xl font-black text-slate-900 mb-2">Are you sure?</h3>
            <p id="confirm-msg" class="text-sm text-slate-500 font-medium mb-8">This action cannot be undone.</p>
            <div class="grid grid-cols-2 gap-4">
                <button id="confirm-cancel-btn"
                    onclick="document.getElementById('confirm-modal').classList.replace('flex', 'hidden')"
                    class="p-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition-colors">Cancel</button>
                <button id="confirm-yes-btn"
                    class="p-3 bg-red-500 text-white rounded-xl font-bold hover:bg-red-600 transition-colors shadow-lg shadow-red-500/30">Yes,
                    Delete</button>
            </div>
        </div>
    </div>

    <!-- 2. Prompt Modal -->
    <div id="prompt-modal"
        class="fixed inset-0 z-[110] hidden items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm fade-in">
        <div class="bg-white rounded-[2rem] p-8 max-w-sm w-full text-center shadow-2xl scale-in">
            <h3 id="prompt-title" class="text-xl font-black text-slate-900 mb-2">Input Required</h3>
            <p id="prompt-msg" class="text-xs text-slate-500 font-bold uppercase tracking-widest mb-4">Enter Value</p>
            <input type="text" id="prompt-input"
                class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl text-center font-bold text-lg outline-none focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/10 mb-6"
                placeholder="...">
            <div class="grid grid-cols-2 gap-4">
                <button onclick="document.getElementById('prompt-modal').classList.replace('flex', 'hidden')"
                    class="p-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition-colors">Cancel</button>
                <button id="prompt-yes-btn"
                    class="p-3 bg-emerald-500 text-white rounded-xl font-bold hover:bg-emerald-600 transition-colors shadow-lg shadow-emerald-500/30">Confirm</button>
            </div>
        </div>
    </div>

    <!-- 3. Toast Container (Z-Index increased to 9999 to cover Modals) -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-[9999] space-y-3 pointer-events-none"></div>

    <!-- 2. MAIN DASHBOARD -->
    <div id="app-content" class="min-h-screen flex flex-col relative bg-slate-50"
        style="padding-bottom: calc(2.5rem + env(safe-area-inset-bottom));">

        <nav class="bg-white/90 backdrop-blur-md h-20 relative z-40 border-b border-slate-200">
            <div class="max-w-7xl mx-auto px-6 h-full flex justify-between items-center">
                <div class="flex items-center space-x-3 text-left">
                    <div class="fs-logo-modern w-10 h-10 text-xl">FS</div>
                    <span class="text-xl font-black tracking-tight logo-text">Finshaanire</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="window.openModal('auth')"
                        class="flex items-center space-x-2 bg-slate-50 hover:bg-slate-100 px-3 py-2 rounded-xl transition-all border border-slate-200">
                        <i data-lucide="user" class="w-4 h-4 text-slate-400"></i>
                    </button>
                    <!-- Exchange Rate Badge -->
                    <div id="exchange-rate-badge"
                        class="hidden md:flex bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded-full text-[10px] font-bold border border-emerald-100 items-center gap-2">
                        <span class="opacity-60 uppercase">1 AED =</span>
                        <span id="rate-display" class="num-font font-bold">--</span>
                        <span class="opacity-60 uppercase">INR</span>
                    </div>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto px-6 py-8 w-full flex-grow space-y-8 relative z-10">
            <!-- Smart Insights (Morning Briefing) -->
            <section id="smart-insights-panel" class="hidden fade-in space-y-4">
                <div class="flex items-center space-x-2 px-2">
                    <span class="text-xl">üåû</span>
                    <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Morning Briefing</h3>
                </div>
                <div id="insights-list" class="space-y-3">
                    <!-- Dynamic Insight Cards go here -->
                </div>
            </section>

            <!-- Dues Notifications -->
            <section id="notification-panel" class="hidden fade-in space-y-4 text-center">
                <h3
                    class="text-[10px] font-black text-slate-400 uppercase tracking-widest px-2 flex items-center justify-center lg:justify-start text-center">
                    <i data-lucide="bell" class="w-3 h-3 mr-2 text-amber-500 text-center"></i> Action Required
                </h3>
                <div id="upcoming-dues-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-center">
                </div>
            </section>

            <!-- Installment Due (BNPL) -->
            <section id="installments-panel" class="hidden fade-in space-y-4 text-center">
                <h3
                    class="text-[10px] font-black text-slate-400 uppercase tracking-widest px-2 flex items-center justify-center lg:justify-start text-center">
                    <i data-lucide="calendar-clock" class="w-3 h-3 mr-2 text-indigo-500 text-center"></i> Installment
                    Due
                </h3>
                <div id="installments-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-center">
                </div>
            </section>

            <!-- Summary -->
            <section class="grid grid-cols-1 lg:grid-cols-3 gap-8 text-center">
                <div
                    class="lg:col-span-2 bg-white rounded-[2.5rem] p-10 border border-slate-200 flex flex-col justify-between shadow-sm relative overflow-hidden text-center">
                    <div
                        class="flex flex-col md:flex-row justify-between items-start md:items-center text-center md:text-left gap-6">
                        <div class="flex-1 min-w-0">
                            <p class="text-slate-400 text-[10px] font-black uppercase tracking-widest">Current Net
                                Wealth</p>
                            <div class="flex flex-wrap items-baseline gap-x-4 gap-y-1 mt-1">
                                <span id="total-primary"
                                    class="text-4xl md:text-6xl font-black tracking-tighter text-slate-900 break-all">‚Çπ0.00</span>
                                <span id="total-secondary"
                                    class="text-xl font-bold text-teal-600/60 whitespace-nowrap">AED 0.00</span>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2 justify-center md:justify-end w-full md:w-auto shrink-0">
                            <button onclick="window.openModal('budget')"
                                class="p-3 bg-slate-50 hover:bg-slate-100 rounded-2xl border border-slate-200 text-slate-400"
                                title="Budgeting"><i data-lucide="target" class="w-5 h-5 mx-auto"></i></button>
                            <button onclick="window.openModal('analytics')"
                                class="p-3 bg-slate-50 hover:bg-slate-100 rounded-2xl border border-slate-200 text-slate-400"
                                title="Charts"><i data-lucide="pie-chart" class="w-5 h-5 mx-auto"></i></button>
                            <button onclick="window.openModal('performance')"
                                class="p-3 bg-slate-50 hover:bg-slate-100 rounded-2xl border border-slate-200 text-slate-400"
                                title="Growth"><i data-lucide="trending-up" class="w-5 h-5 mx-auto"></i></button>
                            <button onclick="window.toggleVisibility()"
                                class="p-3 bg-slate-50 hover:bg-slate-100 rounded-2xl border border-slate-200 text-slate-400"><i
                                    data-lucide="eye" id="vis-icon" class="w-5 h-5 mx-auto"></i></button>
                            <button onclick="window.openModal('settings')"
                                class="p-3 bg-slate-50 hover:bg-slate-100 rounded-2xl border border-slate-200 text-slate-400"><i
                                    data-lucide="settings" class="w-5 h-5 mx-auto"></i></button>
                        </div>
                    </div>
                    <div
                        class="grid grid-cols-2 md:grid-cols-4 gap-6 mt-12 border-t border-slate-100 pt-8 text-center text-center text-center">
                        <div>
                            <p class="text-[9px] uppercase font-black text-slate-400 mb-1 text-center">UAE Vault</p>
                            <p id="uae-val" class="font-bold text-lg text-slate-800 text-center">AED 0.00</p>
                        </div>
                        <div>
                            <p class="text-[9px] uppercase font-black text-slate-400 mb-1 text-center">India Portfolio
                            </p>
                            <p id="india-val" class="font-bold text-lg text-slate-800 text-center">‚Çπ0.00</p>
                        </div>
                        <div>
                            <p class="text-[9px] uppercase font-black text-slate-400 mb-1 text-red-500 text-center">I
                                Owe</p>
                            <p id="pay-val" class="font-bold text-lg text-red-500 text-center">‚Çπ0.00</p>
                        </div>
                        <div>
                            <p class="text-[9px] uppercase font-black text-slate-400 mb-1 text-emerald-600 text-center">
                                Investments</p>
                            <p id="inv-val" class="font-bold text-lg text-emerald-600 text-center">‚Çπ0.00</p>
                        </div>
                    </div>
                </div>

                <div
                    class="bg-white rounded-[2.5rem] p-8 border border-slate-200 flex flex-col justify-between shadow-sm text-center">
                    <h3
                        class="text-xs font-black text-slate-400 uppercase tracking-widest flex items-center mb-6 justify-center lg:justify-start text-center">
                        <i data-lucide="layout-grid" class="w-4 h-4 mr-2 text-center text-center text-center"></i>
                        Navigation
                    </h3>
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <button onclick="window.openModal('transaction')"
                            class="flex flex-col items-center justify-center p-6 rounded-3xl bg-emerald-500 text-white shadow-lg active:scale-95 transition-all text-center">
                            <i data-lucide="plus" class="w-6 h-6 mb-2 mx-auto text-center"></i><span
                                class="text-[10px] font-black uppercase tracking-widest text-center">Entry</span>
                        </button>
                        <button onclick="window.openModal('transfer')"
                            class="flex flex-col items-center justify-center p-6 rounded-3xl bg-slate-900 text-white shadow-lg active:scale-95 transition-all text-center">
                            <i data-lucide="arrow-right-left" class="w-6 h-6 mb-2 mx-auto text-center"></i><span
                                class="text-[10px] font-black uppercase tracking-widest text-center">Transfer</span>
                        </button>
                        <button onclick="window.openModal('accounts')"
                            class="flex flex-col items-center justify-center p-6 rounded-3xl border-2 border-slate-100 hover:bg-slate-50 text-slate-600 active:scale-95 transition-all text-center">
                            <i data-lucide="wallet" class="w-6 h-6 mb-2 mx-auto text-emerald-600 text-center"></i><span
                                class="text-[10px] font-black uppercase text-center text-center">Asset</span>
                        </button>
                        <button onclick="window.openModal('debt')"
                            class="flex flex-col items-center justify-center p-6 rounded-3xl border-2 border-slate-100 hover:bg-slate-50 text-slate-600 active:scale-95 transition-all text-center">
                            <i data-lucide="users" class="w-6 h-6 mb-2 mx-auto text-amber-500 text-center"></i><span
                                class="text-[10px] font-black uppercase text-center">Debts</span>
                        </button>
                        <button onclick="window.openModal('subscriptions')"
                            class="col-span-2 flex flex-col items-center justify-center p-6 rounded-3xl border-2 border-slate-100 hover:bg-slate-50 text-slate-600 active:scale-95 transition-all text-center">
                            <i data-lucide="refresh-cw"
                                class="w-6 h-6 mb-2 mx-auto text-indigo-500 text-center"></i><span
                                class="text-[10px] font-black uppercase text-center">Recurring Auto-Pay</span>
                        </button>
                    </div>
                </div>
            </section>

            <!-- Tables -->
            <section class="grid grid-cols-1 lg:grid-cols-2 gap-8 text-left text-center">
                <div>
                    <h3
                        class="flex items-center font-black text-slate-400 text-[11px] uppercase tracking-widest px-2 mb-4 justify-center lg:justify-start text-center">
                        <img src="https://flagcdn.com/ae.svg" class="w-5 h-3.5 mr-2 rounded shadow-sm text-center"> UAE
                        Vault
                    </h3>
                    <div id="uae-list" class="grid gap-4 text-center"></div>
                </div>
                <div>
                    <h3
                        class="flex items-center font-black text-slate-400 text-[11px] uppercase tracking-widest px-2 mb-4 justify-center lg:justify-start text-center text-center text-center">
                        <img src="https://flagcdn.com/in.svg"
                            class="w-5 h-3.5 mr-2 rounded shadow-sm text-center text-center"> India Portfolio
                    </h3>
                    <div id="india-list" class="grid gap-4 text-center text-center"></div>
                </div>
            </section>

            <!-- LEDGER BUTTON CARD -->
            <section
                class="bg-gradient-to-br from-slate-900 to-slate-800 rounded-[2.5rem] p-1 text-center shadow-xl mb-4">
                <button onclick="window.openMasterLedger()"
                    class="w-full h-full bg-transparent p-6 rounded-[2.4rem] flex flex-col items-center justify-center group relative overflow-hidden transition-all hover:bg-white/5">
                    <div
                        class="absolute top-0 right-0 w-32 h-32 bg-emerald-500/10 rounded-full blur-3xl -mr-10 -mt-10 pointer-events-none">
                    </div>
                    <div class="relative z-10 flex flex-col items-center">
                        <div
                            class="w-16 h-16 bg-white/10 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                            <i data-lucide="book-open" class="w-8 h-8 text-emerald-400"></i>
                        </div>
                        <h3 class="text-xl font-black text-white uppercase tracking-wider mb-1">Transaction Ledger</h3>
                        <p class="text-slate-400 text-xs font-bold">View full history, search & filter</p>
                    </div>
                </button>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <div id="reminder-overlay"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[110] hidden items-center justify-center p-6 text-center text-center text-center">
        <div
            class="bg-white rounded-[2.5rem] w-full max-w-md shadow-2xl p-8 space-y-6 border-t-8 border-amber-500 fade-in text-center text-center text-center text-center">
            <div class="flex items-center justify-center space-x-4 text-center">
                <div class="bg-amber-50 p-3 rounded-2xl text-amber-600 mx-auto text-center text-center"><i
                        data-lucide="bell-ring" class="w-8 h-8 mx-auto text-center text-center"></i></div>
                <div class="text-left text-center text-center">
                    <h2 class="text-xl font-black text-slate-900 tracking-tight text-left">Due Today</h2>
                    <p class="text-sm text-slate-500 text-left text-center text-center">A settlement target reached.</p>
                </div>
            </div>
            <div id="reminder-details"
                class="bg-slate-50 p-6 rounded-3xl space-y-2 font-bold text-slate-700 text-center text-center"></div>
            <div class="grid grid-cols-2 gap-4 text-center">
                <button id="remit-settle-btn"
                    class="bg-emerald-500 text-white py-4 rounded-2xl font-bold shadow-lg text-center text-center">Settle
                    Now</button>
                <button id="remit-resched-btn"
                    class="bg-slate-100 text-slate-600 py-4 rounded-2xl font-bold text-center text-center text-center">Schedule
                    Later</button>
            </div>
            <button id="remit-ignore-btn"
                class="w-full text-xs font-bold text-slate-400 uppercase tracking-widest text-center text-center text-center hover:text-slate-600 transition-colors">Ignore
                (Snooze 5h)</button>
        </div>
    </div>

    <div id="modal-backdrop"
        class="fixed inset-0 bg-white z-[100] hidden flex-col overflow-hidden text-center text-center">
        <div class="h-20 bg-white border-b border-slate-100 px-6 flex justify-between items-center text-center">
            <div class="flex items-center space-x-3 text-center text-center text-center text-center">
                <button onclick="window.closeModal()"
                    class="p-3 bg-slate-50 rounded-2xl text-slate-600 hover:bg-slate-100 transition-all mr-2 text-center text-center text-center text-center text-center">
                    <i data-lucide="arrow-left"
                        class="w-6 h-6 mx-auto text-center text-center text-center text-center text-center"></i>
                </button>
                <h2 id="modal-title"
                    class="text-2xl font-black text-slate-900 tracking-tight text-left text-center text-center text-center text-center text-center">
                    Title</h2>
            </div>
            <button onclick="window.closeModal()"
                class="p-3 text-slate-400 hover:text-slate-600 text-center text-center text-center text-center">
                <i data-lucide="x" class="w-8 h-8 mx-auto text-center text-center"></i>
            </button>
        </div>
        <div id="modal-content"
            class="flex-grow p-8 max-w-4xl mx-auto w-full overflow-y-auto custom-scrollbar fade-in text-center text-center text-center">
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword, updatePassword, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCbYXBMRtIDhB49nQexCTHQY2YPeInHLJ8", authDomain: "my-finance-454c2.firebaseapp.com", projectId: "my-finance-454c2", storageBucket: "my-finance-454c2.firebasestorage.app", messagingSenderId: "18874709232", appId: "1:18874709232:web:b9b007e07042fb0cf87e35" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'finshaanire-v2';

        let state = {
            user: null,
            data: {
                accounts: [],
                transactions: [],
                debts: [],
                budgets: {},
                goals: [], // { id, name, target, saved, currency, icon }
                portfolio: {}, // { schemeCode: { nav, date, name } }
                commodityRates: { Gold: 7200, Silver: 90, Platinum: 2500, Palladium: 3000 }, // INR per gram default
                allocationTargets: { 'Real Estate': 0, 'Gold': 20, 'Equity': 50, 'Cash': 30 },
                settings: { rate: 22.75, isPrivate: false, theme: 'emerald' },
                incomeCategories: ['Salary', 'Bonus', 'Investment Return', 'Other'],
                expenseCategories: ['Rent', 'Food', 'Utilities', 'Investment', 'Family', 'Other'],
                assetTypes: ['Bank Account', 'Cash', 'Savings', 'Investment'] // Simplified
            }
        };

        // --- GLOBAL FUNCTION ASSIGNMENTS ---
        window.closeModal = () => document.getElementById('modal-backdrop').classList.replace('flex', 'hidden');
        window.closeReminder = () => document.getElementById('reminder-overlay').classList.add('hidden');
        window.updateDb = async () => {
            if (!state.user) return;
            // Sanitize data to remove undefined values (Firebase doesn't accept them)
            const sanitizeData = (obj) => {
                if (obj === null || obj === undefined) return null;
                if (Array.isArray(obj)) return obj.map(sanitizeData).filter(item => item !== null && item !== undefined);
                if (typeof obj === 'object') {
                    const cleaned = {};
                    for (const key in obj) {
                        const value = sanitizeData(obj[key]);
                        if (value !== undefined && value !== null) cleaned[key] = value;
                    }
                    return cleaned;
                }
                return obj;
            };
            const cleanedData = sanitizeData(state.data);
            await setDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'finance', 'main'), cleanedData);
        };

        // Math Helper: Money Class for Financial Grade Integer Math
        class Money {
            constructor(cents) {
                this.cents = Math.round(cents);
            }
            static fromAmount(amount) {
                return new Money(Math.round(amount * 100));
            }
            static fromCents(cents) {
                return new Money(cents);
            }
            add(m) { return new Money(this.cents + m.cents); }
            subtract(m) { return new Money(this.cents - m.cents); }
            multiply(factor) { return new Money(Math.round(this.cents * factor)); }
            divide(divisor) { return new Money(Math.round(this.cents / divisor)); }
            get amount() { return this.cents / 100; }
            format(currency = 'AED') {
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: currency }).format(this.amount);
            }
        }
        window.Money = Money;

        // LEGACY COMPATIBILITY: Wrapper to keep existing code working until fully refactored
        // Ensures strict 2 decimal places to avoid floating point errors
        window.toCurrency = (num) => parseFloat(Number(num).toFixed(2));

        // LEDGER-BASED TRUTH: Recalculate all account balances from transaction history
        window.recalculateBalances = function () {
            // 1. Snapshot defined Initial Balances (if we had them, defaulting to 0 for now)
            // Strategy: We assume existing accounts starts at 0 and history is complete.
            // If history is partial, we might need a distinct "Opening Balance" transaction.
            const balances = {};
            state.data.accounts.forEach(a => balances[a.id] = 0);

            // 2. Replay History
            state.data.transactions.forEach(t => {
                const amt = Math.round(parseFloat(t.amount) * 100); // work in cents

                if (t.type === 'income') {
                    if (balances[t.accountId] !== undefined) balances[t.accountId] += amt;
                } else if (t.type === 'expense') {
                    if (balances[t.accountId] !== undefined) balances[t.accountId] -= amt;
                } else if (t.type === 'transfer_out') {
                    if (balances[t.accountId] !== undefined) balances[t.accountId] -= amt;
                } else if (t.type === 'transfer_in') {
                    if (balances[t.accountId] !== undefined) balances[t.accountId] += amt;
                }
            });

            // 3. Update State (In-Memory Only - Do not persist derived balance if possible, or persist for cache)
            // For this 'Financial Grade' refactor, we WILL persist it for performance, but ONLY satisfy it via this function.
            state.data.accounts.forEach(a => {
                // Commodity/Mutual Fund accounts are VALUE based on price, not ledger sum usually.
                // BUT, if they are tracked by units/cost, we should track COST basis here.
                // For now, only apply strict ledger to Cash/Bank.
                if (['Bank Account', 'Cash', 'Savings'].includes(a.type)) {
                    a.balance = balances[a.id] / 100;
                }
            });
        };

        // ID Helper: Generates robust unique IDs
        window.genId = () => Date.now().toString() + '_' + Math.floor(Math.random() * 1000);

        // Helper: Toggle Button State to prevent double-clicks
        window.setBtnLoading = (btnId, isLoading) => {
            const btn = document.getElementById(btnId);
            if (!btn) return;
            if (isLoading) {
                btn.disabled = true;
                btn.dataset.originalText = btn.innerText;
                btn.innerText = "Processing...";
                btn.classList.add('opacity-70', 'cursor-not-allowed');
            } else {
                btn.disabled = false;
                if (btn.dataset.originalText) btn.innerText = btn.dataset.originalText;
                btn.classList.remove('opacity-70', 'cursor-not-allowed');
            }
        };

        // SIGN OUT FIX: Added a global handler for sign out
        window.handleSignOut = async function () {
            try {
                await signOut(auth);
                location.reload();
            } catch (err) {
                console.error("Sign out error", err);
            }
        };

        window.handleChangePassword = async function () {
            const oldP = document.getElementById('cp-old').value;
            const newP = document.getElementById('cp-new').value;
            const cnfP = document.getElementById('cp-cnf').value;

            if (!oldP || !newP || !cnfP) {
                window.showToast("Please fill all fields.", "error"); return;
            }
            if (newP !== cnfP) {
                window.showToast("New passwords do not match.", "error"); return;
            }
            if (newP.length < 6) {
                window.showToast("Password must be at least 6 chars.", "error"); return;
            }

            // Lock UI
            const btn = document.querySelector('button[onclick="window.handleChangePassword()"]');
            const originalText = btn.innerText;
            btn.innerText = "Verifying...";
            btn.disabled = true;
            btn.classList.add('opacity-50');

            try {
                const cred = EmailAuthProvider.credential(state.user.email, oldP);
                await reauthenticateWithCredential(state.user, cred);

                btn.innerText = "Updating...";
                await updatePassword(state.user, newP);

                window.closeModal();
                window.showToast("Password Change Successful!", "success");
                window.openModal('auth'); // Return to profile
            } catch (error) {
                console.error("Password Change Error:", error);
                let msg = "Failed to update password.";
                if (error.code === 'auth/wrong-password') msg = "Current password is incorrect.";
                if (error.code === 'auth/weak-password') msg = "Password is too weak.";
                if (error.code === 'auth/requires-recent-login') msg = "Key expired. Please relogin.";
                window.showToast(msg, "error");

                // Reset Button
                btn.innerText = originalText;
                btn.disabled = false;
                btn.classList.remove('opacity-50');
            }
        };

        // --- THEME ENGINE ---
        window.applyTheme = function (theme) {
            const root = document.documentElement;
            // Define Theme Palettes
            const themes = {
                emerald: {
                    '--primary': '#10b981', '--primary-dark': '#059669', '--primary-light': '#ecfdf5', '--primary-rgb': '16, 185, 129',
                    '--bg-main': '#f8fafc', '--bg-card': '#ffffff', '--bg-sub': '#f1f5f9', '--bg-input': '#f8fafc',
                    '--text-main': '#0f172a', '--text-muted': '#64748b', '--btn-solid': '#0f172a', '--btn-text': '#ffffff', '--border-color': '#e2e8f0'
                },
                blue: {
                    '--primary': '#3b82f6', '--primary-dark': '#1d4ed8', '--primary-light': '#eff6ff', '--primary-rgb': '59, 130, 246',
                    '--bg-main': '#f0f9ff', '--bg-card': '#ffffff', '--bg-sub': '#e0f2fe', '--bg-input': '#f0f9ff',
                    '--text-main': '#0f172a', '--text-muted': '#64748b', '--btn-solid': '#1e40af', '--btn-text': '#ffffff', '--border-color': '#bfdbfe'
                },
                violet: {
                    '--primary': '#8b5cf6', '--primary-dark': '#6d28d9', '--primary-light': '#f5f3ff', '--primary-rgb': '139, 92, 246',
                    '--bg-main': '#faf5ff', '--bg-card': '#ffffff', '--bg-sub': '#f3e8ff', '--bg-input': '#faf5ff',
                    '--text-main': '#2e1065', '--text-muted': '#a78bfa', '--btn-solid': '#5b21b6', '--btn-text': '#ffffff', '--border-color': '#e9d5ff'
                },
                rose: {
                    '--primary': '#e11d48', '--primary-dark': '#be123c', '--primary-light': '#fff1f2', '--primary-rgb': '225, 29, 72',
                    '--bg-main': '#fff1f2', '--bg-card': '#ffffff', '--bg-sub': '#ffe4e6', '--bg-input': '#fff1f2',
                    '--text-main': '#881337', '--text-muted': '#be123c', '--btn-solid': '#e11d48', '--btn-text': '#ffffff', '--border-color': '#fecdd3'
                }
            };
            const t = themes[theme] || themes.emerald;
            Object.keys(t).forEach(k => root.style.setProperty(k, t[k]));

            // PERSISTENCE: Save to LocalStorage for Login Screen access
            localStorage.setItem('fs_theme', theme);
        };

        // BOOT: Load saved theme immediately (for Login Screen)
        (function () {
            const saved = localStorage.getItem('fs_theme');
            if (saved) window.applyTheme(saved);
        })();

        // --- CORE APPLICATION FUNCTIONS ---

        async function checkDueDebts() {
            const today = new Date().toISOString().split('T')[0];
            let dueItem = null;
            let dueType = 'standard'; // or 'bnpl'
            let dueIdx = -1;
            let dataChanged = false;

            // Priority: Check Defaults first, then BNPL logic overrides or adds? 
            // Let's just find the *first* due item.
            for (const d of state.data.debts) {
                if (d.settled) continue;

                // --- AUTOMATION: Moved to checkSelfReminders ---

                // 1. BNPL Schedule Check
                if (d.subtype === 'bnpl' && d.schedule && d.schedule.length > 0) {
                    const pending = d.schedule.find(s => s.status === 'pending');
                    if (pending && new Date(pending.date).toISOString().split('T')[0] <= today) {
                        if (!dueItem) { // Only grab first for UI
                            dueItem = d;
                            dueType = 'bnpl';
                            dueIdx = pending.index;
                        }
                    }
                }
                // 2. Standard Debt Check
                else if (d.repaymentDate && d.repaymentDate <= today) {
                    if (!dueItem) { // Only grab first for UI
                        dueItem = d;
                        dueType = 'standard';
                    }
                }
            }

            if (dataChanged) await updateDb();

            if (dueItem) {
                const overlay = document.getElementById('reminder-overlay'), details = document.getElementById('reminder-details');
                if (overlay && details) {
                    let amount = dueItem.amount;
                    let party = dueItem.party;
                    let settleFn = () => window.openSettleFlow(dueItem.id);

                    if (dueType === 'bnpl') {
                        const inst = dueItem.schedule[dueIdx];
                        amount = inst.amount;
                        party = `${dueItem.party} (Inst #${inst.index + 1})`;
                        settleFn = () => window.settleInstallment(dueItem.id, dueIdx);
                    }

                    // SNOOZE CHECK: Check if snoozed in last 5 hours
                    const snoozed = localStorage.getItem('reminder_snooze');
                    // 5 hours = 5 * 60 * 60 * 1000 = 18000000 ms
                    if (snoozed && (Date.now() - parseInt(snoozed)) < 18000000) return;

                    details.innerHTML = `<p class="text-xl font-bold">${amount} ${dueItem.currency}</p><p class="text-sm font-medium text-slate-500">Party: ${party}</p>`;
                    document.getElementById('remit-settle-btn').onclick = settleFn;

                    // ACTION 1: Schedule Later (Reschedule)
                    document.getElementById('remit-resched-btn').onclick = () => window.openRescheduleFlow(dueItem.id);

                    // ACTION 2: Ignore (Snooze for 5h)
                    document.getElementById('remit-ignore-btn').onclick = () => {
                        localStorage.setItem('reminder_snooze', Date.now().toString());
                        overlay.classList.add('hidden');
                        window.showToast("Reminders snoozed for 5 hours", "info");
                    };

                    overlay.classList.replace('hidden', 'flex'); lucide.createIcons();
                }
            }
        }
        // --- CUSTOM MODAL HANDLERS ---
        window.showConfirm = function (title, msg, onYes, yesLabel = 'Yes, Delete', onCancel = null) {
            const m = document.getElementById('confirm-modal');
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-msg').innerHTML = msg;

            const yesBtn = document.getElementById('confirm-yes-btn');
            const cancelBtn = document.getElementById('confirm-cancel-btn');

            // 1. Setup YES Button
            const newYes = yesBtn.cloneNode(true);
            newYes.innerText = yesLabel;
            if (yesLabel !== 'Yes, Delete') {
                newYes.className = "p-3 bg-emerald-500 text-white rounded-xl font-bold hover:bg-emerald-600 transition-colors shadow-lg shadow-emerald-500/30";
            } else {
                newYes.className = "p-3 bg-red-500 text-white rounded-xl font-bold hover:bg-red-600 transition-colors shadow-lg shadow-red-500/30";
            }
            yesBtn.parentNode.replaceChild(newYes, yesBtn);
            newYes.onclick = () => { onYes(); m.classList.replace('flex', 'hidden'); };

            // 2. Setup CANCEL Button (New Logic to fix infinite loop)
            const newCancel = cancelBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(newCancel, cancelBtn); // Clear old listeners

            newCancel.onclick = () => {
                m.classList.replace('flex', 'hidden');
                if (onCancel) onCancel(); // Run callback if provided (e.g. reset loading state)
            };

            m.classList.replace('hidden', 'flex');
        };

        window.showPrompt = function (title, msg, onConfirm, type = 'text', allowEmpty = false) {
            const m = document.getElementById('prompt-modal');
            document.getElementById('prompt-title').innerText = title;
            document.getElementById('prompt-msg').innerText = msg;

            const inp = document.getElementById('prompt-input');
            inp.value = '';
            inp.type = type;

            const yesBtn = document.getElementById('prompt-yes-btn');
            const newBtn = yesBtn.cloneNode(true);
            yesBtn.parentNode.replaceChild(newBtn, yesBtn);

            newBtn.onclick = () => {
                if (inp.value.trim() || allowEmpty) {
                    m.classList.replace('flex', 'hidden'); // Hide first!
                    // Small delay to ensure clean state transition if needed, though usually synchronous is fine if hidden first
                    // But to be safe lets allow DOM to update
                    setTimeout(() => onConfirm(inp.value.trim()), 50);
                }
            };
            m.classList.replace('hidden', 'flex');
            inp.focus();
        };

        window.showToast = function (msg, type = 'info') {
            const c = document.getElementById('toast-container');
            const el = document.createElement('div');

            let icon = 'info', color = 'bg-slate-800', text = 'text-white';
            if (type === 'success') { icon = 'check-circle'; color = 'bg-emerald-500'; }
            if (type === 'error') { icon = 'alert-circle'; color = 'bg-red-500'; }
            if (type === 'warn') { icon = 'alert-triangle'; color = 'bg-amber-500'; }

            el.className = `flex items-center gap-3 p-4 rounded-xl shadow-xl transform transition-all duration-300 translate-y-10 opacity-0 ${color} ${text} min-w-[200px]`;
            el.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5"></i><span class="font-bold text-xs">${msg}</span>`;

            c.appendChild(el);
            lucide.createIcons();

            // Animate In
            requestAnimationFrame(() => el.classList.remove('translate-y-10', 'opacity-0'));

            // Remove after 3s
            setTimeout(() => {
                el.classList.add('translate-y-10', 'opacity-0');
                setTimeout(() => el.remove(), 300);
            }, 3000);
        };

        window.checkDueDebts = checkDueDebts;

        async function fetchExchangeRate() {
            try {
                const res = await fetch('https://api.exchangerate-api.com/v4/latest/AED');
                const d = await res.json();
                if (d.rates && d.rates.INR) {
                    state.data.settings.rate = d.rates.INR;
                    document.getElementById('exchange-rate-badge')?.classList.add('rate-live');
                }
            } catch (e) { console.warn("Live rate unavailable."); }
            // Always refresh asset values on generic refresh
            window.recalcDynamicAssets();
            window.renderApp();
        }
        window.fetchExchangeRate = fetchExchangeRate;

        // Recalculate balances for Commodities (Weight * Rate) and Funds (Units * NAV)
        window.recalcDynamicAssets = function () {
            state.data.accounts.forEach(a => {
                if (a.type === 'Commodity' && a.weight) {
                    const metal = Object.keys(state.data.commodityRates).find(k => a.name.includes(k)) || a.subtype || 'Gold';
                    const rateInINR = state.data.commodityRates[metal] || 0;
                    const valInINR = a.weight * rateInINR;

                    // Respect the account's currency setting
                    if (a.currency === 'AED') {
                        a.balance = window.toCurrency(valInINR / state.data.settings.rate);
                    } else {
                        a.balance = window.toCurrency(valInINR);
                        a.currency = 'INR';
                    }
                }
                if (a.type === 'Mutual Fund' && a.units && a.schemeCode && state.data.portfolio[a.schemeCode]) {
                    const nav = parseFloat(state.data.portfolio[a.schemeCode].nav);
                    a.balance = window.toCurrency(a.units * nav);
                    a.currency = 'INR'; // API is INR-only
                }
            });
        };

        window.refreshFund = async function (accId) {
            const acc = state.data.accounts.find(a => a.id === accId);
            if (!acc || !acc.schemeCode) return;
            try {
                const res = await fetch(`https://api.mfapi.in/mf/${acc.schemeCode}`);
                const json = await res.json();
                if (json.status === 'SUCCESS' && json.data && json.data.length > 0) {
                    const latest = json.data[0];
                    if (!state.data.portfolio) state.data.portfolio = {};
                    state.data.portfolio[acc.schemeCode] = {
                        nav: latest.nav,
                        date: latest.date,
                        name: json.meta.scheme_name
                    };
                    await updateDb();
                    window.recalcDynamicAssets();
                    window.renderApp();
                }
            } catch (e) { console.error("MF Fetch Error", e); }
        };

        function renderApp() {
            const dashboard = document.getElementById('app-content'); if (!dashboard || dashboard.style.display === 'none') return;

            // Helper for Number Formatting (Tabular)
            window.fmtMoney = (val, currency) => {
                const parts = val.toFixed(2).split('.');
                const intPart = new Intl.NumberFormat('en-US').format(parseInt(parts[0]));
                return `<span class="money-font tracking-tight">${currency === 'AED' ? 'AED' : '‚Çπ'} ${intPart}</span><span class="text-[0.6em] opacity-50 font-bold ml-0.5">.${parts[1]}</span>`;
            };

            window.renderAssetCard = (a, isChild = false) => {
                let subtext = a.type;
                let icon = 'layers'; // Default
                let iconColor = 'bg-slate-800 text-white'; // Default bg

                if (a.type === 'Commodity') {
                    subtext = `${a.weight}g ${a.subtype || ''}`;
                    if ((a.subtype || '').includes('Silver')) {
                        icon = 'coins';
                        iconColor = 'bg-slate-200 text-slate-600'; // Silver Style
                    } else {
                        icon = 'coins'; // Changed from 'gem' to 'coins' per user request
                        iconColor = 'bg-amber-100 text-amber-500'; // Gold Style (Yellow)
                    }
                }

                if (a.type === 'Mutual Fund') {
                    const meta = state.data.portfolio?.[a.schemeCode];
                    subtext = meta ? `NAV: ‚Çπ${meta.nav} (${meta.date})` : 'Click to Sync';
                    icon = 'pie-chart';
                    iconColor = 'bg-blue-100 text-blue-600';
                }

                if (a.type === 'Bank Account') {
                    icon = 'landmark';
                    iconColor = 'bg-emerald-100 text-emerald-600';
                }
                if (a.type === 'Cash') {
                    icon = 'wallet';
                    iconColor = 'bg-emerald-100 text-emerald-600';
                }
                if (a.type === 'Real Estate') {
                    icon = 'building';
                    iconColor = 'bg-indigo-100 text-indigo-600';
                    subtext = a.details?.location || a.category || 'Property';
                }
                if (a.type === 'Vehicle') {
                    icon = 'car';
                    iconColor = 'bg-red-100 text-red-600';
                    subtext = `${a.details?.make || ''} ${a.details?.model || ''}`.trim() || 'Vehicle';
                }
                if (a.type === 'Crypto') {
                    icon = 'zap';
                    iconColor = 'bg-purple-100 text-purple-600';
                    subtext = `${a.details?.sym || 'CRYPTO'} (${a.details?.net || 'Chain'})`;
                }
                if (a.type === 'Collectible') {
                    icon = 'watch';
                    iconColor = 'bg-pink-100 text-pink-600';
                    subtext = a.details?.brand || 'Collectible';
                }
                if (a.type === 'Bond') {
                    icon = 'file-text';
                    iconColor = 'bg-cyan-100 text-cyan-600';
                }

                const syncBtn = a.type === 'Mutual Fund' ? `<button onclick="event.stopPropagation(); window.refreshFund('${a.id}')" class="p-2 bg-slate-900 text-white rounded-full scale-75 hover:bg-emerald-500"><i data-lucide="refresh-cw" class="w-3 h-3"></i></button>` : '';

                return `<div class="bg-white p-4 rounded-2xl flex justify-between items-center border border-slate-100 shadow-sm cursor-pointer hover:bg-slate-50 transition-all text-center group ${isChild ? 'bg-slate-50 border-0 border-b last:border-0 border-slate-100 rounded-none' : ''}" onclick="window.viewAccountLedger('${a.id}')">
                    <div class="flex items-center space-x-3 text-left">
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center shadow-sm ${iconColor}">
                            <i data-lucide="${icon}" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <p class="font-bold text-slate-900 text-sm text-left gap-2 flex items-center">${a.name} ${syncBtn}</p>
                            <p class="text-[9px] text-slate-400 uppercase font-black text-left">${subtext}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-black text-slate-900 text-sm">${state.data.settings.isPrivate ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : window.fmtMoney(a.balance, a.currency)}</p>
                    </div>
                </div>`;
            };

            // FINANCIAL GRADE: Ledger-Based Truth
            // Derived Balances are calculated live from Transaction History before rendering
            window.recalculateBalances();

            const { accounts, transactions, debts, settings } = state.data;
            const r = settings.rate, priv = settings.isPrivate;
            const ut = (id, val) => { const el = document.getElementById(id); if (el) el.innerHTML = val; };

            if (document.getElementById('rate-display')) ut('rate-display', r.toFixed(2));

            let uae = 0, ind = 0, inv = 0;
            accounts.forEach(a => { if (a.currency === 'AED') uae += a.balance; else ind += a.balance; if (!['Bank Account', 'Cash'].includes(a.type)) inv += (a.currency === 'AED' ? a.balance * r : a.balance); });
            const pay = debts.filter(d => !d.settled && d.type === 'payable').reduce((s, d) => s + (Number(d.amount) * (d.currency === 'AED' ? r : 1)), 0), rec = debts.filter(d => !d.settled && d.type === 'receivable').reduce((s, d) => s + (Number(d.amount) * (d.currency === 'AED' ? r : 1)), 0);

            const net = (uae * r) + ind + rec - pay;
            const rawNetAED = net / r;

            const privText = `<span class="tracking-widest opacity-50">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>`;

            ut('total-primary', priv ? privText : window.fmtMoney(rawNetAED, 'AED'));
            ut('total-secondary', priv ? privText : `‚âà ` + window.fmtMoney(net, 'INR'));

            ut('uae-val', priv ? privText : window.fmtMoney(uae, 'AED'));
            ut('india-val', priv ? privText : window.fmtMoney(ind, 'INR'));
            ut('pay-val', (priv ? '' : '-') + window.fmtMoney(pay, 'INR'));
            ut('inv-val', priv ? privText : window.fmtMoney(inv, 'INR'));

            // Safe User Label Update
            const uLabel = document.getElementById('user-label');
            if (state.user && uLabel) uLabel.innerText = state.user.email.split('@')[0];

            window.renderAssetsList('uae', accounts.filter(a => a.currency === 'AED'));
            window.renderAssetsList('india', accounts.filter(a => a.currency === 'INR'));
            window.renderNotifications();
            window.renderInstallments();
            window.renderSmartInsights();
            // Render Wealth Landscape (Simulated/Calculated History)
            setTimeout(window.renderWealthLandscape, 100);
            lucide.createIcons();
        }
        window.renderApp = renderApp;

        window.renderWealthLandscape = function () {
            const ctx = document.getElementById('wealth-chart');
            if (!ctx) return;

            // 1. Calculate History (Reverse Engineering from Current Net Worth)
            // Current Net Worth (INR)
            const r = state.data.settings.rate;
            let currentNW = 0;
            state.data.accounts.forEach(a => {
                const bal = a.currency === 'AED' ? a.balance * r : a.balance;
                currentNW += bal;
            });
            // Adjust for liabilities
            state.data.debts.forEach(d => {
                if (!d.settled) {
                    const val = Number(d.amount) * (d.currency === 'AED' ? r : 1);
                    if (d.type === 'payable') currentNW -= val;
                    else currentNW += val;
                }
            });

            // Reconstruct last 30 days
            const history = [];
            const today = new Date();
            let tempNW = currentNW;

            // Group transactions by day
            const dailyTx = {};
            state.data.transactions.forEach(t => {
                const date = t.date.split('T')[0];
                const amt = parseFloat(t.amount);
                // We need the value in INR Approx for the trend
                // Note: This is an approximation since we don't track historical rates
                let val = amt;
                // Try to infer currency from account or transaction (simplified)
                // If it was an Expense, NW goes DOWN, so to go BACK in time, we ADD it.
                // If Income, NW goes UP, so going back, we SUBTRACT.
                // Logic: Past NW = Current NW - Income + Expense
                if (t.type === 'income') dailyTx[date] = (dailyTx[date] || 0) + val;
                else if (t.type === 'expense') dailyTx[date] = (dailyTx[date] || 0) - val;
                // Transfers don't change Net Worth (usually), ignoring gain/loss for simplicity
            });

            for (let i = 0; i < 30; i++) {
                const d = new Date();
                d.setDate(today.getDate() - i);
                const dateStr = d.toISOString().split('T')[0];
                history.push(tempNW);

                // Reverse adjustment for next iteration (going back in time)
                const change = dailyTx[dateStr] || 0;
                tempNW = tempNW - change; // if change was +100 (income), prev day was 100 less.
            }
            history.reverse(); // Now chronologically sorted

            if (window.wealthChartInstance) window.wealthChartInstance.destroy();
            window.wealthChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array(30).fill(''),
                    datasets: [{
                        data: history,
                        borderColor: '#10b981', // Emerald 500
                        backgroundColor: (context) => {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                            gradient.addColorStop(0, 'rgba(16, 185, 129, 0.5)');
                            gradient.addColorStop(1, 'rgba(16, 185, 129, 0.0)');
                            return gradient;
                        },
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    scales: {
                        x: { display: false },
                        y: { display: false, min: Math.min(...history) * 0.95 }
                    },
                    animation: { duration: 2000, easing: 'easeOutQuart' }
                }
            });
        };

        window.renderAnalytics = function () {
            // Existing Logic...
            // Calculate Financial Freedom
            const monthExp = state.data.transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0) / 6; // Avg last 6mo approx

            const currentNW = state.data.accounts.reduce((sum, a) => {
                const val = a.currency === 'AED' ? a.balance * state.data.settings.rate : a.balance;
                return sum + val;
            }, 0);

            const yearsFreedom = monthExp > 0 ? (currentNW / (monthExp * 12)).toFixed(1) : '‚àû';

            // HTML Structure
            const modal = document.getElementById('modal-content');
            modal.innerHTML = `
                <div class="space-y-8">
                    <!-- Freedom Gauge -->
                    <div class="bg-slate-900 text-white p-8 rounded-[3rem] text-center shadow-xl">
                        <p class="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-2">Financial Freedom</p>
                        <p class="text-5xl font-black text-emerald-400">${yearsFreedom} <span class="text-lg text-slate-500">Years</span></p>
                        <p class="text-[10px] font-bold text-slate-500 mt-2">Based on current lifestyle</p>
                    </div>

                    <!-- Asset Allocation Chart -->
                    <div class="bg-white p-6 rounded-[2.5rem] border shadow-sm text-center">
                        <h4 class="text-[10px] font-black uppercase text-slate-400 mb-4 tracking-widest">Asset Allocation</h4>
                        <div class="relative h-64 w-full">
                            <canvas id="allocation-chart"></canvas>
                        </div>
                    </div>

                    <!-- Expense Trend (Existing) -->
                    <div class="bg-white p-6 rounded-[2.5rem] border shadow-sm text-center">
                        <h4 class="text-[10px] font-black uppercase text-slate-400 mb-4 tracking-widest">Expense Trend (6 Mo)</h4>
                        <div class="relative h-48 w-full">
                            <canvas id="expense-trend-chart"></canvas>
                        </div>
                    </div>
                </div>`;

            // Render Charts
            setTimeout(() => {
                window.renderAllocationChart();
                window.renderExpenseTrend();
            }, 200);
        };

        window.renderAllocationChart = function () {
            const ctx = document.getElementById('allocation-chart');
            if (!ctx) return;

            // Aggregate Data by Category
            const breakdown = { 'Cash': 0, 'Equity': 0, 'Debt': 0, 'Gold': 0, 'Real Estate': 0, 'Other': 0 };
            const r = state.data.settings.rate;

            state.data.accounts.forEach(a => {
                const val = a.currency === 'AED' ? a.balance * r : a.balance;

                // Categorize
                if (a.type === 'Commodity') breakdown['Gold'] += val;
                else if (a.type === 'Mutual Fund') {
                    // Use category if available, else generic Equity
                    const cat = a.category || 'Equity';
                    // Simple map or fallback
                    if (cat.includes('Equity') || cat.includes('ELSS')) breakdown['Equity'] += val;
                    else if (cat.includes('Debt')) breakdown['Debt'] += val;
                    else if (cat.includes('Hybrid')) breakdown['Equity'] += val; // Simplify Hybrid as Equity for now
                    else breakdown['Equity'] += val;
                }
                else if (a.type === 'Bank Account' || a.type === 'Cash') breakdown['Cash'] += val;
                else breakdown['Other'] += val;
            });

            const labels = Object.keys(breakdown).filter(k => breakdown[k] > 0);
            const data = labels.map(k => breakdown[k]);
            const colors = ['#10b981', '#3b82f6', '#f59e0b', '#fcd34d', '#6366f1', '#64748b'];

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { font: { family: "'Plus Jakarta Sans'", size: 10, weight: 'bold' }, usePointStyle: true } }
                    },
                    cutout: '70%'
                }
            });
        };

        function renderNotifications() {
            const list = document.getElementById('upcoming-dues-list'), panel = document.getElementById('notification-panel');
            if (!list) return;

            const today = new Date();
            const limit = new Date();
            limit.setDate(today.getDate() + 2);

            // FIXED: Use Local Time for Date String to avoid UTC shifts
            const toStr = (d) => {
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${y}-${m}-${day}`;
            };
            const todayStr = toStr(today);
            const limitStr = toStr(limit);

            // Mix of standard debts and BNPL installments
            const items = [];

            state.data.debts.forEach(d => {
                if (d.settled) return;
                // FIXED: Filter out receivables (Money In) as per user request
                if (d.type === 'receivable') return;

                // 1. Installment Handling (BNPL, Loans, etc.)
                // REMOVED: Installments now live strictly in "Installment Due" section (User Request)
                if (d.schedule && d.schedule.length > 0) {
                    // Skip installments for Action Required
                }
                // 2. Standard handling
                else if (d.repaymentDate) {
                    if (d.repaymentDate <= limitStr) {
                        items.push({
                            id: d.id,
                            type: d.type,
                            party: d.party,
                            date: d.repaymentDate,
                            amount: d.amount,
                            currency: d.currency,
                            isBnpl: false
                        });
                    }
                }
            });

            const sorted = items.sort((a, b) => new Date(a.date) - new Date(b.date));

            if (sorted.length === 0) { panel.classList.add('hidden'); return; }
            panel.classList.remove('hidden');

            list.innerHTML = sorted.map(d => `
                <div class="bg-white p-4 rounded-2xl border-l-4 ${d.type === 'receivable' ? 'border-emerald-500' : 'border-amber-500'} shadow-sm flex flex-col justify-between text-center">
                    <div class="flex justify-between items-start mb-3 text-center">
                        <div class="text-left text-center">
                            <p class="text-[8px] font-black uppercase text-slate-400 mb-0.5">${d.type === 'receivable' ? 'Money In' : 'Money Out'}</p>
                            <p class="font-bold text-slate-800 text-sm text-center">${d.party}</p>
                            <p class="text-[9px] font-bold text-slate-400 uppercase text-center text-center">Due: ${d.date}</p>
                        </div>
                        <p class="font-black text-slate-900">${d.amount} ${d.currency}</p>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-center text-center">
                        <button onclick="${d.isBnpl ? `window.settleInstallment('${d.id}', ${d.instIndex})` : `window.openSettleFlow('${d.id}')`}" class="bg-emerald-500 text-white py-1.5 rounded-lg text-[9px] font-bold uppercase shadow-sm text-center text-center">Settle</button>
                        <button onclick="window.openRescheduleFlow('${d.id}')" class="bg-slate-50 text-slate-600 py-1.5 rounded-lg text-[9px] font-bold uppercase text-center text-center">Later</button>
                    </div>
                </div>`).join('');
        }
        window.renderNotifications = renderNotifications;

        window.renderInstallments = function () {
            const list = document.getElementById('installments-list'), panel = document.getElementById('installments-panel');
            if (!list) return;

            const today = new Date();
            const limit = new Date();
            limit.setDate(today.getDate() + 2);

            // FIXED: Use Local Time
            const toStr = (d) => {
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${y}-${m}-${day}`;
            };
            const limitStr = toStr(limit);

            const items = [];

            state.data.debts.forEach(d => {
                // Filter: Must check schedule existence (generalized for Loans/BNPL)
                if (d.settled || !d.schedule || d.schedule.length === 0) return;
                // FIXED: Filter out receivables
                if (d.type === 'receivable') return;

                // FIXED: Handle empty status and missing index for legacy data
                const pendingIdx = d.schedule.findIndex(s => s.status === 'pending' || !s.status);

                if (pendingIdx !== -1) {
                    const pending = d.schedule[pendingIdx];
                    // CHANGED: Restricted to Urgent Only (<= 2 Days) per User Request
                    if (pending.date <= limitStr) {
                        items.push({
                            id: d.id,
                            party: d.party, // e.g. "iPhone 15"
                            date: pending.date,
                            amount: pending.amount,
                            currency: d.currency,
                            instIndex: pendingIdx, // Use calculated index
                            totalInst: d.schedule.length
                        });
                    }
                }
            });

            const sorted = items.sort((a, b) => new Date(a.date) - new Date(b.date));

            // CHANGED: Revert debug message - Hide if empty
            if (sorted.length === 0) {
                panel.classList.add('hidden');
                return;
            }
            panel.classList.remove('hidden');
            // panel.style.border = ""; // Clean up styles if any persisted (not needed with class manipulation but safe)

            list.innerHTML = sorted.map(d => `
                <div class="bg-white p-4 rounded-2xl border-l-4 border-indigo-500 shadow-sm flex flex-col justify-between text-center">
                    <div class="flex justify-between items-start mb-3 text-center">
                        <div class="text-left text-center">
                            <p class="text-[8px] font-black uppercase text-indigo-400 mb-0.5">Installment ${d.instIndex + 1}/${d.totalInst}</p>
                            <p class="font-bold text-slate-800 text-sm text-center">${d.party}</p>
                            <p class="text-[9px] font-bold text-slate-400 uppercase text-center text-center">Due: ${d.date}</p>
                        </div>
                        <p class="font-black text-slate-900">${d.amount} ${d.currency}</p>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-center text-center">
                        <button onclick="window.settleInstallment('${d.id}', ${d.instIndex})" class="bg-indigo-500 text-white py-1.5 rounded-lg text-[9px] font-bold uppercase shadow-sm text-center text-center">Pay Now</button>
                        <button onclick="window.openRescheduleFlow('${d.id}')" class="bg-slate-50 text-slate-600 py-1.5 rounded-lg text-[9px] font-bold uppercase text-center text-center">Later</button>
                    </div>
                </div>`).join('');
        };

        window.toggleGroup = function (id) {
            // Deprecated
        };

        window.openGroupDetails = function (type, subtype, currency) {
            const items = state.data.accounts.filter(a => {
                if (a.currency !== currency) return false;
                if (type === 'Commodity') return a.type === 'Commodity' && (a.subtype || 'Commodity') === subtype;
                if (type === 'Mutual Fund') return a.type === 'Mutual Fund' && (a.category || 'Mutual Funds') === subtype;
                return false;
            });

            if (items.length === 0) return;

            const t = document.getElementById('modal-title');
            const c = document.getElementById('modal-content');
            const b = document.getElementById('modal-backdrop');

            // 1. Calculate Stats
            const totalVal = items.reduce((s, a) => s + a.balance, 0);
            let statHtml = '';

            if (type === 'Commodity') {
                const totalWeight = items.reduce((s, a) => s + (a.weight || 0), 0);
                statHtml = `<div class="bg-amber-50 p-6 rounded-3xl border border-amber-100 text-center">
                    <p class="text-[10px] font-black uppercase text-amber-500 tracking-widest mb-1">Total Weight</p>
                    <p class="text-3xl font-black text-slate-800">${totalWeight.toFixed(2)}g</p>
                </div>`;
            } else if (type === 'Mutual Fund') {
                statHtml = `<div class="bg-blue-50 p-6 rounded-3xl border border-blue-100 text-center">
                    <p class="text-[10px] font-black uppercase text-blue-500 tracking-widest mb-1">Portfolios</p>
                    <p class="text-3xl font-black text-slate-800">${items.length} <span class="text-xs text-slate-400">Funds</span></p>
                </div>`;
            }

            t.innerText = `${subtype} (${currency})`;
            c.innerHTML = `
                <div class="space-y-6">
                    <!-- Dashboard Header -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-emerald-50 p-6 rounded-3xl border border-emerald-100 text-center">
                            <p class="text-[10px] font-black uppercase text-emerald-600 tracking-widest mb-1">Total Value</p>
                            <p class="text-3xl font-black text-emerald-600">${window.fmtMoney(totalVal, currency)}</p>
                        </div>
                        ${statHtml}
                    </div>

                    <!-- Distribution Chart -->
                    <div class="bg-white p-6 rounded-[2.5rem] border shadow-sm text-center">
                        <h4 class="text-[10px] font-black uppercase text-slate-400 mb-4 tracking-widest">Distribution</h4>
                        <div class="relative h-48 w-full">
                            <canvas id="group-chart"></canvas>
                        </div>
                    </div>

                    <!-- Item List -->
                    <div class="grid gap-2">
                        <h4 class="text-[10px] font-black uppercase text-slate-400 mt-4 mb-2 tracking-widest text-left px-2">Holdings List</h4>
                        ${items.map(a => window.renderAssetCard(a)).join('')}
                    </div>
                </div>
            `;
            b.classList.replace('hidden', 'flex');
            lucide.createIcons();

            // Render Chart
            setTimeout(() => {
                const ctx = document.getElementById('group-chart');
                if (ctx) {
                    const labels = items.map(a => a.name);
                    const data = items.map(a => a.balance);
                    const colors = ['#10b981', '#3b82f6', '#f59e0b', '#ec4899', '#6366f1', '#8b5cf6', '#14b8a6'];

                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: colors,
                                borderWidth: 0,
                                hoverOffset: 10
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } }, // Clean look
                            cutout: '60%'
                        }
                    });
                }
            }, 100);
        };

        function renderAssetsList(reg, items) {
            const container = document.getElementById(`${reg}-list`); if (!container) return;
            if (items.length === 0) { container.innerHTML = `<div class="p-8 border border-dashed border-slate-100 rounded-[2rem] text-center text-slate-300 uppercase text-[10px] font-black">No accounts</div>`; return; }

            // 1. Grouping Logic
            const groups = {};
            const singles = [];

            items.forEach(a => {
                if (a.type === 'Commodity') {
                    const key = `${a.subtype || 'Commodity'}-${a.currency}`;
                    if (!groups[key]) groups[key] = { type: 'Commodity', subtype: a.subtype || 'Commodity', currency: a.currency, items: [], totalBal: 0, totalWeight: 0 };
                    groups[key].items.push(a);
                    groups[key].totalBal += a.balance;
                    groups[key].totalWeight += (a.weight || 0);
                } else if (a.type === 'Mutual Fund') {
                    const key = `${a.category || 'Mutual Funds'}-${a.currency}`;
                    if (!groups[key]) groups[key] = { type: 'Mutual Fund', subtype: a.category || 'Mutual Funds', currency: a.currency, items: [], totalBal: 0 };
                    groups[key].items.push(a);
                    groups[key].totalBal += a.balance;
                } else {
                    singles.push(a);
                }
            });

            // 2. Render Groups (Click -> Open Detail Modal)
            const groupHTML = Object.values(groups).map(g => {
                if (g.items.length === 1) return window.renderAssetCard(g.items[0]);

                const subLabel = g.type === 'Commodity' ? `${g.totalWeight.toFixed(2)}g Total` : `${g.items.length} Holdings`;

                // Dynamic Group Icon
                let gIcon = 'folder';
                let gColor = 'bg-slate-800 text-white';

                if (g.type === 'Commodity') {
                    gIcon = 'coins';
                    if ((g.subtype || '').includes('Silver')) {
                        gColor = 'bg-slate-200 text-slate-600';
                    } else {
                        gColor = 'bg-amber-100 text-amber-500';
                    }
                } else if (g.type === 'Mutual Fund') {
                    gIcon = 'pie-chart';
                    gColor = 'bg-blue-100 text-blue-600';
                }

                return `
                    <div onclick="window.openGroupDetails('${g.type}', '${g.subtype}', '${g.currency}')" class="bg-slate-50 p-4 rounded-2xl flex justify-between items-center border border-slate-200 shadow-sm cursor-pointer hover:bg-slate-100 transition-all mb-2">
                        <div class="flex items-center space-x-3 text-left">
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center shadow-sm ${gColor}">
                                <i data-lucide="${gIcon}" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <p class="font-bold text-slate-900 text-sm flex items-center gap-2">
                                    ${g.subtype}
                                    <i data-lucide="chevron-right" class="w-3 h-3 text-slate-400"></i>
                                </p>
                                <p class="text-[8px] text-slate-500 uppercase font-black">${subLabel}</p>
                            </div>
                        </div>
                        <div class="text-right">
                             <p class="font-black text-slate-900 text-sm font-sans tracking-tight">${state.data.settings.isPrivate ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : window.toCurrency(g.totalBal)}</p>
                            <span class="text-[8px] font-black text-slate-400 uppercase">Aggregated</span>
                        </div>
                    </div>
                `;
            }).join('');

            // 3. Render Singles
            const singleHTML = singles.map(a => window.renderAssetCard(a)).join('');

            container.innerHTML = groupHTML + singleHTML;
        }
        window.renderAssetsList = renderAssetsList;

        function renderLedger(items) {
            const body = document.getElementById('master-ledger-body'); if (!body) return;
            const sorted = [...items].sort((a, b) => new Date(b.date) - new Date(a.date));
            body.innerHTML = sorted.map(t => {
                let accName = 'N/A';
                if (t.accountId === 'virtual_writeoff') {
                    accName = 'Write-off Record';
                } else {
                    accName = state.data.accounts.find(a => a.id === t.accountId)?.name || 'N/A';
                }
                const isTransfer = t.type.includes('transfer');
                const isIncome = t.type === 'income' || t.type === 'transfer_in';
                const colorClass = isTransfer ? 'text-slate-500' : (isIncome ? 'text-emerald-500' : 'text-red-400');
                const sign = isIncome ? '+' : '-';
                const displayType = isTransfer ? (t.type === 'transfer_in' ? 'Inflow' : 'Outflow') : (t.type === 'income' ? 'Income' : 'Expense');

                return `<tr class="hover:bg-slate-50 text-center group">
                    <td class="px-6 py-4 text-left">
                        <p class="text-xs font-bold text-slate-800">${new Date(t.date).toLocaleDateString()}</p>
                        <p class="text-[9px] font-black text-slate-400 uppercase">${new Date(t.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>
                    </td>
                    <td class="px-6 py-4 text-left">
                        <p class="text-xs font-bold text-slate-800">${t.category || displayType}</p>
                        <p class="text-[10px] text-slate-400 font-medium truncate max-w-[120px]">${t.note || '-'}</p>
                        ${t.tags && t.tags.length > 0 ? `<div class="flex space-x-1 mt-1">${t.tags.map(tg => `<span class="px-1.5 py-0.5 bg-emerald-50 text-emerald-600 text-[8px] font-bold rounded-md">${tg}</span>`).join('')}</div>` : ''}
                    </td>
                    <td class="px-6 py-4 text-center">
                        <span class="text-[9px] font-black uppercase px-2 py-0.5 bg-slate-100 text-slate-500 rounded-full">${accName}</span>
                    </td>
                    <td class="px-6 py-4 text-right font-black ${colorClass} num-font">
                        ${sign}${state.data.settings.isPrivate ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : Number(t.amount).toFixed(2)}
                    </td>
                    <td class="px-6 py-4 text-center">
                        <div class="flex items-center justify-center space-x-2">
                            <button onclick="window.cloneTransaction('${t.id}')" class="p-1.5 bg-slate-100 rounded-lg text-slate-600 hover:text-blue-600 hover:bg-blue-50" title="Clone Entry">
                                <i data-lucide="copy" class="w-3 h-3"></i>
                            </button>
                            <button onclick="window.editTransaction('${t.id}')" class="p-1.5 bg-slate-100 rounded-lg text-slate-600 hover:text-emerald-600 hover:bg-emerald-50" title="Edit Entry">
                                <i data-lucide="pencil" class="w-3 h-3"></i>
                            </button>
                            <button onclick="event.stopPropagation(); window.deleteTransaction('${t.id}')" class="p-1.5 bg-slate-100 rounded-lg text-slate-600 hover:text-red-600 hover:bg-red-50" title="Delete Entry">
                                <i data-lucide="trash-2" class="w-3 h-3"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }
        window.renderLedger = renderLedger;

        window.filterLedger = function () {
            const q = document.getElementById('ledger-search').value.toLowerCase();
            const filter = window.activeLedgerFilter || 'all';
            const all = state.data.transactions;

            const filtered = all.filter(t => {
                // 1. Check Search Query
                const matchesSearch = !q || (
                    (t.note && t.note.toLowerCase().includes(q)) ||
                    (t.category && t.category.toLowerCase().includes(q)) ||
                    (t.tags && t.tags.some(tag => tag.toLowerCase().includes(q))) ||
                    (t.amount.toString().includes(q))
                );

                // 2. Check Filter Chip
                let matchesFilter = true;
                if (filter === 'income') {
                    // Exclude non-income inflows
                    const isExcluded = ['Settlement', 'Loan', 'Debt', 'Opening Balance', 'Initial', 'Credit'].some(k =>
                        (t.category && t.category.includes(k)) || (t.note && t.note.includes(k))
                    );
                    matchesFilter = (t.type === 'income' || t.type === 'transfer_in') && !isExcluded;
                }
                else if (filter === 'expense') matchesFilter = (t.type === 'expense' || t.type === 'transfer_out');
                else if (filter === 'transfer') matchesFilter = t.type.includes('transfer');
                else if (filter === 'high') matchesFilter = parseFloat(t.amount) > 5000;

                // 3. Check Date Range Filter
                const dFrom = document.getElementById('ledger-date-from')?.value;
                const dTo = document.getElementById('ledger-date-to')?.value;

                let matchesDate = true;
                if (dFrom) matchesDate = matchesDate && (new Date(t.date) >= new Date(dFrom));
                if (dTo) {
                    // Adjust to end of day for intuitive filtering
                    const endDate = new Date(dTo);
                    endDate.setHours(23, 59, 59, 999);
                    matchesDate = matchesDate && (new Date(t.date) <= endDate);
                }

                return matchesSearch && matchesFilter && matchesDate;
            });
            window.renderLedger(filtered);
        };

        window.renderImportUI = function () {
            return `<div class="max-w-2xl mx-auto bg-white p-10 rounded-[3rem] border shadow-xl text-center">
                <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-6">Bulk Import (CSV)</h4>
                
                <div class="mb-6 text-left">
                    <p class="text-[10px] text-slate-500 font-bold mb-2">Instructions:</p>
                    <ul class="text-[10px] text-slate-400 list-disc list-inside mb-4">
                        <li>Paste your statement below.</li>
                        <li>Format: <strong>Date, Description, Amount</strong> (e.g. 2024-02-01, Netflix, -50)</li>
                        <li>Positive for Income, Negative for Expense</li>
                    </ul>
                    <textarea id="csv-input" class="w-full h-40 p-4 border rounded-2xl bg-slate-50 text-xs font-mono outline-none focus:border-emerald-500" placeholder="2024-02-01, Salary, 5000\n2024-02-02, Grocery, -200"></textarea>
                </div>
                
                <select id="csv-acc" class="w-full p-4 border rounded-xl font-bold text-sm mb-4 bg-white">
                    ${state.data.accounts.map(a => `<option value="${a.id}">${a.name} (${a.currency})</option>`).join('')}
                </select>

                <div id="csv-preview" class="hidden mb-6 max-h-40 overflow-auto border rounded-xl"></div>

                <div class="grid grid-cols-2 gap-4">
                    <button onclick="window.parseCSV()" class="bg-slate-100 text-slate-600 p-4 rounded-xl font-black uppercase text-[10px]">Parse Data</button>
                    <button onclick="window.bulkImport()" id="btn-import" class="bg-slate-900 text-white p-4 rounded-xl font-black uppercase text-[10px] opacity-50 cursor-not-allowed">Run Import</button>
                </div>
            </div>`;
        };

        window.parsedRows = [];

        window.parseCSV = function () {
            const raw = document.getElementById('csv-input').value;
            const rows = raw.split(/\r?\n/).filter(r => r.trim() !== '');
            window.parsedRows = [];

            rows.forEach(r => {
                const parts = r.split(',').map(p => p.trim());
                if (parts.length >= 3) {
                    // Try to simplistic parse
                    const date = parts[0];
                    const desc = parts[1];
                    const amt = parseFloat(parts[2]);

                    if (!isNaN(amt)) {
                        window.parsedRows.push({ date, desc, amt });
                    }
                }
            });

            if (window.parsedRows.length > 0) {
                const prev = document.getElementById('csv-preview');
                prev.innerHTML = `<table class="w-full text-center text-[9px]"><thead class="bg-slate-100 font-bold"><tr><th class="p-2">Date</th><th class="p-2">Desc</th><th class="p-2">Amt</th></tr></thead>
                <tbody>${window.parsedRows.map(r => `<tr><td class="p-2 border-b">${r.date}</td><td class="p-2 border-b">${r.desc}</td><td class="p-2 border-b font-bold ${r.amt > 0 ? 'text-emerald-500' : 'text-red-500'}">${r.amt}</td></tr>`).join('')}</tbody></table>`;
                prev.classList.remove('hidden');
                document.getElementById('btn-import').classList.remove('opacity-50', 'cursor-not-allowed');
                alert(`‚úÖ Parsed ${window.parsedRows.length} rows! Review and click Import.`);
            } else {
                alert("Could not parse rows. Ensure format: YYYY-MM-DD, Description, Amount (Use minus for expense)");
            }
        };

        window.bulkImport = async function () {
            if (window.parsedRows.length === 0) return;
            const aid = document.getElementById('csv-acc').value;
            if (!aid) return;

            if (!confirm(`Import ${window.parsedRows.length} transactions to selected account?`)) return;

            window.setBtnLoading('btn-import', true);
            const accIdx = state.data.accounts.findIndex(a => a.id === aid);
            let balChange = 0;

            window.parsedRows.forEach(r => {
                const type = r.amt >= 0 ? 'income' : 'expense';
                balChange += r.amt;

                state.data.transactions.push({
                    id: window.genId(),
                    accountId: aid,
                    amount: Math.abs(r.amt), // Store absolute
                    type: type,
                    category: 'Imported',
                    note: r.desc,
                    date: new Date(r.date).toISOString() || new Date().toISOString()
                });
            });

            // Update Balance
            state.data.accounts[accIdx].balance += balChange; // Simple add, floating point risk acceptable for V1 MVP

            await updateDb();
            window.closeModal();
            window.renderApp();
            alert("Success! Transactions Imported.");
        };

        // --- NEW FUNCTIONS (Moved to bottom) ---

        // --- MODAL VIEWS ---

        window.openModal = function (type) {
            const b = document.getElementById('modal-backdrop'), t = document.getElementById('modal-title'), c = document.getElementById('modal-content');
            b.classList.replace('hidden', 'flex');
            switch (type) {
                // FIXED: Sign Out button now uses window.handleSignOut()
                case 'auth': t.innerText = 'System Profile'; c.innerHTML = `
                <div class="space-y-8 py-10 text-center">
                    <div class="fs-logo-modern w-24 h-24 mb-6 relative group mx-auto">
                        <div class="absolute inset-0 bg-emerald-500/20 rounded-xl blur-xl group-hover:bg-emerald-500/30 transition-all duration-500"></div>
                        <div class="relative h-full w-full bg-slate-900 border border-emerald-500/30 rounded-xl flex items-center justify-center overflow-hidden shadow-2xl">
                            <div class="absolute inset-0 bg-gradient-to-tr from-emerald-500/10 via-transparent to-transparent"></div>
                            <div class="absolute inset-0 w-full h-[200%] bg-gradient-to-b from-transparent via-white/5 to-transparent -translate-y-[150%] animate-[modernScan_4s_infinite_ease-in-out]"></div>
                            <div class="relative z-10 text-center">
                                <span class="block text-4xl font-black text-white tracking-tighter drop-shadow-[0_2px_4px_rgba(0,0,0,0.8)]">FS</span>
                                <span class="block text-[8px] font-bold text-emerald-400 tracking-[0.3em] uppercase mt-1">Finance</span>
                            </div>
                        </div>
                    </div>
                    <p class="font-black text-xl text-slate-800 text-center">${state.user.email}</p>
                    
                    <div class="grid grid-cols-2 gap-4 max-w-sm mx-auto">
                        <button onclick="window.openModal('remittance')" class="p-4 bg-slate-50 rounded-2xl text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 font-bold text-xs uppercase transition-all">
                            <i data-lucide="arrow-left-right" class="w-6 h-6 mx-auto mb-2"></i> Remittance
                        </button>
                         <button onclick="window.openModal('zakat')" class="p-4 bg-slate-50 rounded-2xl text-slate-600 hover:bg-emerald-50 hover:text-emerald-600 font-bold text-xs uppercase transition-all">
                            <i data-lucide="heart-handshake" class="w-6 h-6 mx-auto mb-2"></i> Zakat Calc
                        </button>
                    </div>
                    <div class="max-w-sm mx-auto mt-4">
                        <button onclick="window.openModal('change-password')" class="w-full p-4 bg-slate-50 rounded-2xl text-slate-600 hover:bg-amber-50 hover:text-amber-600 font-bold text-xs uppercase transition-all">
                            <i data-lucide="shield-check" class="w-6 h-6 mx-auto mb-2"></i> Change Password
                        </button>
                    </div>

                    <button onclick="window.handleSignOut()" class="w-full max-w-sm mx-auto bg-slate-900 text-white p-5 rounded-3xl font-black uppercase text-sm text-center">Sign Out</button>
                </div>`; break;
                case 'change-password':
                    t.innerText = 'Security Settings';
                    c.innerHTML = `
                        <div class="max-w-sm mx-auto bg-slate-50 p-8 rounded-[2.5rem] border text-center">
                            <i data-lucide="lock" class="w-12 h-12 text-amber-500 mx-auto mb-4"></i>
                            <div class="space-y-4 text-left">
                                <div>
                                    <label class="text-[9px] font-bold text-slate-400 uppercase tracking-widest pl-1">Current Password</label>
                                    <input type="password" id="cp-old" placeholder="Verify Identity" class="w-full p-4 border rounded-xl font-bold bg-white outline-none focus:ring-2 focus:ring-amber-500 text-center">
                                </div>
                                <div>
                                    <label class="text-[9px] font-bold text-slate-400 uppercase tracking-widest pl-1">New Password</label>
                                    <input type="password" id="cp-new" placeholder="Min 6 chars" class="w-full p-4 border rounded-xl font-bold bg-white outline-none focus:ring-2 focus:ring-amber-500 text-center">
                                </div>
                                <div>
                                    <label class="text-[9px] font-bold text-slate-400 uppercase tracking-widest pl-1">Confirm New</label>
                                    <input type="password" id="cp-cnf" placeholder="Repeat New" class="w-full p-4 border rounded-xl font-bold bg-white outline-none focus:ring-2 focus:ring-amber-500 text-center">
                                </div>
                            </div>
                            <button onclick="window.handleChangePassword()" class="w-full bg-amber-500 text-white p-4 rounded-2xl font-black uppercase text-xs shadow-lg hover:bg-amber-600 transition-all mt-6">Update Credentials</button>
                        </div>
                    `; break;
                case 'accounts':
                    t.innerText = 'Asset Registration';
                    c.innerHTML = `
                        <div class="max-w-md mx-auto bg-slate-50 p-10 rounded-[3rem] border text-center">
                            <input type="text" id="an" placeholder="Identifier (e.g. HDFC Gold Fund)" class="w-full p-4 border rounded-xl font-bold mb-4 outline-none focus:border-emerald-500">
                            
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <select id="ac" onchange="document.getElementById('cost-currency').innerText = this.value" class="p-4 border rounded-xl font-bold text-center">
                                    <option value="AED">AED</option>
                                    <option value="INR">INR</option>
                                </select>
                                <select id="at" onchange="window.toggleAssetFields()" class="p-4 border rounded-xl font-bold text-center">
                                    ${state.data.assetTypes.map(ty => `<option value="${ty}">${ty}</option>`).join('')}
                                </select>
                            </div>

                            <div id="inv-type-container" class="hidden mb-4">
                                <p class="text-[9px] font-bold text-slate-400 mb-1 uppercase">Investment Type</p>
                                <select id="inv-type" onchange="window.toggleAssetFields()" class="w-full p-4 border rounded-xl font-bold text-center bg-slate-50 text-slate-700">
                                    <option value="General">General / Stock</option>
                                    <option value="Commodity">Commodity (Gold, Silver...)</option>
                                    <option value="Mutual Fund">Mutual Fund</option>
                                    <option value="Crypto">Crypto</option>
                                    <option value="Bond">Bond / Deposit</option>
                                </select>
                            </div>

                            <!-- Dynamic Inputs -->
                            <div id="dynamic-inputs" class="space-y-4 mb-6">
                                <!-- Default: Balance -->
                                <div id="inp-balance">
                                    <label class="text-[9px] font-bold text-slate-400 uppercase tracking-widest pl-1">Current Balance</label>
                                    <input type="number" id="ab" class="w-full p-4 border rounded-xl font-bold bg-slate-50 outline-none focus:ring-2 focus:ring-emerald-500 text-slate-900 font-mono" placeholder="0.00">
                                </div>
                                <div id="inp-balance-note" class="hidden text-[10px] text-slate-400 font-bold text-center mt-1">Enter current available cash in bank/wallet</div>

                                <!-- Commodity -->
                                <div id="inp-commodity" class="hidden space-y-4">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="text-[9px] font-bold text-slate-400 uppercase tracking-widest pl-1">Weight (Grams)</label>
                                            <input type="number" id="aw" class="w-full p-4 border rounded-xl font-bold bg-slate-50 outline-none focus:ring-2 focus:ring-emerald-500 text-slate-900" placeholder="0.00">
                                        </div>
                                        <div>
                                            <label class="text-[9px] font-bold text-slate-400 uppercase tracking-widest pl-1">Type</label>
                                            <select id="commodity-type" class="w-full p-4 border rounded-xl font-bold bg-slate-50 text-xs">
                                                <option value="Gold">Gold</option>
                                                <option value="Silver">Silver</option>
                                                <option value="Platinum">Platinum</option>
                                                <option value="Palladium">Palladium</option>
                                                <option value="Oil">Oil</option>
                                                <option value="Diamond">Diamond</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-[9px] font-bold text-slate-400 uppercase tracking-widest pl-1">Original Cost (<span id="cost-currency">AED</span>)</label>
                                        <input type="number" id="original-cost" class="w-full p-4 border rounded-xl font-bold bg-slate-50 outline-none focus:ring-2 focus:ring-emerald-500 text-slate-900" placeholder="Total amount invested (e.g. 750)">
                                    </div>
                                </div>

                                <!-- Mutual Fund -->
                                <div id="inp-fund" class="hidden space-y-4">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="text-[9px] font-bold text-slate-400 uppercase tracking-widest pl-1">Scheme Code</label>
                                            <input type="text" id="asc" class="w-full p-4 border rounded-xl font-bold bg-slate-50 outline-none focus:ring-2 focus:ring-emerald-500 text-slate-900 font-mono" placeholder="123456">
                                        </div>
                                        <div>
                                            <label class="text-[9px] font-bold text-slate-400 uppercase tracking-widest pl-1">Units (Nav)</label>
                                            <input type="number" id="au" class="w-full p-4 border rounded-xl font-bold bg-slate-50 outline-none focus:ring-2 focus:ring-emerald-500 text-slate-900" placeholder="0.00">
                                        </div>
                                    </div>
                                    <input type="text" id="mf-cat" class="w-full p-4 border rounded-xl font-bold bg-slate-50 text-xs" placeholder="Category (e.g. Small Cap)">
                                </div>

                                <!-- Real Estate -->
                                <div id="inp-re" class="hidden space-y-4">
                                    <input type="text" id="re-loc" class="w-full p-4 border rounded-xl font-bold bg-slate-50 outline-none focus:ring-2 focus:ring-emerald-500 text-slate-900 text-xs" placeholder="Location (e.g. Dubai Marina)">
                                    <div class="grid grid-cols-2 gap-4">
                                        <select id="re-type" class="w-full p-4 border rounded-xl font-bold bg-slate-50 text-xs">
                                            <option value="Residential">Residential</option>
                                            <option value="Commercial">Commercial</option>
                                            <option value="Land">Land</option>
                                        </select>
                                        <input type="text" id="re-area" class="w-full p-4 border rounded-xl font-bold bg-slate-50 outline-none text-slate-900 text-xs" placeholder="Area (sqft)">
                                    </div>
                                </div>

                                <!-- Crypto -->
                                <div id="inp-crypto" class="hidden grid grid-cols-2 gap-4">
                                    <input type="text" id="cry-sym" class="w-full p-4 border rounded-xl font-bold bg-slate-50 text-xs uppercase" placeholder="Symbol (BTC)">
                                    <input type="text" id="cry-net" class="w-full p-4 border rounded-xl font-bold bg-slate-50 text-xs" placeholder="Network (ERC20)">
                                </div>

                                <!-- Bond/Deposit -->
                                <div id="inp-bond" class="hidden grid grid-cols-2 gap-4">
                                    <input type="date" id="bond-date" class="w-full p-4 border rounded-xl font-bold bg-slate-50 text-xs" title="Maturity Date">
                                    <input type="number" id="bond-rate" class="w-full p-4 border rounded-xl font-bold bg-slate-50 text-xs" placeholder="Rate %">
                                </div>
                            </div>
                            <button id="btn-save-acc" onclick="window.saveAccount()" class="w-full bg-emerald-500 text-white p-5 rounded-3xl font-black uppercase text-sm shadow-xl hover:bg-emerald-600 transition-all">Save Account</button>
                        </div>`; break;

                case 'sinking-add':
                    t.innerText = 'New Sinking Fund';
                    c.innerHTML = `
                        <div class="max-w-sm mx-auto bg-slate-50 p-8 rounded-[2.5rem] border text-center">
                            <i data-lucide="piggy-bank" class="w-12 h-12 text-indigo-500 mx-auto mb-4"></i>
                            <div class="space-y-4">
                                <input type="text" id="sf-name" placeholder="Fund Name (e.g. Annual Insurance)" class="w-full p-4 border rounded-xl font-bold bg-white outline-none focus:ring-2 focus:ring-indigo-500">
                                <select id="sf-currency" class="w-full p-4 border rounded-xl font-bold bg-white outline-none focus:ring-2 focus:ring-indigo-500">
                                    <option value="AED">AED</option>
                                    <option value="INR">INR</option>
                                </select>
                                <input type="number" id="sf-target" placeholder="Target Amount" class="w-full p-4 border rounded-xl font-bold bg-white outline-none focus:ring-2 focus:ring-indigo-500">
                                <label class="block text-left text-[10px] font-black uppercase text-slate-400 tracking-widest pl-1">Target Date</label>
                                <input type="date" id="sf-date" class="w-full p-4 border rounded-xl font-bold bg-white outline-none focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <button onclick="window.saveSinkingFund()" class="w-full bg-indigo-600 text-white p-4 rounded-2xl font-black uppercase text-xs shadow-lg hover:bg-indigo-700 transition-all mt-6">Add Sinking Fund</button>
                        </div>
                    `; break;
                case 'transaction': t.innerText = 'Data Movement'; c.innerHTML = `
                    <div class="max-w-md mx-auto bg-white p-10 rounded-[3rem] border shadow-xl text-center">
                        <div class="grid grid-cols-2 gap-4 mb-6 text-center">
                            <button id="be" onclick="window.setT('expense')" class="p-4 rounded-xl border-4 border-emerald-500 bg-emerald-50 text-emerald-700 font-black text-xs uppercase">Expense</button>
                            <button id="bi" onclick="window.setT('income')" class="p-4 rounded-xl border-4 border-slate-100 text-slate-300 font-black text-xs uppercase">Income</button>
                        </div>
                        <input type="hidden" id="tt" value="expense">
                        <select id="ta" class="w-full p-4 border rounded-xl font-bold mb-4 text-center">${state.data.accounts.map(a => `<option value="${a.id}">${a.name} (${a.currency})</option>`).join('')}</select>
                        <div class="grid grid-cols-2 gap-4 mb-4 text-center">
                            <select id="tc" class="p-4 border rounded-xl font-bold text-sm text-center">${state.data.expenseCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}</select>
                            <input type="number" id="tam" placeholder="0.00" class="p-4 border rounded-xl font-black text-center focus:border-emerald-500">
                        </div>
                        <input type="text" id="tn" placeholder="Note" class="w-full p-4 border rounded-xl mb-4 outline-none focus:border-emerald-500">
                        <input type="text" id="ttags" placeholder="Tags (e.g. #Trip #Food)" class="w-full p-4 border rounded-xl mb-6 outline-none bg-slate-50 text-emerald-600 font-bold text-sm">
                        <button id="btn-save-tx" onclick="window.saveTransaction()" class="w-full bg-slate-900 text-white p-4 rounded-2xl font-black uppercase shadow-lg text-center">Authorize entry</button>
                    </div>`; break;
                case 'transfer': t.innerText = 'Transfer & Invest'; c.innerHTML = `
                    <div class="max-w-lg mx-auto bg-white p-10 rounded-[3rem] border shadow-2xl text-center">
                        <div class="grid grid-cols-2 gap-4 mb-6 text-center">
                            <div>
                                <label class="text-[9px] font-black uppercase text-slate-400 block mb-1 text-left ml-2 text-center">From (Source)</label>
                                <select id="ts" onchange="window.toggleSellFields()" class="w-full p-4 border rounded-xl font-bold text-center text-center">
                                    ${state.data.accounts.map(a => `<option value="${a.id}">${a.name} (${a.currency})</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="text-[9px] font-black uppercase text-slate-400 block mb-1 text-left ml-2 text-center">To (Dest)</label>
                                <select id="ttg" class="w-full p-4 border rounded-xl font-bold text-center text-center">
                                    ${state.data.accounts.map(a => `<option value="${a.id}">${a.name} (${a.currency})</option>`).join('')}
                                </select>
                            </div>
                        </div>

                        <!-- ASSET SELL UI -->
                        <div id="asset-sell-area" class="hidden bg-slate-50 p-4 rounded-2xl mb-4 border border-slate-100">
                             <p class="text-[9px] font-black uppercase text-slate-400 mb-2">Asset Liquidation Details</p>
                             <div class="grid grid-cols-2 gap-4">
                                  <div>
                                     <label id="lbl-sell-qty" class="text-[9px] font-bold text-slate-400 block mb-1">Units/Grams</label>
                                     <input type="number" id="sell-qty" oninput="window.calcSellTotal()" class="w-full p-3 border rounded-xl font-bold text-center text-slate-900 outline-none focus:border-emerald-500" placeholder="0.00">
                                 </div>
                                 <div>
                                     <label id="lbl-sell-rate" class="text-[9px] font-bold text-slate-400 block mb-1">Rate/NAV</label>
                                     <input type="number" id="sell-rate" oninput="window.calcSellTotal()" class="w-full p-3 border rounded-xl font-bold text-center text-slate-900 outline-none focus:border-emerald-500" placeholder="0.00">
                                 </div>
                             </div>
                        </div>

                        <input type="number" id="tamt" oninput="window.calcRemit(this.value)" class="w-full p-6 border-2 rounded-2xl font-black text-3xl text-center mb-4 text-center outline-none focus:border-emerald-500" placeholder="Sending Amount">
                        <div id="remit-preview" class="text-xs font-black text-emerald-600 mb-6 h-4 text-center"></div>
                        <input type="text" id="trn" placeholder="Transfer Node / Description" class="w-full p-4 border rounded-xl mb-6 text-center outline-none focus:border-emerald-500">
                        <div id="transfer-error-msg" class="hidden text-red-500 text-xs font-bold mt-2 mb-2"></div>
                        <button id="btn-do-transfer" onclick="window.doTransfer()" class="w-full bg-emerald-500 text-white p-5 rounded-2xl font-black uppercase shadow-xl text-center">Authorize Transfer</button>
                        <p class="mt-4 text-[10px] text-slate-400 font-bold">Use this to move funds to Investment Accounts or Remit.</p>
                    </div>`; break;
                case 'debt': t.innerText = 'Liability Management'; c.innerHTML = window.renderDebtUI(); break;
                case 'settings': t.innerText = 'Configuration Hub'; c.innerHTML = window.renderSettingsUI(); break;
                case 'reports': t.innerText = 'Summaries'; c.innerHTML = window.renderDistributionInsights(); break;
                case 'analytics': t.innerText = 'Financial Health Board'; window.renderDashboard(); break;
                case 'budget': t.innerText = 'Monthly Budgeting'; c.innerHTML = window.renderBudgetUI(); break;
                case 'performance': t.innerText = 'Portfolio Growth'; c.innerHTML = window.renderPerformance(); break;
                // Goals removed
                case 'calculator': t.innerText = 'Compound Projector'; c.innerHTML = window.renderCalculator(); break;
                case 'subscriptions': t.innerText = 'Recurring Auto-Pay'; c.innerHTML = window.renderSubscriptionsUI(); break;
                case 'import': t.innerText = 'Import Statement'; c.innerHTML = window.renderImportUI(); break;
                // NEW FEATURES
                case 'remittance': t.innerText = 'Arbitrage Tracker'; c.innerHTML = window.renderRemittance(); setTimeout(window.renderRemitChart, 300); break;
                case 'zakat': t.innerText = 'Zakat Calculator'; c.innerHTML = window.renderZakatCalculator(); break;
                case 'allocation':
                    t.innerText = 'Robot Strategy';
                    const targets = state.data.allocationTargets || { 'Equity': 50, 'Gold': 20, 'Cash': 30, 'Real Estate': 0 };
                    c.innerHTML = `
                        <div class="max-w-md mx-auto bg-white p-8 rounded-[3rem] border shadow-xl text-center space-y-6">
                            <p class="text-sm text-slate-500 font-bold">Define your ideal portfolio mix.</p>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="flex justify-between text-[10px] font-black uppercase text-slate-400 mb-1">Equity (Stocks/MF)</label>
                                    <input type="number" id="alloc-equity" value="${targets['Equity']}" class="w-full p-4 border rounded-xl font-black text-center text-emerald-600 outline-none focus:ring-2 focus:ring-emerald-500" placeholder="0">
                                </div>
                                <div>
                                    <label class="flex justify-between text-[10px] font-black uppercase text-slate-400 mb-1">Gold (Commodities)</label>
                                    <input type="number" id="alloc-gold" value="${targets['Gold']}" class="w-full p-4 border rounded-xl font-black text-center text-amber-500 outline-none focus:ring-2 focus:ring-amber-500" placeholder="0">
                                </div>
                                <div>
                                    <label class="flex justify-between text-[10px] font-black uppercase text-slate-400 mb-1">Cash (Bank/Savings)</label>
                                    <input type="number" id="alloc-cash" value="${targets['Cash']}" class="w-full p-4 border rounded-xl font-black text-center text-blue-500 outline-none focus:ring-2 focus:ring-blue-500" placeholder="0">
                                </div>
                                <div>
                                    <label class="flex justify-between text-[10px] font-black uppercase text-slate-400 mb-1">Real Estate</label>
                                    <input type="number" id="alloc-re" value="${targets['Real Estate']}" class="w-full p-4 border rounded-xl font-black text-center text-indigo-500 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="0">
                                </div>
                            </div>
                            
                            <button onclick="window.saveAllocationTargetsFromModal()" class="w-full bg-slate-900 text-white p-5 rounded-2xl font-black uppercase shadow-xl hover:bg-emerald-600 transition-all">
                                Update Strategy
                            </button>
                        </div>
                    `;
                    break;

                case 'sweep':
                    t.innerText = 'Budget Sweep';
                    const sw = window.pendingSweep || { cat: '?', amt: 0 };
                    c.innerHTML = `
                        <div class="max-w-md mx-auto bg-white p-8 rounded-[3rem] border shadow-xl text-center space-y-6">
                            <div class="bg-emerald-50 p-6 rounded-[2rem] mb-4">
                                <p class="text-[10px] uppercase font-black text-slate-400 tracking-widest mb-1">Surplus To Sweep</p>
                                <h3 class="text-4xl font-black text-emerald-600 num-font">${state.data.settings.currency || 'AED'} ${Math.round(sw.amt).toLocaleString()}</h3>
                                <p class="text-xs font-bold text-emerald-700/60 mt-2">From '${sw.cat}' Budget</p>
                            </div>

                            <div class="grid grid-cols-1 gap-4 text-left">
                                <div>
                                    <label class="text-[9px] font-black uppercase text-slate-400 ml-3 mb-1 block">From Account (Source)</label>
                                    <select id="sw-src" class="w-full p-4 border rounded-xl font-bold text-sm bg-slate-50 outline-none focus:ring-2 focus:ring-emerald-500">
                                        <option value="">Select Source...</option>
                                        ${state.data.accounts.filter(a => ['Bank Account', 'Cash'].includes(a.type)).map(a => `<option value="${a.id}">${a.name} (Avl: ${a.balance})</option>`).join('')}
                                    </select>
                                </div>
                                <div class="flex justify-center text-slate-300"><i data-lucide="arrow-down" class="w-6 h-6"></i></div>
                                <div>
                                    <label class="text-[9px] font-black uppercase text-slate-400 ml-3 mb-1 block">To Savings Pot (Goal)</label>
                                    <select id="sw-goal" class="w-full p-4 border rounded-xl font-bold text-sm bg-slate-50 outline-none focus:ring-2 focus:ring-emerald-500">
                                        <option value="">Select Target...</option>
                                        ${state.data.goals.map(g => `<option value="${g.id}">${g.name} (Saved: ${g.saved})</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            <button onclick="window.finalizeSweep()" class="w-full bg-slate-900 text-white p-5 rounded-2xl font-black uppercase shadow-xl hover:bg-emerald-600 transition-all flex items-center justify-center gap-2 mt-4">
                                <i data-lucide="sparkles" class="w-5 h-5"></i> Confirm Sweep
                            </button>
                        </div>
                    `;
                    break;
            }
            lucide.createIcons();
        };

        window.editAllocationTargets = function () {
            window.openModal('allocation');
        };

        window.saveAllocationTargetsFromModal = async function () {
            const eq = parseFloat(document.getElementById('alloc-equity').value) || 0;
            const gold = parseFloat(document.getElementById('alloc-gold').value) || 0;
            const cash = parseFloat(document.getElementById('alloc-cash').value) || 0;
            const re = parseFloat(document.getElementById('alloc-re').value) || 0;

            const total = eq + gold + cash + re;
            if (Math.abs(total - 100) > 1) {
                alert(`‚ö†Ô∏è Total must be 100%. Currently: ${total}%`);
                return;
            }

            state.data.allocationTargets = { 'Equity': eq, 'Gold': gold, 'Cash': cash, 'Real Estate': re };
            await updateDb();
            window.closeModal();
            window.renderApp(); // Re-render to update the robot view
        };

        window.renderPerformance = function () {
            let totalInvested = 0;
            let totalCurrent = 0;
            let assetPerformance = [];

            // 1. Process Assets
            const rows = state.data.accounts.filter(a => ['Investment', 'Mutual Fund', 'Commodity'].includes(a.type)).map(acc => {
                const txs = state.data.transactions.filter(t => t.accountId === acc.id);
                // Find Start Date (First Transfer In)
                const firstTx = txs.filter(t => t.type === 'transfer_in').sort((a, b) => new Date(a.date) - new Date(b.date))[0];
                const startDate = firstTx ? new Date(firstTx.date) : new Date();
                const daysHeld = Math.max(1, (new Date() - startDate) / (1000 * 60 * 60 * 24));
                const yearsHeld = daysHeld / 365;

                const transfersIn = txs.filter(t => t.type === 'transfer_in').reduce((s, t) => s + parseFloat(t.amount), 0);
                const transfersOut = txs.filter(t => t.type === 'transfer_out').reduce((s, t) => s + parseFloat(t.amount), 0);

                // Unified Investment Calculation: Initial Cost + Net Transfers
                const netTransfers = transfersIn - transfersOut;
                let invested;

                if (acc.originalCost !== undefined) {
                    invested = acc.originalCost + netTransfers;
                } else {
                    invested = Math.max(0, netTransfers);
                }

                const curVal = acc.currency === 'AED' ? acc.balance * state.data.settings.rate : acc.balance;
                const invVal = acc.currency === 'AED' ? invested * state.data.settings.rate : invested;

                totalInvested += invVal;
                totalCurrent += curVal;

                const gain = curVal - invVal;
                const gainP = invVal > 0 ? (gain / invVal * 100) : 0;

                // CAGR Calc
                let cagr = 0;
                if (invVal > 0 && curVal > 0 && yearsHeld >= 1) {
                    cagr = (Math.pow(curVal / invVal, 1 / yearsHeld) - 1) * 100;
                } else if (yearsHeld < 1) {
                    cagr = gainP; // Show absolute return for <1 year
                }

                assetPerformance.push({ name: acc.name, gain: gain, gainP: gainP, cagr: cagr, years: yearsHeld, symbol: acc.subtype === 'Gold' ? 'ü•á' : 'üìà' });

                const isSlug = cagr < 6; // Inflation benchmark
                const badge = yearsHeld >= 1
                    ? `<span class="px-2 py-0.5 rounded-md text-[8px] font-black uppercase ${cagr > 12 ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-100 text-slate-500'}">${cagr > 20 ? 'üöÄ' : (isSlug ? 'üê¢' : 'üìà')} ${cagr.toFixed(1)}% p.a.</span>`
                    : `<span class="px-2 py-0.5 rounded-md text-[8px] font-black uppercase bg-slate-50 text-slate-400">New (${daysHeld.toFixed(0)}d)</span>`;

                return `<div class="flex justify-between items-center p-4 bg-slate-50 rounded-2xl border mb-2 text-[10px]">
                    <div class="text-left font-bold w-1/3">
                        <div class="truncate">${acc.name}</div>
                        ${badge}
                    </div>
                    <div class="text-right w-1/3 text-slate-400 num-font leading-none">‚Çπ${Math.round(invVal).toLocaleString()}</div>
                    <div class="text-right w-1/3 font-black ${gain >= 0 ? 'text-emerald-500' : 'text-red-500'} num-font leading-none">
                        ‚Çπ${Math.round(curVal).toLocaleString()} <span class="text-[8px] opacity-70 font-sans tracking-normal">(${gainP.toFixed(1)}%)</span>
                    </div>
                </div>`;
            }).join('');

            const netGain = totalCurrent - totalInvested;

            // --- REBALANCING ROBOT LOGIC ---
            // 1. Calc Current Allocation
            let allocIds = { 'Equity': 0, 'Gold': 0, 'Cash': 0, 'Real Estate': 0 };
            state.data.accounts.forEach(a => {
                const val = a.currency === 'AED' ? a.balance * state.data.settings.rate : a.balance;
                if (a.type === 'Mutual Fund' || a.type === 'Investment') allocIds['Equity'] += val;
                else if (a.type === 'Commodity' && a.subtype === 'Gold') allocIds['Gold'] += val;
                else if (['Bank Account', 'Cash', 'Savings'].includes(a.type)) allocIds['Cash'] += val;
                else if (a.type === 'Real Estate') allocIds['Real Estate'] += val;
            });

            const totalPortfolioValue = Object.values(allocIds).reduce((a, b) => a + b, 0);
            const targets = state.data.allocationTargets || { 'Equity': 50, 'Gold': 20, 'Cash': 30, 'Real Estate': 0 };

            // 2. Generate Actions
            let actions = [];
            Object.keys(targets).forEach(key => {
                const targetPct = targets[key];
                const currentVal = allocIds[key];
                const targetVal = totalPortfolioValue * (targetPct / 100);
                const diff = targetVal - currentVal;

                // Threshold: Only suggest action if deviation> 5% of target or> 1000 AED
                if (Math.abs(diff) > 1000) {
                    const action = diff > 0 ? 'Buy' : 'Sell';
                    actions.push({ asset: key, action, amount: Math.abs(diff) });
                }
            });

            // 2. Determine MVP & Anchor
            assetPerformance.sort((a, b) => b.gainP - a.gainP);
            const mvp = assetPerformance.length > 0 ? assetPerformance[0] : null;
            const anchor = assetPerformance.length > 0 ? assetPerformance[assetPerformance.length - 1] : null;

            // 3. Render
            setTimeout(() => {
                const ctx = document.getElementById('chart-profit-wedge');
                if (ctx && totalInvested > 0) {
                    // Generate Trend Data for Wedge
                    // Since we lack daily history, we simulate:
                    // Invested Line: Linear ramp from 0 to Total Invested? No, let's look at transactions?
                    // Too complex for JS-only right now.
                    // Approximation: 
                    // P1: Start Date (Invested=0, Val=0)
                    // P2: End Date (Invested=TotalInvested, Val=TotalCurrent)
                    // Fill the middle

                    const labels = Array.from({ length: 12 }, (_, i) => `T-${11 - i}M`);
                    // Create a "Smooth" curve for Value and a "Stepped" curve for Invested (simulating SIPs)
                    const dataInvested = labels.map((_, i) => totalInvested * ((i + 1) / 12)); // Linear accumulation assumption
                    // Value assumes compounding curve
                    const r = totalCurrent / totalInvested; // Total Multiple
                    const dataValue = labels.map((_, i) => totalInvested * ((i + 1) / 12) * (1 + ((r - 1) * (i / 11)))); // Expanding alpha

                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Market Value',
                                    data: dataValue,
                                    borderColor: '#10b981', // Emerald
                                    backgroundColor: 'rgba(16, 185, 129, 0.2)', // Green Mist
                                    fill: true,
                                    tension: 0.4,
                                    pointRadius: 0
                                },
                                {
                                    label: 'Invested Capital',
                                    data: dataInvested,
                                    borderColor: '#94a3b8', // Slate 400
                                    backgroundColor: 'rgba(148, 163, 184, 0.1)', // Grey Mist
                                    fill: true,
                                    tension: 0.4,
                                    pointRadius: 0
                                }
                            ]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { display: false } }, // Minimal
                            scales: { x: { display: false }, y: { display: false } },
                            elements: { point: { radius: 0 } }
                        }
                    });
                }
            }, 500);

            return `<div class="max-w-xl mx-auto space-y-6 text-center">
                
                <!-- 0. REBALANCING ROBOT -->
                 <div class="bg-indigo-900 text-white p-6 rounded-[2.5rem] shadow-xl relative overflow-hidden text-left mb-6">
                    <div class="flex justify-between items-center mb-4 relative z-10">
                         <h4 class="text-[10px] font-black uppercase text-indigo-300 tracking-widest flex items-center gap-2">
                            <i data-lucide="bot" class="w-4 h-4"></i> Rebalancing Robot
                        </h4>
                        <button onclick="window.editAllocationTargets()" class="bg-indigo-800 p-2 rounded-full hover:bg-indigo-700 text-[10px] font-bold uppercase transition-colors">
                            Set Targets
                        </button>
                    </div>
                    
                    <div class="relative z-10">
                         ${actions.length === 0 ?
                    `<div class="text-center py-4"><p class="text-emerald-400 font-bold text-sm">Balanced ‚úÖ</p><p class="text-[9px] text-indigo-400">Your portfolio matches your targets.</p></div>` :
                    `<div class="space-y-2">
                                ${actions.map(a => `
                                <div class="flex justify-between items-center bg-indigo-950/50 p-3 rounded-xl border border-indigo-800/50">
                                    <div class="flex items-center gap-2">
                                        <div class="w-2 h-2 rounded-full ${a.action === 'Buy' ? 'bg-emerald-500' : 'bg-red-500'}"></div>
                                        <p class="font-bold text-xs text-indigo-100">${a.action} ${a.asset}</p>
                                    </div>
                                    <p class="font-black text-xs text-indigo-200 num-font">${a.action === 'Buy' ? '+' : '-'} ‚Çπ${Math.round(a.amount).toLocaleString()}</p>
                                </div>
                                `).join('')}
                            </div>`
                }
                    </div>
                 </div>
                
                <!-- 1. HIGHLIGHTS Card (MVP & Anchor) -->
                ${mvp ? `<div class="grid grid-cols-2 gap-4">
                    <div class="bg-gradient-to-br from-emerald-500 to-emerald-700 text-white p-4 rounded-[2rem] shadow-lg relative overflow-hidden">
                        <div class="relative z-10 text-left">
                            <p class="text-[9px] uppercase font-black text-emerald-200 tracking-widest mb-1">MVP üèÜ</p>
                            <p class="font-bold text-sm truncate">${mvp.name}</p>
                            <p class="text-2xl font-black mt-1 num-font">+${mvp.gainP.toFixed(1)}%</p>
                        </div>
                        <i data-lucide="trending-up" class="absolute -bottom-2 -right-2 text-white/20 w-16 h-16"></i>
                    </div>
                     <div class="bg-slate-800 text-white p-4 rounded-[2rem] shadow-lg relative overflow-hidden">
                        <div class="relative z-10 text-left">
                            <p class="text-[9px] uppercase font-black text-slate-400 tracking-widest mb-1">Anchor ${anchor.gainP < 0 ? '‚öì' : 'üí§'}</p>
                            <p class="font-bold text-sm truncate text-slate-300">${anchor.name}</p>
                            <p class="text-2xl font-black mt-1 num-font ${anchor.gainP < 0 ? 'text-red-400' : 'text-slate-400'}">${anchor.gainP > 0 ? '+' : ''}${anchor.gainP.toFixed(1)}%</p>
                        </div>
                        <i data-lucide="anchor" class="absolute -bottom-2 -right-2 text-white/10 w-16 h-16"></i>
                    </div>
                </div>` : ''}

                <!-- 2. PROFIT WEDGE CHART (Visual Alpha) -->
                <div class="bg-white p-6 rounded-[2.5rem] border shadow-sm relative overflow-hidden">
                    <div class="flex justify-between items-end mb-4 relative z-10 text-left">
                         <div>
                            <p class="text-[10px] uppercase font-black text-slate-400 tracking-widest mb-1">Net Alpha (Profit)</p>
                            <h3 class="text-4xl font-black ${netGain >= 0 ? 'text-emerald-500' : 'text-red-500'} num-font">${netGain >= 0 ? '+' : ''}‚Çπ${Math.round(netGain).toLocaleString()}</h3>
                         </div>
                         <div class="text-right">
                             <div class="flex items-center gap-2 justify-end mb-1"><span class="w-2 h-2 rounded-full bg-emerald-500"></span><span class="text-[9px] font-bold text-slate-500">Value</span></div>
                             <div class="flex items-center gap-2 justify-end"><span class="w-2 h-2 rounded-full bg-slate-300"></span><span class="text-[9px] font-bold text-slate-500">Cost</span></div>
                         </div>
                    </div>
                    <div class="h-48 w-full relative z-10">
                        <canvas id="chart-profit-wedge"></canvas>
                    </div>
                     <div class="grid grid-cols-2 gap-4 mt-4 relative z-10">
                        <div class="bg-slate-50 rounded-xl p-3"><p class="text-[8px] text-slate-400 uppercase font-black">Invested</p><p class="font-bold text-sm num-font">‚Çπ${Math.round(totalInvested).toLocaleString()}</p></div>
                        <div class="bg-emerald-50 rounded-xl p-3"><p class="text-[8px] text-emerald-600 uppercase font-black">Current</p><p class="font-bold text-sm text-emerald-700 num-font">‚Çπ${Math.round(totalCurrent).toLocaleString()}</p></div>
                    </div>
                </div>

                <!-- 3. HOLDINGS LIST -->
                <div class="bg-white rounded-[2rem] border p-6">
                    <h4 class="text-xs font-black uppercase text-slate-400 tracking-widest mb-4 text-left px-2">Portfolio Performance</h4>
                    ${rows || '<p class="text-slate-300 italic">No investments found</p>'}
                </div>
            </div>`;
        };

        // renderGoalsUI function removed

        window.renderZakatCalculator = function () {
            const r = state.data.settings.rate;
            // 1. Calculate Qualifying Assets
            let qualifying = 0;
            const breakdown = { 'Gold': 0, 'Cash': 0, 'Shares': 0 };

            state.data.accounts.forEach(a => {
                const val = a.currency === 'AED' ? a.balance * r : a.balance;

                // INCLUSIONS
                if (['Bank Account', 'Cash', 'Savings'].includes(a.type)) {
                    qualifying += val;
                    breakdown['Cash'] += val;
                }
                else if (a.type === 'Commodity' && (a.subtype === 'Gold' || a.subtype === 'Silver')) {
                    qualifying += val;
                    breakdown['Gold'] += val;
                }
                else if (a.type === 'Mutual Fund' || a.type === 'Investment') {
                    qualifying += val;
                    breakdown['Shares'] += val;
                }
                // EXCLUSIONS: Real Estate, Vehicle, Collectibles
            });

            // 2. Liabilities (Immedaite) -> Deductible
            // Simplified: All Payable Debts not settled
            let liabilities = 0;
            state.data.debts.filter(d => d.type === 'payable' && !d.settled).forEach(d => {
                const val = Number(d.amount) * (d.currency === 'AED' ? r : 1);
                liabilities += val;
            });

            const netZakatable = Math.max(0, qualifying - liabilities);
            const zakatDue = netZakatable * 0.025; // 2.5%

            // Nisab Check (Approx 85g Gold ~ 600,000 INR approx? Need manual input or static threshold)
            // Let's assume Nisab is roughly 500k INR for now to trigger display
            const nisab = 600000;
            const isEligible = netZakatable > nisab;

            // BNPL Calculation (assuming this is a separate section within the same UI)
            const totalIncome = state.data.transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const totalExpenses = state.data.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const freeCash = totalIncome - totalExpenses;
            const discretionary = Math.max(0, freeCash - (state.data.fixedCategories || []).reduce((sum, cat) => sum + ((state.data.budgets && state.data.budgets[cat]) || 0), 0));
            const availableCapacity = discretionary * 0.20; // 20% of discretionary income for BNPL

            return `<div class="max-w-xl mx-auto space-y-8 text-center">
                 <div class="bg-slate-900 text-white p-8 rounded-[3rem] shadow-xl relative overflow-hidden">
                    <div class="relative z-10">
                        <p class="text-[10px] uppercase font-black text-slate-400 tracking-widest mb-1">Zakat Liability (2.5%)</p>
                        <h3 class="text-5xl font-black text-emerald-400 mb-2 num-font">‚Çπ${Math.round(zakatDue).toLocaleString()}</h3>
                        <p class="text-slate-400 font-medium text-xs">${isEligible ? 'Passed Nisab Threshold' : 'Below Nisab Threshold (Optional)'}</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-[2.5rem] border shadow-sm text-left">
                     <h4 class="text-[10px] font-black uppercase text-slate-400 mb-6 tracking-widest px-2">Calculation Breakdown</h4>
                     
                     <div class="space-y-4 text-sm font-bold text-slate-700">
                        <div class="flex justify-between items-center p-3 bg-slate-50 rounded-2xl">
                            <span>Qualifying: Gold & Silver</span>
                             <span class="num-font">‚Çπ${Math.round(breakdown['Gold']).toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-slate-50 rounded-2xl">
                            <span>Qualifying: Cash & Bank</span>
                             <span class="num-font">‚Çπ${Math.round(breakdown['Cash']).toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-slate-50 rounded-2xl">
                            <span>Qualifying: Shares & Investments</span>
                             <span class="num-font">‚Çπ${Math.round(breakdown['Shares']).toLocaleString()}</span>
                        </div>
                        <hr class="border-slate-100">
                        <div class="flex justify-between items-center px-3 text-red-500">
                            <span>Less: Immediate Debts</span>
                             <span class="num-font">- ‚Çπ${Math.round(liabilities).toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between items-center px-3 text-lg font-black text-slate-900 pt-2">
                            <span>Net Zakatable Wealth</span>
                             <span class="num-font">‚Çπ${Math.round(netZakatable).toLocaleString()}</span>
                        </div>
                     </div>
                </div>

                <button onclick="alert('Feature to auto-debit coming soon!')" class="w-full bg-emerald-500 text-white p-5 rounded-3xl font-black uppercase shadow-xl hover:bg-emerald-600 transition-all flex items-center justify-center gap-2">
                    <i data-lucide="check-circle" class="w-5 h-5"></i> Record Zakat Payment
                </button>
            </div>`;
        };

        // createGoal, contribGoal, deleteGoal removed


        window.sweepBudget = function (cat, amt) {
            window.showToast("Savings Pots feature removed.", "warning");
        };

        window.finalizeSweep = async function () {
            const sw = window.pendingSweep;
            if (!sw) return;

            const srcId = document.getElementById('sw-src').value;
            const goalId = document.getElementById('sw-goal').value;

            if (!srcId || !goalId) {
                window.showToast("Please select both source and target.", "warning");
                return;
            }

            const acc = state.data.accounts.find(a => a.id === srcId);
            const goal = state.data.goals.find(g => g.id === goalId);

            if (!acc || !goal) return;
            if (acc.balance < sw.amt) {
                window.showToast("Insufficient funds in selected account!", "error");
                return;
            }

            // Execute
            const accIdx = state.data.accounts.findIndex(a => a.id === acc.id);
            const gIdx = state.data.goals.findIndex(g => g.id === goal.id);

            state.data.accounts[accIdx].balance = window.toCurrency(state.data.accounts[accIdx].balance - sw.amt);
            state.data.goals[gIdx].saved += sw.amt;

            // Log Transaction (Mark as Sweep)
            state.data.transactions.push({
                id: window.genId(),
                accountId: acc.id,
                amount: window.toCurrency(sw.amt),
                type: 'transfer_out',
                category: 'Sweep',
                note: `Budget Sweep: ${sw.cat} -> ${goal.name} `,
                date: new Date().toISOString()
            });

            await updateDb();
            window.closeModal();
            window.renderApp();
            window.showToast(`‚ú® Swept ${sw.amt} into ${goal.name} !`, "success");
            window.pendingSweep = null; // Clear
        };

        window.setBudget = function (cat) {
            window.showPrompt(`Budget for ${cat}`, "Set Monthly Limit (AED):", async (valStr) => {
                const val = parseFloat(valStr);
                if (!isNaN(val)) {
                    if (!state.data.budgets) state.data.budgets = {};
                    state.data.budgets[cat] = val;
                    await updateDb(); window.openModal('budget');
                    window.showToast("Budget Updated", "success");
                }
            }, "number");
        };

        window.checkBudgetRollover = async function () {
            const now = new Date();
            const last = state.data.lastRolloverDate ? new Date(state.data.lastRolloverDate) : null;

            // If new month detected
            if (last && (now.getMonth() !== last.getMonth() || now.getFullYear() !== last.getFullYear())) {
                window.showToast("üìÖ New Month! Processing Rollovers...", "info");
                if (!state.data.budgetRollovers) state.data.budgetRollovers = {};

                // Calculate rollovers from PREVIOUS month
                const cats = state.data.expenseCategories;
                for (let c of cats) {
                    const budget = (state.data.budgets && state.data.budgets[c]) || 0;
                    if (budget > 0) {
                        // Calc spend of LAST month
                        const spend = state.data.transactions.filter(t =>
                            t.type === 'expense' && t.category === c &&
                            new Date(t.date).getMonth() === last.getMonth() &&
                            new Date(t.date).getFullYear() === last.getFullYear()
                        ).reduce((s, t) => s + parseFloat(t.amount), 0);

                        const leftover = Math.max(0, budget - spend);
                        if (leftover > 0) {
                            state.data.budgetRollovers[c] = (state.data.budgetRollovers[c] || 0) + leftover;
                        }
                    }
                }
                state.data.lastRolloverDate = now.toISOString();
                await updateDb();
            } else if (!last) {
                state.data.lastRolloverDate = now.toISOString();
                await updateDb();
            }
        };

        // --- SUBSCRIPTION MANAGER ---
        window.renderSubscriptionsUI = function () {
            return `<div class= "max-w-xl mx-auto space-y-6">
            <div class="bg-slate-50 p-6 rounded-[2.5rem] border shadow-sm">
                <h4 class="text-[10px] font-black uppercase text-slate-400 mb-4 tracking-widest text-center">New Auto-Pay</h4>
                <div class="space-y-4">
                    <input type="text" id="sub-name" placeholder="Name (e.g. Netflix)" class="w-full p-3 border rounded-xl font-bold text-sm outline-none focus:border-emerald-500">
                        <div class="grid grid-cols-2 gap-4">
                            <input type="number" id="sub-amt" placeholder="Amount" class="p-3 border rounded-xl font-bold text-sm outline-none focus:border-emerald-500">
                                <input type="number" id="sub-day" placeholder="Day (1-31)" min="1" max="31" class="p-3 border rounded-xl font-bold text-sm outline-none focus:border-emerald-500">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <select id="sub-type" class="p-3 border rounded-xl font-bold text-sm bg-white">
                                        <option value="expense">Expense (-)</option>
                                        <option value="income">Income (+)</option>
                                    </select>
                                    <select id="sub-acc" class="p-3 border rounded-xl font-bold text-sm bg-white">
                                        <option value="">Link Account...</option>
                                        ${state.data.accounts.map(a => `<option value="${a.id}">${a.name} (${a.currency})</option>`).join('')}
                                    </select>
                                </div>
                                
                                <!-- NEW FIELDS: Billing Cycle & Free Trial -->
                                <div class="grid grid-cols-2 gap-4">
                                     <select id="sub-cycle" class="p-3 border rounded-xl font-bold text-sm bg-white">
                                        <option value="Monthly">Monthly</option>
                                        <option value="Yearly">Yearly</option>
                                    </select>
                                    <div class="relative">
                                        <label class="absolute -top-2 left-2 px-1 bg-white text-[9px] font-bold text-slate-400">Free Trial Ends (Opt)</label>
                                        <input type="date" id="sub-trial" class="w-full p-3 border rounded-xl font-bold text-sm outline-none focus:border-emerald-500 text-slate-600">
                                    </div>
                                </div>
                                <button onclick="window.addSubscription()" class="w-full bg-slate-900 text-white p-3 rounded-xl font-black uppercase shadow-lg text-xs">Create Schedule</button>
                        </div>
                </div>

                <div class="space-y-4">
                    <h4 class="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-2">Active Schedules</h4>
                    ${(state.data.subscriptions || []).map(s => {
                const acc = state.data.accounts.find(a => a.id === s.accountId);
                return `<div class="bg-white p-5 rounded-[2rem] border shadow-sm flex justify-between items-center group">
                            <div class="text-left">
                                <p class="font-black text-slate-800">${s.name}</p>
                                <p class="text-[9px] font-bold text-slate-400 uppercase">
                                    ${s.billingCycle || 'Monthly'} ‚Ä¢ Next: ${new Date(s.nextDate).toLocaleDateString()}
                                    ${s.freeTrialEndDate && new Date(s.freeTrialEndDate) > new Date() ?
                        `<span class="ml-1 px-1.5 py-0.5 bg-indigo-100 text-indigo-600 rounded text-[8px] font-black">TRIAL</span>` : ''}
                                </p>
                                ${acc ? `<p class="text-[8px] font-bold text-emerald-600 uppercase mt-0.5"><i data-lucide="link" class="w-3 h-3 inline"></i> ${acc.name}</p>` : ''}
                            </div>
                            <div class="text-right">
                                <p class="font-black text-lg ${s.type === 'income' ? 'text-emerald-500' : 'text-slate-800'}">${s.type === 'income' ? '+' : '-'} ${s.amount}</p>
                                <button onclick="window.deleteSubscription('${s.id}')" class="text-[9px] text-red-300 font-bold uppercase hover:text-red-500">Stop</button>
                            </div>
                        </div>`;
            }).join('') || '<p class="text-center text-slate-300 py-4 font-bold text-xs uppercase">No active subscriptions</p>'}
                </div>
            </div>`;
        };

        window.addSubscription = async function () {
            const name = document.getElementById('sub-name').value;
            const amount = parseFloat(document.getElementById('sub-amt').value);
            const day = parseInt(document.getElementById('sub-day').value);
            const type = document.getElementById('sub-type').value;
            const accId = document.getElementById('sub-acc').value;
            // Capture target if transfer
            const targetAccId = document.getElementById('sub-target-acc') ? document.getElementById('sub-target-acc').value : null;

            const cycle = document.getElementById('sub-cycle').value || 'Monthly';
            const trial = document.getElementById('sub-trial').value || null;

            if (!name || isNaN(amount) || isNaN(day) || !accId) {
                window.showToast("Please fill all required fields.", "error");
                return;
            }

            if (type === 'transfer' && !targetAccId) {
                window.showToast("Please select a Destination Account.", "error");
                return;
            }

            if (!state.data.subscriptions) state.data.subscriptions = [];

            // Calc next date: If today > day, then next month. Else this month.
            // Support Yearly cycle? For now, logic defaults to Monthly for 'nextDate' calc initially.
            // We can refine nextDate logic later if needed.
            const d = new Date();
            if (d.getDate() > day) d.setMonth(d.getMonth() + 1);
            d.setDate(day);

            state.data.subscriptions.push({
                id: window.genId(),
                name, amount, type,
                day,
                billingCycle: cycle,
                freeTrialEndDate: trial,
                nextDate: d.toISOString(),
                accountId: accId,
                targetAccountId: targetAccId || null,
                category: type === 'transfer' ? 'Transfer' : 'Recurring'
            });
            await updateDb();
            window.showToast("Subscription Added!", "success");
            window.openModal('subscriptions');
        };

        window.deleteSubscription = async function (id) {
            window.showConfirm("Stop this subscription?", "Future auto-transactions will be cancelled.", async () => {
                state.data.subscriptions = state.data.subscriptions.filter(s => s.id !== id);
                await updateDb(); window.openModal('subscriptions');
                window.showToast("Subscription cancelled.", "success");
            });
        };

        window.checkSubscriptions = async function () {
            if (!state.data.subscriptions) return;
            let changed = false;
            const today = new Date();

            for (let sub of state.data.subscriptions) {
                const due = new Date(sub.nextDate);
                if (today >= due) {

                    if (sub.type === 'transfer') {
                        // --- TRANSFER LOGIC ---
                        const srcIdx = state.data.accounts.findIndex(a => a.id === sub.accountId);
                        const tgtIdx = state.data.accounts.findIndex(a => a.id === sub.targetAccountId);

                        if (srcIdx > -1 && tgtIdx > -1) {
                            const amt = parseFloat(sub.amount);
                            const srcAcc = state.data.accounts[srcIdx];
                            const tgtAcc = state.data.accounts[tgtIdx];

                            // 1. Deduct from Source
                            state.data.accounts[srcIdx].balance = window.toCurrency(state.data.accounts[srcIdx].balance - amt);

                            // 2. Add to Target (Simple 1:1 if same currency, else approximate or skip conv for MVP auto-run)
                            // Ideally reusing window.doTransfer logic but that's async and UI bound.
                            // For Auto-run, we'll assume 1:1 if same currency, otherwise use global rate if available
                            let finalAmt = amt;
                            if (srcAcc.currency !== tgtAcc.currency) {
                                const rate = state.data.settings.rate;
                                if (srcAcc.currency === 'AED' && tgtAcc.currency === 'INR') finalAmt = amt * rate;
                                else if (srcAcc.currency === 'INR' && tgtAcc.currency === 'AED') finalAmt = amt / rate;
                            }

                            state.data.accounts[tgtIdx].balance = window.toCurrency(state.data.accounts[tgtIdx].balance + finalAmt);

                            // 3. Transactions
                            const dateIso = new Date().toISOString();
                            state.data.transactions.push({
                                id: window.genId(), accountId: sub.accountId, amount: window.toCurrency(amt), type: 'transfer_out', category: 'Auto-Transfer', note: `To ${tgtAcc.name}: ${sub.name} `, date: dateIso
                            });
                            state.data.transactions.push({
                                id: window.genId(), accountId: sub.targetAccountId, amount: window.toCurrency(finalAmt), type: 'transfer_in', category: 'Auto-Transfer', note: `From ${srcAcc.name}: ${sub.name} `, date: dateIso
                            });

                            changed = true;
                            alert(`üîî Auto - Transfer Executed: ${sub.name} `);
                        }

                    } else {
                        // --- INCOME/EXPENSE LOGIC ---
                        const accIdx = state.data.accounts.findIndex(a => a.id === sub.accountId);
                        if (accIdx > -1) {
                            const amt = parseFloat(sub.amount);
                            const curBal = parseFloat(state.data.accounts[accIdx].balance);
                            state.data.accounts[accIdx].balance = window.toCurrency(sub.type === 'income' ? curBal + amt : curBal - amt);

                            state.data.transactions.push({
                                id: window.genId(),
                                accountId: sub.accountId,
                                amount: window.toCurrency(amt),
                                type: sub.type,
                                category: sub.category,
                                note: `Auto - Pay: ${sub.name} `,
                                date: new Date().toISOString()
                            });
                            window.showToast(`üîî Auto - Processed: ${sub.name} `, "info");
                        }
                    }

                    // Advance Date
                    const next = new Date(due);
                    next.setMonth(next.getMonth() + 1);
                    sub.nextDate = next.toISOString();
                    changed = true; // Ensure date update saves even if acc not found (border case)
                }
            }
            if (changed) {
                await updateDb();
                window.renderApp();
            }
        };

        window.renderCalculator = function () {
            // Simple SIP Projector
            return `<div class="max-w-md mx-auto bg-white p-8 rounded-[3rem] border shadow-xl text-center space-y-6">
                <h3 class="font-black text-xl">SIP Projector</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[9px] font-bold uppercase text-slate-400">Monthly Inv</label><input type="number" id="sip-amt" value="5000" class="w-full p-3 border rounded-xl font-bold text-center"></div>
                    <div><label class="text-[9px] font-bold uppercase text-slate-400">Return %</label><input type="number" id="sip-rate" value="12" class="w-full p-3 border rounded-xl font-bold text-center"></div>
                </div>
                <div><label class="text-[9px] font-bold uppercase text-slate-400">Time Period (Years)</label><input type="range" id="sip-years" min="1" max="30" value="10" class="w-full accent-emerald-500" oninput="document.getElementById('yr-val').innerText = this.value + ' Years'; window.calcSIP()"> <p id="yr-val" class="font-black text-emerald-600">10 Years</p></div>
                <div class="bg-slate-50 p-6 rounded-3xl"><p class="text-xs text-slate-400 font-bold uppercase">Estimated Value</p><p id="sip-result" class="text-4xl font-black text-emerald-600 mt-2">‚Çπ0</p></div>
                <button onclick="window.calcSIP()" class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold uppercase text-xs">Calculate</button>
            </div> `;
        };

        window.calcSIP = function () {
            const P = parseFloat(document.getElementById('sip-amt').value);
            const r = parseFloat(document.getElementById('sip-rate').value) / 100 / 12;
            const n = parseFloat(document.getElementById('sip-years').value) * 12;

            const FV = P * ((Math.pow(1 + r, n) - 1) / r) * (1 + r);
            document.getElementById('sip-result').innerText = '‚Çπ' + Math.round(FV).toLocaleString();
        };

        window.renderDashboard = function () {
            const c = document.getElementById('modal-content');

            // --- DATA PREP ---
            const r = state.data.settings.rate;
            const d = new Date(); d.setMonth(d.getMonth() - 1); // Last 30 Days snapshot for velocity/rhythm
            const txs = state.data.transactions;

            // 1. CALC FINANCIAL HEALTH SCORE VARIABLES
            // A. Savings Rate (Last 30 Days)
            const last30Inc = txs.filter(t => t.type === 'income' && new Date(t.date) >= d).reduce((s, t) => s + Number(window.convert(t.amount, t.currency || 'AED')), 0);
            const last30Exp = txs.filter(t => t.type === 'expense' && new Date(t.date) >= d).reduce((s, t) => s + Number(window.convert(t.amount, t.currency || 'AED')), 0);
            const savingsRate = last30Inc > 0 ? Math.max(0, ((last30Inc - last30Exp) / last30Inc) * 100) : 0;

            // B. Runway (Months)
            const liquid = state.data.accounts.filter(a => ['Bank Account', 'Cash', 'Savings'].includes(a.type)).reduce((s, a) => s + (a.currency === 'AED' ? a.balance * r : a.balance), 0);
            const avgExp = last30Exp > 0 ? last30Exp : 1; // Avoid div by 0
            const runway = liquid / avgExp;

            // C. Debt Load (Debt / Assets)
            const totalAssets = state.data.accounts.reduce((s, a) => s + (a.currency === 'AED' ? a.balance * r : a.balance), 0);
            const totalDebt = state.data.debts.filter(d => !d.settled).reduce((s, d) => s + (d.currency === 'AED' ? d.amount * r : d.amount), 0);
            const debtRatio = totalAssets > 0 ? (totalDebt / totalAssets) * 100 : 0;

            // Score Formula: (Savings * 0.4) + (RunwayCapped * 0.4) + (DebtInverted * 0.2)
            // Runway: 6 months = 100 pts. 
            const sScore = Math.min(100, savingsRate * 2); // 50% savings = 100 pts
            const rScore = Math.min(100, (runway / 6) * 100);
            const dScore = Math.max(0, 100 - debtRatio);

            const healthScore = Math.round((sScore * 0.4) + (rScore * 0.4) + (dScore * 0.2));
            const healthColor = healthScore > 80 ? '#10b981' : (healthScore > 50 ? '#f59e0b' : '#ef4444');

            // 2. SPENDING RHYTHM (Day of Week)
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const dayCounts = [0, 0, 0, 0, 0, 0, 0];
            txs.filter(t => t.type === 'expense').forEach(t => {
                const day = new Date(t.date).getDay();
                dayCounts[day] += Number(window.convert(t.amount, t.currency || 'AED'));
            });

            // 3. EXPENSE RADAR (Categories)
            const catMap = {};
            txs.filter(t => t.type === 'expense').forEach(t => {
                catMap[t.category] = (catMap[t.category] || 0) + Number(window.convert(t.amount, t.currency || 'AED'));
            });
            const top5Cats = Object.entries(catMap).sort((a, b) => b[1] - a[1]).slice(0, 5);

            // 4. FREEDOM RATIO (Fixed vs Free)
            // Fixed = Sum of Subscriptions + Debt EMI (Approx)
            const monthlyFixed = (state.data.subscriptions || []).reduce((s, sub) => s + Number(sub.amount), 0); // Simplified
            const monthlyIncAvg = last30Inc || 1;
            const fixedPct = Math.min(100, Math.round((monthlyFixed / monthlyIncAvg) * 100));
            const freePct = 100 - fixedPct;

            // 5. ASSET POLAR (Type Distribution)
            const assetMap = {};
            state.data.accounts.forEach(a => {
                const k = a.subtype || a.type; // Use subtype if valid (e.g. Gold), else type
                const val = a.currency === 'AED' ? a.balance * r : a.balance;
                if (val > 0) assetMap[k] = (assetMap[k] || 0) + val;
            });

            // --- OLD ANALYTICS LOGIC MERGE ---
            // 1. Net Worth (Liquid + Invested - Debts)
            let totalNW = 0;
            state.data.accounts.forEach(a => totalNW += (a.currency === 'AED' ? a.balance * r : a.balance));
            state.data.debts.forEach(d => {
                if (!d.settled) {
                    const val = Number(d.amount) * (d.currency === 'AED' ? r : 1);
                    totalNW += (d.type === 'receivable' ? val : -val);
                }
            });

            // 2. Annual Expenses (Extrapolated from last 6 months)
            const d6m = new Date(); d6m.setMonth(d6m.getMonth() - 6);
            const recentExp = state.data.transactions.filter(t => t.type === 'expense' && new Date(t.date) >= d6m).reduce((s, t) => {
                const acc = state.data.accounts.find(a => a.id === t.accountId);
                const cur = t.currency || acc?.currency || 'AED';
                return s + (Number(t.amount) * (cur === 'AED' ? r : 1));
            }, 0);

            const avgMonthlyExpOLD = recentExp / 6;
            const annualExp = avgMonthlyExpOLD * 12;

            // Output Metrics
            const freedomYears = annualExp > 0 ? (totalNW / annualExp).toFixed(1) : '‚àû';
            const freedomDate = annualExp > 0 ? new Date(new Date().setFullYear(new Date().getFullYear() + parseFloat(freedomYears))) : 'Forever';
            const dateStr = freedomDate === 'Forever' ? 'Infinity' : freedomDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            // HTML MERGE
            c.innerHTML = `
            <div class="space-y-8 py-4">
                <!-- 1. HEALTH SCORE (NEW) -->
                <div class="bg-slate-900 text-white p-8 rounded-[3rem] shadow-2xl relative overflow-hidden text-center">
                    <p class="text-[9px] font-black uppercase text-slate-500 tracking-widest mb-6">Financial Health Score</p>
                    
                    <div class="relative w-64 h-32 mx-auto">
                        <svg viewBox="0 0 200 100" class="w-full h-full overflow-visible">
                            <!-- Background Arc -->
                            <path d="M 20 100 A 80 80 0 0 1 180 100" fill="none" stroke="#1e293b" stroke-width="20" stroke-linecap="round" />
                            <!-- Value Arc -->
                            <path d="M 20 100 A 80 80 0 0 1 180 100" fill="none" stroke="${healthColor}" stroke-width="20" stroke-linecap="round" 
                                stroke-dasharray="${(healthScore / 100) * 251.2} 251.2" />
                            <!-- Text -->
                            <text x="100" y="85" text-anchor="middle" font-size="50" font-weight="900" fill="white" style="font-family: 'Outfit', sans-serif;">${healthScore}</text>
                        </svg>
                    </div>
                    <p class="text-[10px] font-bold text-slate-500 mt-6">Based on Savings, Runway & Debt</p>
                </div>

                <!-- 2. RHYTHM & RADAR (NEW) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-white p-6 rounded-[2.5rem] border shadow-sm text-center">
                        <h4 class="text-[9px] font-black uppercase text-slate-400 mb-4">Spending Rhythm</h4>
                        <canvas id="rhythmChart" height="200"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-[2.5rem] border shadow-sm text-center">
                        <h4 class="text-[9px] font-black uppercase text-slate-400 mb-4">Lifestyle Radar</h4>
                        <canvas id="radarChart" height="200"></canvas>
                    </div>
                </div>

                <!-- 3. FREEDOM & POLAR (NEW) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-white p-6 rounded-[2.5rem] border shadow-sm text-center">
                        <h4 class="text-[9px] font-black uppercase text-slate-400 mb-4">Freedom Ratio</h4>
                        <div class="relative w-40 h-40 mx-auto">
                            <canvas id="freedomChart"></canvas>
                            <div class="absolute inset-0 flex items-center justify-center flex-col pointer-events-none">
                                <span class="text-2xl font-black text-emerald-500">${freePct}%</span>
                                <span class="text-[8px] font-bold text-slate-400 uppercase">Yours</span>
                            </div>
                        </div>
                        <p class="text-[9px] font-bold text-slate-400 mt-4 px-4">
                            ${fixedPct}% is locked in Bills & Subs.
                        </p>
                    </div>
                    <div class="bg-white p-6 rounded-[2.5rem] border shadow-sm text-center">
                         <h4 class="text-[9px] font-black uppercase text-slate-400 mb-4">Wealth Composition</h4>
                         <canvas id="polarChart"></canvas>
                    </div>
                </div>

                <!-- DIVIDER -->
                <div class="flex items-center gap-4 py-4">
                    <div class="h-px bg-slate-200 flex-1"></div>
                    <span class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Detailed Pulse</span>
                    <div class="h-px bg-slate-200 flex-1"></div>
                </div>

                <!-- 4. FINANCIAL PULSE (OLD LEGACY VIEW) -->
                 <!-- 0. FREEDOM CALCULATOR (Legacy) -->
                    <div class="bg-gradient-to-br from-indigo-900 to-slate-900 text-white p-8 rounded-[3rem] shadow-2xl relative overflow-hidden text-center group">
                         <div class="absolute inset-0 bg-white/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                         <div class="relative z-10">
                            <p class="text-[10px] font-black uppercase text-indigo-300 tracking-[0.3em] mb-4">Financial Freedom Status</p>
                            <h3 class="text-6xl font-black text-white mb-2">${freedomYears} <span class="text-2xl text-slate-400 font-bold">Years</span></h3>
                            <p class="text-indigo-200 font-medium text-sm">You have bought freedom until <span class="text-white font-bold bg-white/10 px-2 py-1 rounded-lg">${dateStr}</span></p>
                            
                            <div class="mt-8 grid grid-cols-2 gap-4 border-t border-white/10 pt-6">
                                <div>
                                    <p class="text-[9px] uppercase text-slate-500 font-black">Net Wealth</p>
                                    <p class="font-bold">‚Çπ${Math.round(totalNW).toLocaleString()}</p>
                                </div>
                                <div class="border-l border-white/10">
                                    <p class="text-[9px] uppercase text-slate-500 font-black">Annual Burn</p>
                                    <p class="font-bold">‚Çπ${Math.round(annualExp).toLocaleString()}</p>
                                </div>
                            </div>
                         </div>
                    </div>

                    <!-- 1. HEALTH INDICATORS (Runway & Life) -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Financial Runway -->
                        <div class="bg-slate-900 text-white p-6 rounded-[2.5rem] border shadow-xl relative overflow-hidden group">
                            <div class="absolute inset-0 bg-emerald-500/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <h4 class="text-[10px] font-black uppercase text-emerald-400 mb-2 tracking-widest flex items-center gap-2">
                                <i data-lucide="shield-check" class="w-4 h-4"></i> Financial Runway
                            </h4>
                            <div class="flex items-end justify-between mt-4">
                                <div>
                                    <p class="text-4xl font-black" id="runway-months">--</p>
                                    <p class="text-xs text-slate-400 font-bold mt-1">Months of Survival</p>
                                </div>
                                <div class="w-16 h-16 rounded-full border-4 border-slate-700 flex items-center justify-center bg-slate-800">
                                    <i data-lucide="activity" class="w-6 h-6 text-emerald-400"></i>
                                </div>
                            </div>
                            <p class="text-[9px] text-slate-500 mt-4 leading-relaxed">
                                Calculated based on your liquid cash versus average monthly expenses. Aim for>6 months.
                            </p>
                        </div>

                        <!-- Debt Countdown -->
                        <div class="bg-indigo-600 text-white p-6 rounded-[2.5rem] border shadow-xl relative overflow-hidden">
                             <h4 class="text-[10px] font-black uppercase text-indigo-200 mb-2 tracking-widest flex items-center gap-2">
                                <i data-lucide="trending-down" class="w-4 h-4"></i> Debt Freedom
                            </h4>
                            <div class="relative h-48 w-full mt-2">
                                <canvas id="chart-debt-burndown"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- 2. LIFESTYLE MONITOR (Expense Trends) -->
                    <div class="bg-white p-6 rounded-[2.5rem] border shadow-sm">
                        <div class="flex justify-between items-center mb-6">
                             <h4 class="text-[10px] font-black uppercase text-slate-400 tracking-widest flex items-center gap-2">
                                <i data-lucide="bar-chart-2" class="w-4 h-4"></i> Lifestyle Creep Monitor
                            </h4>
                            <span class="text-[9px] font-bold bg-slate-100 text-slate-500 px-3 py-1 rounded-full">Top 3 Categories (6 Mo)</span>
                        </div>
                        <div class="relative h-64 w-full"><canvas id="chart-lifestyle"></canvas></div>
                    </div>

                    <!-- 3. WEALTH FORECAST -->
                    <div class="bg-white p-6 rounded-[2.5rem] border shadow-sm">
                        <h4 class="text-[10px] font-black uppercase text-slate-400 mb-4 tracking-widest">Net Worth Projection (5 Years)</h4>
                        <div class="relative h-64 w-full"><canvas id="chart-forecast"></canvas></div>
                    </div>

                    <!-- 4. COMPOSITION -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-white p-6 rounded-[2.5rem] border shadow-sm flex flex-col items-center">
                            <h4 class="text-[10px] font-black uppercase text-slate-400 mb-4">Detailed Asset Mix</h4>
                            <div class="relative h-64 w-full"><canvas id="chart-allocation"></canvas></div>
                        </div>
                        <div class="bg-white p-6 rounded-[2.5rem] border shadow-sm">
                            <h4 class="text-[10px] font-black uppercase text-slate-400 mb-4">Savings Rate Trend</h4>
                            <div class="relative h-64 w-full"><canvas id="chart-savings"></canvas></div>
                        </div>
                    </div>
            </div>`;

            // RENDER CHARTS



            // 2. Rhythm (Bar)
            new Chart(document.getElementById('rhythmChart'), {
                type: 'bar',
                data: { labels: days, datasets: [{ label: 'Spend', data: dayCounts, backgroundColor: '#cbd5e1', hoverBackgroundColor: '#f59e0b', borderRadius: 4 }] },
                options: { plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { display: false } } }
            });

            // 3. Radar
            new Chart(document.getElementById('radarChart'), {
                type: 'radar',
                data: {
                    labels: top5Cats.map(c => c[0]),
                    datasets: [{
                        label: 'Expense',
                        data: top5Cats.map(c => c[1]),
                        backgroundColor: 'rgba(236, 72, 153, 0.2)',
                        borderColor: '#ec4899',
                        pointBackgroundColor: '#ec4899'
                    }]
                },
                options: { plugins: { legend: { display: false } }, scales: { r: { active: false, ticks: { display: false }, grid: { circular: true } } } }
            });

            // 4. Freedom (Doughnut)
            new Chart(document.getElementById('freedomChart'), {
                type: 'doughnut',
                data: { labels: ['Free', 'Fixed'], datasets: [{ data: [freePct, fixedPct], backgroundColor: ['#10b981', '#ef4444'], borderWidth: 0, cutout: '70%' }] },
                options: { plugins: { legend: { display: false } } }
            });

            // 5. Polar Area
            new Chart(document.getElementById('polarChart'), {
                type: 'polarArea',
                data: {
                    labels: Object.keys(assetMap),
                    datasets: [{
                        data: Object.values(assetMap),
                        backgroundColor: ['#3b82f6', '#f59e0b', '#10b981', '#6366f1', '#8b5cf6', '#ec4899']
                    }]
                },
                options: { plugins: { legend: { position: 'bottom', labels: { font: { size: 9, weight: 'bold' }, usePointStyle: true } } }, scales: { r: { ticks: { display: false }, grid: { display: false } } } }
            });

            lucide.createIcons();
            setTimeout(window.renderCharts, 500); // Trigger Old Charts logic
        };

        window.runRealityCheck = function () {
            const r = state.data.settings.rate;

            // 1. Assets
            let assets = 0;
            state.data.accounts.forEach(a => assets += (a.currency === 'AED' ? Number(a.balance) : Number(a.balance) / r));

            // 2. Debts
            let debts = 0;
            state.data.debts.filter(d => !d.settled && d.type === 'payable').forEach(d => debts += (d.currency === 'AED' ? Number(d.amount) : Number(d.amount) / r));

            // 3. Sinking (Mentally Locked)
            // Reality Check: Treat the ENTIRE target as a liability/commitment
            const totalSinking = (state.data.sinkingFunds || []).reduce((s, f) => s + Number(f.target), 0);

            // Also calc monthly flow for details
            const sinkingMonthly = (state.data.sinkingFunds || []).reduce((s, f) => {
                const due = new Date(f.date); const now = new Date();
                const diffDays = Math.ceil(Math.abs(due - now) / (1000 * 60 * 60 * 24));
                const safeMonths = Math.max(1, Math.ceil(diffDays / 30));
                return s + (f.target / safeMonths);
            }, 0);

            // Net Free = Assets - Debts - Sinking Commitments
            const netFree = assets - debts - totalSinking;

            // Render Results
            const b = document.getElementById('modal-backdrop');
            const t = document.getElementById('modal-title');
            const c = document.getElementById('modal-content');

            t.innerText = "Financial Reality Check";
            c.innerHTML = `
            <div class="max-w-md mx-auto space-y-8 text-center py-6">
                <!--NET WORTH CARD-->
                <div class="bg-indigo-900 text-white p-10 rounded-[3rem] shadow-2xl relative overflow-hidden">
                    <div class="relative z-10">
                        <p class="text-[10px] text-indigo-300 font-black uppercase tracking-widest mb-2">Net Free Wealth</p>
                        <h2 class="text-5xl font-black text-white num-font mb-2">AED ${Math.round(netFree).toLocaleString()}</h2>
                        <p class="text-[10px] font-bold text-indigo-400">Assets - Liabilities - Sinking Goals</p>
                    </div>
                    <div class="absolute top-0 left-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                </div>

                <!--BREAKDOWN -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white p-6 rounded-[2.5rem] border shadow-sm">
                        <p class="text-[9px] text-slate-400 font-black uppercase mb-2">Total Assets</p>
                        <p class="text-xl font-black text-emerald-600">AED ${Math.round(assets).toLocaleString()}</p>
                    </div>
                    <div class="bg-white p-6 rounded-[2.5rem] border shadow-sm">
                        <p class="text-[9px] text-slate-400 font-black uppercase mb-2">Total Debt</p>
                        <p class="text-xl font-black text-red-500">-${Math.round(debts).toLocaleString()}</p>
                    </div>
                </div>

                <!--SINKING ALERT-->
                <div class="bg-amber-50 p-6 rounded-[2.5rem] border border-amber-100 mb-4">
                    <div class="flex items-center justify-center gap-2 mb-2 text-amber-600">
                        <i data-lucide="anchor" class="w-5 h-5"></i>
                        <span class="font-black text-xs uppercase tracking-widest">Compromised Cash</span>
                    </div>
                    <p class="text-3xl font-black text-slate-800">-${Math.round(totalSinking).toLocaleString()}</p>
                    <p class="text-[10px] font-bold text-amber-600/60 mt-1">Allocated to Sinking Funds</p>
                    <div class="mt-4 pt-4 border-t border-amber-200/50">
                        <p class="text-[9px] font-bold text-slate-400 uppercase">Monthly Lock: AED ${Math.round(sinkingMonthly).toLocaleString()}/mo</p>
                    </div>
                </div>

                <button onclick="window.renderSettingsUI(); window.openModal('settings');" class="text-slate-400 font-bold text-xs hover:text-slate-800 transition-colors uppercase">
                    Back to Settings
                </button>
            </div> `;

            b.classList.replace('hidden', 'flex');
            lucide.createIcons();
        };

        window.renderSettingsUI = function () {

            const s = state.data.settings;
            // Defaults
            const startDay = s.budgetStartDay || 1;
            const expRet = s.forecastReturn || 8;
            const infRate = s.inflationRate || 5;
            const alertLim = s.budgetAlertLimit || 80;
            const minRunway = s.minRunwayMonths || 6;

            return `
            <div class="max-w-3xl mx-auto space-y-8 py-4 text-left">
                <!--Header -->
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-black text-slate-900">App Settings</h2>
                    <p class="text-sm text-slate-500 font-medium mt-2">Customize your experience</p>
                </div>

                <!--1. PERSONALIZATION(New)-->
                <div class="bg-white p-8 rounded-[3rem] border shadow-sm text-center relative">
                    <button onclick="window.openModal('subscriptions')" class="absolute top-8 right-8 bg-indigo-50 text-indigo-600 p-3 rounded-xl font-bold text-[10px] uppercase hover:bg-indigo-100 transition-colors flex items-center gap-2">
                        <i data-lucide="calendar-clock" class="w-4 h-4"></i> Manage Subs
                    </button>
                    <p class="text-[9px] font-bold text-slate-400 uppercase mb-4 tracking-widest">Theme & Accent</p>
                    <div class="grid grid-cols-4 gap-4 max-w-sm mx-auto">
                        <button onclick="window.previewTheme('emerald')" class="h-14 rounded-2xl bg-emerald-500 shadow-lg ring-offset-2 hover:ring-2 ring-emerald-400 transition-all ${s.theme === 'emerald' ? 'ring-4 ring-offset-4 ring-slate-900 scale-105' : ''}" title="Wealth (Default)"></button>
                        <button onclick="window.previewTheme('blue')" class="h-14 rounded-2xl bg-blue-500 shadow-lg ring-offset-2 hover:ring-2 ring-blue-400 transition-all ${s.theme === 'blue' ? 'ring-4 ring-offset-4 ring-slate-900 scale-105' : ''}" title="Corporate"></button>
                        <button onclick="window.previewTheme('violet')" class="h-14 rounded-2xl bg-purple-500 shadow-lg ring-offset-2 hover:ring-2 ring-purple-400 transition-all ${s.theme === 'violet' ? 'ring-4 ring-offset-4 ring-slate-900 scale-105' : ''}" title="Creative"></button>
                        <button onclick="window.previewTheme('rose')" class="h-14 rounded-2xl bg-rose-600 shadow-lg ring-offset-2 hover:ring-2 ring-rose-500 transition-all ${s.theme === 'rose' ? 'ring-4 ring-offset-4 ring-slate-900 scale-105' : ''}" title="Rose (Premium)"></button>
                    </div>
                </div>

                <!--1.5 REALITY CHECK & FORECASTS-->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-indigo-900 text-white p-6 rounded-[2.5rem] shadow-xl relative overflow-hidden text-center flex flex-col justify-center">
                        <div class="relative z-10">
                            <h4 class="text-[10px] font-black uppercase text-indigo-300 tracking-widest mb-4">Financial Reality Check</h4>
                            <button onclick="window.runRealityCheck()" class="bg-indigo-500 hover:bg-indigo-400 text-white py-3 px-6 rounded-2xl font-black uppercase shadow-lg transition-all flex items-center justify-center gap-3 mx-auto text-xs">
                                <i data-lucide="eye" class="w-4 h-4"></i> Reveal Net Free Wealth
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-[2.5rem] border shadow-sm">
                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2"><i data-lucide="trending-up" class="w-4 h-4"></i> Forecast Assumptions</p>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-xs font-bold text-slate-700">Exp. Return (%)</span>
                                <input type="number" id="sets-ret" value="${expRet}" class="w-16 p-2 bg-slate-50 border rounded-xl text-center font-bold text-xs outline-none focus:border-emerald-500">
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-xs font-bold text-slate-700">Inflation Rate (%)</span>
                                <input type="number" id="sets-inf" value="${infRate}" class="w-16 p-2 bg-slate-50 border rounded-xl text-center font-bold text-xs outline-none focus:border-emerald-500">
                            </div>
                        </div>
                    </div>
                </div>

                <!--2. BUDGET CYCLE & THRESHOLDS-->
                <div class="bg-white p-8 rounded-[3rem] border shadow-sm">
                    <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-6 border-b pb-2">Budget & Safety Protocol</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <p class="text-[9px] font-bold text-emerald-600 uppercase mb-2">Payday Alignment</p>
                            <label class="flex justify-between items-center bg-slate-50 p-3 rounded-xl border border-slate-100">
                                <span class="text-xs font-bold text-slate-700">Budget Start Day</span>
                                <input type="number" id="sets-day" min="1" max="28" value="${startDay}" class="w-16 p-1 bg-white border rounded-lg text-center font-black text-sm outline-none focus:border-emerald-500">
                            </label>
                            <p class="text-[9px] text-slate-400 mt-2 leading-relaxed">Resets your "Days Left" and Budget Progress bars on this day of the month.</p>
                        </div>
                        <div>
                            <p class="text-[9px] font-bold text-amber-600 uppercase mb-2">Safety Thresholds</p>
                            <div class="space-y-3">
                                <label class="flex justify-between items-center">
                                    <span class="text-xs font-bold text-slate-600">Budget Alert (%)</span>
                                    <input type="number" id="sets-alert" value="${alertLim}" class="w-16 p-2 bg-slate-50 border rounded-xl text-center font-bold text-xs">
                                </label>
                                <label class="flex justify-between items-center">
                                    <span class="text-xs font-bold text-slate-600">Min Runway (Mo)</span>
                                    <input type="number" id="sets-runway" value="${minRunway}" class="w-16 p-2 bg-slate-50 border rounded-xl text-center font-bold text-xs">
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!--3. CURRENCY-->
                <div class="grid grid-cols-1 gap-6"> 
                    <div class="bg-slate-50 p-6 rounded-[2.5rem] border flex flex-col justify-center text-center">
                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-2">Base Conversion Rate</p>
                        <div class="flex items-center justify-center space-x-3 text-2xl font-black text-slate-800">
                            <span class="text-base text-slate-400">1 AED =</span>
                            <input type="number" id="sr" step="0.01" value="${state.data.settings.rate}" class="w-24 p-2 bg-white border rounded-xl text-center outline-none focus:border-emerald-500 focus:ring-2 ring-emerald-100">
                            <span class="text-base text-slate-400">INR</span>
                        </div>
                    </div>
                </div>
                
                <!--3.5 MESSAGING INFRASTRUCTURE (Universal)-->
                <div class="bg-indigo-50 p-6 rounded-[3rem] border border-indigo-100 flex flex-col justify-center text-center">
                    <div class="flex items-center justify-center gap-2 mb-4">
                        <i data-lucide="message-square" class="w-4 h-4 text-indigo-500"></i>
                        <p class="text-[10px] font-black text-indigo-400 uppercase tracking-widest">Messaging Infrastructure</p>
                    </div>
                    
                    <!-- Mode Toggle -->
                    <div class="flex items-center justify-between p-3 bg-white rounded-2xl border border-indigo-100 mb-4">
                        <span class="text-xs font-bold text-slate-600">Auto-Messaging (API)</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="sets-auto-msg" class="sr-only peer" ${state.data.settings.isAutoMessagingEnabled ? 'checked' : ''}>
                            <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-500"></div>
                        </label>
                    </div>

                    <p class="text-[9px] font-bold text-indigo-400 uppercase text-left ml-1 mb-1">Universal API Token</p>
                    <input type="password" id="sets-whapi" value="${state.data.settings.messagingToken || state.data.settings.whapiToken || ''}" placeholder="Paste API Token Here" class="w-full p-3 bg-white border rounded-xl text-center font-bold text-xs outline-none focus:border-indigo-500 focus:ring-2 ring-indigo-100 mb-4">
                    
                    <p class="text-[9px] font-bold text-indigo-400 uppercase text-left ml-1 mb-1">My Phone (Self Reminders)</p>
                    <input type="tel" id="sets-myphone" value="${state.data.settings.myPhone || ''}" placeholder="97150..." class="w-full p-3 bg-white border rounded-xl text-center font-bold text-xs outline-none focus:border-indigo-500 focus:ring-2 ring-indigo-100">
                    
                    <p class="text-[8px] text-indigo-300 mt-2 font-bold leading-relaxed">Toggle OFF for Manual drafting via WhatApp. Toggle ON for background API automation.</p>
                </div>

                <!--4. COMMODITY RATES-->
                <div class="bg-amber-50/50 p-8 rounded-[3rem] border border-amber-100">
                    <h4 class="text-xs font-black text-amber-700 uppercase tracking-widest mb-6 flex items-center gap-2">
                         <i data-lucide="gem" class="w-4 h-4"></i> Live Gold/Metal Rates (INR/g)
                    </h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        ${Object.entries(state.data.commodityRates || { Gold: 0, Silver: 0 }).map(([metal, price]) => `
                            <div class="bg-white p-4 rounded-2xl border border-amber-100 shadow-sm text-center">
                                <label class="text-[9px] font-bold text-amber-900/40 uppercase block mb-2">${metal}</label>
                                <input type="number" id="rate-${metal}" value="${price}" class="w-full text-center font-black text-amber-900 bg-transparent outline-none border-b border-transparent focus:border-amber-400 placeholder-amber-200">
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!--5. CATEGORY MANAGEMENT-->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Income -->
                    <div class="bg-white p-8 rounded-[3rem] border shadow-sm">
                         <div class="flex justify-between items-center mb-6">
                            <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Income Sources</h4>
                            <span class="text-[9px] font-bold bg-emerald-50 text-emerald-600 px-2 py-1 rounded-lg">${state.data.incomeCategories.length} Active</span>
                        </div>
                        <div class="flex space-x-2 mb-6">
                            <input type="text" id="new-inc-cat" placeholder="Add Source..." class="flex-1 p-3 bg-slate-50 border-none rounded-xl text-xs font-bold outline-none focus:ring-2 ring-emerald-100">
                            <button onclick="window.addCategory('income')" class="bg-slate-900 text-white px-4 rounded-xl font-bold"><i data-lucide="plus" class="w-4 h-4"></i></button>
                        </div>
                        <div class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar pr-2">
                            ${state.data.incomeCategories.map(c => `
                                <div class="group flex justify-between items-center p-3 hover:bg-slate-50 rounded-xl transition-colors">
                                    <span class="text-xs font-black text-slate-700">${c}</span>
                                    <button onclick="window.delCategory('income', '${c}')" class="text-slate-300 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Expense -->
                    <div class="bg-white p-8 rounded-[3rem] border shadow-sm">
                        <div class="flex justify-between items-center mb-6">
                            <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Expense Types</h4>
                            <span class="text-[9px] font-bold bg-rose-50 text-rose-600 px-2 py-1 rounded-lg">${state.data.expenseCategories.length} Active</span>
                        </div>
                        <div class="flex space-x-2 mb-6">
                            <input type="text" id="new-exp-cat" placeholder="Add Type..." class="flex-1 p-3 bg-slate-50 border-none rounded-xl text-xs font-bold outline-none focus:ring-2 ring-emerald-100">
                            <button onclick="window.addCategory('expense')" class="bg-slate-900 text-white px-4 rounded-xl font-bold"><i data-lucide="plus" class="w-4 h-4"></i></button>
                        </div>
                        <div class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar pr-2">
                            ${state.data.expenseCategories.map(c => {
                const isFixed = (state.data.fixedCategories || []).includes(c);
                return `<div class="group flex justify-between items-center p-3 hover:bg-slate-50 rounded-xl transition-colors">
                                    <div class="flex items-center gap-2">
                                        <button onclick="window.toggleFixedCat('${c}')" class="${isFixed ? 'text-rose-500' : 'text-slate-200 hover:text-rose-300'} transition-colors" title="Toggle Fixed Bill">
                                            <i data-lucide="${isFixed ? 'lock' : 'unlock'}" class="w-3 h-3"></i>
                                        </button>
                                        <span class="text-xs font-black ${isFixed ? 'text-rose-700' : 'text-slate-700'}">${c}</span>
                                    </div>
                                    <button onclick="window.delCategory('expense', '${c}')" class="text-slate-300 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </div>`;
            }).join('')}
                        </div>
                    </div>
                </div>
                
                 <!--6. MERGE TOOL(New)-->
                <div class="bg-slate-50 p-8 rounded-[3rem] border border-slate-200 text-center">
                    <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-6">Merge Categories</h4>
                    <div class="flex flex-col md:flex-row items-center justify-center gap-4 mb-4">
                        <select id="merge-src" class="p-3 border rounded-xl font-bold text-xs w-full md:w-48 bg-white">
                             <option value="">Move from...</option>
                             ${state.data.expenseCategories.map(c => `<option value="${c}">${c}</option>`).join('')}
                        </select>
                        <i data-lucide="arrow-right" class="w-4 h-4 text-slate-300"></i>
                         <select id="merge-target" class="p-3 border rounded-xl font-bold text-xs w-full md:w-48 bg-white">
                             <option value="">Merge into...</option>
                             ${state.data.expenseCategories.map(c => `<option value="${c}">${c}</option>`).join('')}
                        </select>
                    </div>
                    <button onclick="window.mergeCategories()" class="bg-slate-200 hover:bg-slate-300 text-slate-600 px-6 py-3 rounded-xl font-bold text-[10px] uppercase transition-all">
                        Merge & Delete Source
                    </button>
                </div>

                <!--7. DATA ACTIONS-->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-slate-100 p-6 rounded-[2.5rem] text-center">
                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-4">Data Management</p>
                        <div class="flex justify-center gap-4">
                            <button onclick="window.exportBackup()" class="flex items-center gap-2 bg-white text-slate-700 px-5 py-3 rounded-xl font-bold text-[10px] uppercase shadow-sm hover:shadow-md transition-all">
                                <i data-lucide="download" class="w-4 h-4"></i> Backup
                            </button>
                            <label class="flex items-center gap-2 bg-slate-800 text-white px-5 py-3 rounded-xl font-bold text-[10px] uppercase shadow-sm hover:bg-slate-900 cursor-pointer transition-all">
                                <i data-lucide="upload" class="w-4 h-4"></i> Restore
                                <input type="file" class="hidden" onchange="window.importBackup(this)">
                            </label>
                        </div>
                    </div>
                     <div class="bg-red-50 p-6 rounded-[2.5rem] border border-red-100 text-center flex flex-col justify-center">
                        <p class="text-[9px] font-black text-red-300 uppercase tracking-widest mb-3">Zone of Danger</p>
                        <button onclick="window.resetData()" class="bg-red-500 text-white px-6 py-3 rounded-xl font-black uppercase text-xs shadow-lg hover:bg-red-600 active:scale-95 transition-all text-center mx-auto">
                            Reset Entire System
                        </button>
                    </div>
                </div>

                <!--MAIN SAVE ACTION-->
            <div class="pt-6 mt-4 pb-2">
                <button onclick="window.saveSettings()" class="w-full bg-slate-900 text-white p-5 rounded-[2rem] font-black shadow-2xl hover:shadow-emerald-500/20 active:scale-[0.98] transition-all flex items-center justify-center gap-3">
                    <i data-lucide="check-circle" class="w-5 h-5"></i> Save Changes
                </button>
            </div>
            </div> `;
        };

        window.previewTheme = function (t) {
            state.data.settings.theme = t;
            window.applyTheme(t);
            // Optimization: Don't re-render entire UI, just apply CSS vars.
            // Rings update automatically via CSS state but we might need to manually toggle classes if performance is key.
            // For now, removing renderSettingsUI() prevents the big lag.
        }

        window.saveSettings = async function () {
            const r = parseFloat(document.getElementById('sr').value);
            if (isNaN(r)) return;
            state.data.settings.rate = r;

            // New Advanced Settings
            state.data.settings.budgetStartDay = parseInt(document.getElementById('sets-day').value) || 1;
            state.data.settings.forecastReturn = parseFloat(document.getElementById('sets-ret').value) || 8;
            state.data.settings.inflationRate = parseFloat(document.getElementById('sets-inf').value) || 5;
            state.data.settings.budgetAlertLimit = parseFloat(document.getElementById('sets-alert').value) || 80;
            state.data.settings.minRunwayMonths = parseFloat(document.getElementById('sets-runway').value) || 6;

            // Messaging Infrastructure
            state.data.settings.isAutoMessagingEnabled = document.getElementById('sets-auto-msg').checked;
            state.data.settings.messagingToken = document.getElementById('sets-whapi').value.trim();
            state.data.settings.myPhone = document.getElementById('sets-myphone').value.trim();

            // Theme is already set in state via previewTheme, just persisting now.

            // Commodity Rates
            if (!state.data.commodityRates) state.data.commodityRates = {};
            ['Gold', 'Silver', 'Platinum', 'Palladium'].forEach(m => {
                const el = document.getElementById('rate-' + m);
                if (el) state.data.commodityRates[m] = parseFloat(el.value);
            });

            await updateDb();
            window.showToast("‚úÖ Settings Updated Successfully", "success");
            window.renderApp();
        };

        window.mergeCategories = async function () {
            const src = document.getElementById('merge-src').value;
            const tgt = document.getElementById('merge-target').value;
            if (!src || !tgt) { window.showToast("Please select both a source and target category.", "error"); return; }
            if (src === tgt) { window.showToast("Source and Target cannot be the same.", "error"); return; }

            window.showConfirm(
                "‚ö†Ô∏è MERGE CATEGORIES?",
                `This will move ALL transactions from '${src}' to '${tgt}'.\n\n'${src}' will be permanently deleted.`,
                async () => {
                    // 1. Update Transactions
                    let count = 0;
                    state.data.transactions.forEach(t => {
                        if (t.category === src) {
                            t.category = tgt;
                            count++;
                        }
                    });

                    // 2. Merge Budgets
                    if (state.data.budgets && state.data.budgets[src]) {
                        const srcB = state.data.budgets[src] || 0;
                        state.data.budgets[tgt] = (state.data.budgets[tgt] || 0) + srcB;
                        delete state.data.budgets[src];
                    }

                    // 3. Delete Category from List
                    state.data.expenseCategories = state.data.expenseCategories.filter(c => c !== src);
                    state.data.incomeCategories = state.data.incomeCategories.filter(c => c !== src); // Check both just in case

                    await updateDb();
                    window.showToast(`‚úÖ Merged ${count} transactions from '${src}' to '${tgt}'.`, "success");
                    window.renderSettingsUI(); // Refresh UI
                    window.renderApp();
                }
            );
        };

        window.resetData = async function () {
            window.showConfirm(
                "‚ö†Ô∏è DANGER ZONE ‚ö†Ô∏è",
                "This will permanently delete ALL accounts, transactions, and settings.\n\nAre you sure you want to reset everything?",
                async () => {
                    try {
                        // Reset to defaults
                        state.data = {
                            accounts: [],
                            transactions: [],
                            debts: [],
                            budgets: {},
                            settings: { rate: 22.75 },
                            incomeCategories: ['Salary', 'Bonus', 'Investment Return', 'Other'],
                            expenseCategories: ['Rent', 'Food', 'Utilities', 'Investment', 'Family', 'Other'],
                            assetTypes: ['Bank Account', 'Cash', 'Savings', 'Investment']
                        };

                        await updateDb();
                        window.showToast("System Reset Complete", "success");
                        setTimeout(() => window.location.reload(), 1000); // Force reload to ensure clean state
                    } catch (error) {
                        console.error("Reset failed:", error);
                        window.showToast("Reset failed: " + error.message, "error");
                    }
                }
            );
        };

        window.calcInstallment = function () {
            const amt = parseFloat(document.getElementById('da').value) || 0;
            const split = parseInt(document.getElementById('db-split').value) || 1;
            const el = document.getElementById('bnpl-preview');
            if (el) el.innerText = `Monthly: ${(amt / split).toFixed(2)}`;
        };

        window.toggleDebtFields = function () {
            const t = document.getElementById('dt').value;
            const isBnpl = t === 'bnpl';
            document.getElementById('bnpl-fields').classList.toggle('hidden', !isBnpl);
            if (isBnpl) window.calcInstallment();
        };

        // Helper to Calc DTI & Health
        window.renderFinancialHealth = function () {
            const r = state.data.settings.rate;
            // 1. Calc Monthly Fixed Debt Obligations
            let monthlyDebt = 0;
            // BNPLs (Monthly payments)
            state.data.debts.filter(d => d.isBnpl && !d.settled).forEach(d => {
                // Amortize remaining? Or just take next installment?
                // Let's take the first unpaid installment amount as "this month's load"
                const next = d.schedule.find(s => !s.paid);
                if (next) monthlyDebt += (parseFloat(next.amount) * (d.currency === 'AED' ? 1 : (1 / r)));
            });
            // Personal Debts due this month
            const now = new Date();
            const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            state.data.debts.filter(d => !d.isBnpl && d.type === 'payable' && !d.settled && new Date(d.repaymentDate) <= endOfMonth).forEach(d => {
                monthlyDebt += (parseFloat(d.amount) * (d.currency === 'AED' ? 1 : (1 / r)));
            });

            // 2. Calc Income (Avg 3 mo)
            // Reuse BNPL Analyzer logic or simple fallback
            const income = 15000; // Placeholder until we have robust income tracking. 
            // Or use Settings if available?
            // Let's rely on a hard-coded fallback or minimal settings for now to show UI.
            // Ideally we prompt user for "Monthly Income".

            const dti = income > 0 ? (monthlyDebt / income) * 100 : 0;

            let zone = 'Healthy';
            let color = 'emerald';
            if (dti > 30) { zone = 'Caution'; color = 'amber'; }
            if (dti > 50) { zone = 'Danger'; color = 'red'; }

            return `
                <div class="mb-6 bg-slate-900 rounded-[2.5rem] p-6 text-white relative overflow-hidden text-center shadow-lg">
                    <div class="relative z-10 flex justify-between items-center">
                        <div class="text-left">
                            <p class="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-1">Debt-to-Income Health</p>
                            <h2 class="text-2xl font-black text-${color}-400">${dti.toFixed(1)}% <span class="text-xs text-white opacity-60 font-sans font-bold">(${zone})</span></h2>
                            <p class="text-[9px] text-slate-500 font-bold mt-1">Monthly Obligations: AED ${Math.round(monthlyDebt).toLocaleString()}</p>
                        </div>
                        
                        <!-- Gauge Visual -->
                        <div class="w-16 h-16 relative">
                            <svg class="w-full h-full transform -rotate-90" viewBox="0 0 36 36">
                                <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#334155" stroke-width="4" />
                                <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="${color === 'emerald' ? '#34d399' : (color === 'amber' ? '#fbbf24' : '#f87171')}" stroke-width="4" stroke-dasharray="${dti}, 100" />
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <i data-lucide="${color === 'emerald' ? 'shield-check' : 'alert-triangle'}" class="w-6 h-6 text-${color}-400"></i>
                            </div>
                        </div>
                    </div>
                </div>
             `;
        };

        // Helper for Timeline
        window.renderPaymentTimeline = function (bnplOnly = false) {
            const upcoming = state.data.debts
                .filter(d => !d.settled && (d.type === 'payable' || d.isBnpl))
                .filter(d => !bnplOnly || d.isBnpl)
                .flatMap(d => {
                    if (d.isBnpl) {
                        return d.schedule.filter(s => !s.paid).map(s => ({
                            date: s.date || s.dueDate, // FIX: Support both schemas
                            name: d.party,
                            amount: s.amount,
                            currency: d.currency,
                            type: 'bnpl'
                        }));
                    } else {
                        return [{ date: d.repaymentDate, name: d.party, amount: d.amount, currency: d.currency, type: 'personal' }];
                    }
                })
                .filter(x => x.date && new Date(x.date) >= new Date().setHours(0, 0, 0, 0))
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .slice(0, 15); // Show more items

            if (upcoming.length === 0) return '';

            return `
                <div class="mb-8">
                    <h4 class="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-3 ml-2">Payment Timeline</h4>
                    <div class="flex gap-3 overflow-x-auto pb-4 snap-x hide-scrollbar">
                        ${upcoming.map(u => {
                const d = new Date(u.date);
                const day = d.getDate();
                const month = d.toLocaleString('default', { month: 'short' });
                return `
                                <div class="min-w-[100px] bg-white p-3 rounded-2xl border border-slate-100 shadow-sm snap-start flex-shrink-0 text-center relative overflow-hidden">
                                     <div class="absolute top-0 left-0 w-full h-1 ${u.type === 'bnpl' ? 'bg-indigo-500' : 'bg-rose-500'}"></div>
                                     <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">${month}</p>
                                     <h3 class="text-xl font-black text-slate-800 leading-none mb-1">${day}</h3>
                                     <p class="text-[9px] font-black text-slate-600 truncate w-full">${u.name}</p>
                                     <p class="text-[9px] font-bold text-slate-400 mt-1">${u.amount}</p>
                                </div>
                            `;
            }).join('')}
                    </div>
                </div>
            `;
        };

        // Window Exposure for toggles
        window.toggleBnplDetails = function (id) {
            document.getElementById(`bnpl-det-${id}`)?.classList.toggle('hidden');
        };

        window.togglePersonDetails = function (unsafeName) {
            // Encode/Decode to handle spaces/special chars in IDs safely
            // Simpler: use a comprehensive replace for valid ID
            const safeId = unsafeName.replace(/[^a-zA-Z0-9]/g, '_');
            const el = document.getElementById(`p-det-${safeId}`);
            if (el) {
                el.classList.toggle('hidden');
                // Rotate chevron if exists
                const chev = document.getElementById(`chev-${safeId}`);
                if (chev) chev.classList.toggle('rotate-180');
            }
        };

        window.settleInstallment = function (dId, idx) {
            const d = state.data.debts.find(x => x.id === dId);
            if (!d || !d.schedule[idx] || d.schedule[idx].status === 'paid') return;

            window.showConfirm("Pay Installment?", `Settle AED ${d.schedule[idx].amount} now? (Deducts from Main Bank)`, async () => {
                const acc = state.data.accounts.find(a => a.type === 'Bank Account') || state.data.accounts[0];
                if (acc) {
                    acc.balance -= parseFloat(d.schedule[idx].amount);
                    state.data.transactions.push({
                        id: window.genId(), accountId: acc.id, amount: d.schedule[idx].amount,
                        type: 'expense', category: 'BNPL Repayment',
                        note: `Paid ${d.party} (${idx + 1}/${d.installments})`,
                        debtId: dId, // Link to Debt
                        date: new Date().toISOString()
                    });
                }
                d.schedule[idx].status = 'paid';
                d.schedule[idx].paidDate = new Date().toISOString();
                d.paidMonths = (d.paidMonths || 0) + 1;

                if (d.paidMonths >= d.installments) d.settled = true;

                await updateDb();
                window.renderDebtUI();
                window.renderApp();
            }, "Confirm Payment");
        };




        window.calcTrustScore = function (name) {
            let score = 100;
            // Heuristics can continue here
            return Math.max(0, Math.min(100, score));
        };

        // WHATSAPP INTEGRATION
        // UNIVERSAL MESSAGING HANDLER
        window.sendWhapiReminder = async function (name, debtDetails, isRaw = false) {
            const isAuto = state.data.settings.isAutoMessagingEnabled;
            const token = state.data.settings.messagingToken || state.data.settings.whapiToken;
            const msgBody = isRaw ? debtDetails : `Hi ${name}, just a quick reminder regarding the ${debtDetails}. Let me know when you can settle this. Thanks!`;

            // Get Contact & Phone
            const contact = (state.data.contacts && state.data.contacts.find(c => c.name === name));
            if (!contact || !contact.phone) {
                window.showPrompt(`Phone for ${name}`, "Enter Mobile Number (e.g. 97150...):", (val) => {
                    if (val) {
                        if (!state.data.contacts) state.data.contacts = [];
                        let c = state.data.contacts.find(x => x.name === name);
                        if (!c) { c = { name: name, relation: 'Friend', phone: val }; state.data.contacts.push(c); }
                        else { c.phone = val; }
                        updateDb();
                        window.sendWhapiReminder(name, debtDetails, isRaw); // Retry
                    }
                }, 'tel');
                return;
            }

            const cleanPhone = contact.phone.replace(/[^0-9]/g, '');

            if (isAuto && token) {
                // AUTO MODE: Send via API
                window.showToast("üöÄ Sending via API...", "info");
                try {
                    const res = await fetch('https://gate.whapi.cloud/messages/text', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ to: cleanPhone, body: msgBody })
                    });
                    if (res.ok) window.showToast("Message Sent! ‚úÖ", "success");
                    else window.showToast("API Error. Check Settings.", "error");
                } catch (error) {
                    window.showToast("Network Error.", "error");
                }
            } else {
                // MANUAL MODE: Open WhatsApp Draft
                window.showToast("üì≤ Opening WhatsApp Draft...", "info");
                const url = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(msgBody)}`;
                window.open(url, '_blank');
            }
        };

        // DAILY AUTOMATION LOGIC (Self + Peer)
        window.checkSelfReminders = async function () {
            // 1. Check prerequisites
            if (!state.data.settings.isAutoMessagingEnabled) return;
            const token = state.data.settings.messagingToken || state.data.settings.whapiToken;
            if (!token) return;

            // 2. Check frequency (Once per day)
            const todayStr = new Date().toISOString().split('T')[0];
            if (state.data.settings.lastAutoReminderDate === todayStr) return;

            window.showToast("üîî Checking daily automations...", "info");
            let sentCountSelf = 0;
            let sentCountPeer = 0;

            try {
                // --- A. SELF REMINDERS (Due Today) ---
                const myPhone = state.data.settings.myPhone;
                if (myPhone) {
                    let dueItems = [];

                    // 1. BNPL Installments (Due Today)
                    state.data.debts.filter(d => d.isBnpl && !d.settled).forEach(d => {
                        const installment = d.schedule.find(s => !s.paid && (s.date === todayStr || s.dueDate === todayStr));
                        if (installment) dueItems.push({ type: 'BNPL', name: d.party, amount: installment.amount, currency: d.currency });
                    });

                    // 2. Personal Payables (Due Today)
                    state.data.debts.filter(d => !d.isBnpl && d.type === 'payable' && !d.settled).forEach(d => {
                        if (d.repaymentDate === todayStr) dueItems.push({ type: 'Debt', name: d.party, amount: d.amount, currency: d.currency });
                    });

                    if (dueItems.length > 0) {
                        const summary = dueItems.map(i => `‚Ä¢ ${i.type} to ${i.name}: ${i.amount} ${i.currency}`).join('\\n');
                        const msgBody = `üìÖ *Payment Reminder: Due Today* (${todayStr})\\n\\n${summary}\\n\\nCheck Finshaanire for details.`;
                        const cleanPhone = myPhone.replace(/[^0-9]/g, '');

                        try {
                            await fetch('https://gate.whapi.cloud/messages/text', {
                                method: 'POST',
                                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                                body: JSON.stringify({ to: cleanPhone, body: msgBody })
                            });
                            sentCountSelf++;
                        } catch (e) {
                            console.error("Self Reminder Fetch Error", e);
                        }
                    }
                }

                // --- B. PEER REMINDERS (Due Today) ---
                // Receivables owed TO user
                const peerDebts = state.data.debts.filter(d => !d.isBnpl && d.type === 'receivable' && !d.settled && d.repaymentDate === todayStr);

                for (const d of peerDebts) {
                    const contact = state.data.contacts.find(c => c.name === d.party);
                    if (contact && contact.phone) {
                        const cleanPhone = contact.phone.replace(/[^0-9]/g, '');
                        // Check if reminder already sent today (per item check)
                        if (d.lastAutoRemindDate === todayStr) continue;

                        const msgBody = `Hi ${d.party}, friendly reminder that ${d.amount} ${d.currency} is due today (${todayStr}). Please let me know the status. Thanks!`;

                        try {
                            const res = await fetch('https://gate.whapi.cloud/messages/text', {
                                method: 'POST',
                                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                                body: JSON.stringify({ to: cleanPhone, body: msgBody })
                            });

                            if (res.ok) {
                                sentCountPeer++;
                                // Update item state to prevent duplicate if job re-runs
                                d.lastAutoRemindDate = todayStr;
                            }
                        } catch (e) {
                            console.error("Peer Reminder Fetch Error", e);
                        }
                    }
                }

                // --- C. SUBSCRIPTION TRIALS (Ending Soon) ---
                if (state.data.subscriptions) {
                    const trials = state.data.subscriptions.filter(s => s.freeTrialEndDate);
                    if (state.data.settings.myPhone && trials.length > 0) {
                        const endingSoon = trials.filter(s => {
                            const end = new Date(s.freeTrialEndDate);
                            const now = new Date();
                            const diff = (end - now) / (1000 * 60 * 60 * 24);
                            return diff >= 0 && diff <= 3;
                        });

                        if (endingSoon.length > 0) {
                            const summary = endingSoon.map(s => `‚Ä¢ ${s.name} (Ends: ${s.freeTrialEndDate})`).join('\\n');
                            const msgBody = `‚ö†Ô∏è *Free Trial Alert*\\n\\nThe following trials are ending soon:\\n${summary}\\n\\nCancel now if unwanted!`;
                            const cleanPhone = state.data.settings.myPhone.replace(/[^0-9]/g, '');

                            try {
                                await fetch('https://gate.whapi.cloud/messages/text', {
                                    method: 'POST',
                                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ to: cleanPhone, body: msgBody })
                                });
                                sentCountSelf++;
                            } catch (e) {
                                console.error("Trial Reminder Fetch Error", e);
                            }
                        }
                    }
                }

                // 5. Update Global State
                state.data.settings.lastAutoReminderDate = todayStr;
                await updateDb();

                if (sentCountSelf > 0 || sentCountPeer > 0) {
                    window.showToast(`üîî Sent ${sentCountSelf} self & ${sentCountPeer} peer reminders!`, "success");
                } else {
                    console.log("No reminders needed today.");
                }

            } catch (e) {
                console.error("Automation Critical Error", e);
            }
        };


        window.openWhatsApp = function (name, amount, currency) {
            // Deprecated manual fallback if needed, or alias to new one? 
            // Keeping for legacy or manual override if we want double buttons.
            // For now, the UI will call sendWhapiReminder
            const contact = (state.data.contacts && state.data.contacts.find(c => c.name === name));
            let phone = contact ? contact.phone : null;

            const send = (p) => {
                // Update phone if not saved
                if (contact && !contact.phone) {
                    contact.phone = p;
                    updateDb();
                }
                const msg = `Hi ${name}, just a quick reminder regarding the ${amount} ${currency}. Let me know when you can settle this. Thanks!`;
                window.open(`https://wa.me/${p.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(msg)}`, '_blank');
            };

            if (phone) {
                send(phone);
            } else {
                window.showPrompt("Enter Mobile Number", "e.g. 971501234567", (val) => {
                    if (val) send(val);
                }, 'tel');
            }
        };

        // FRIEND LEDGER
        window.openFriendLedger = function (name) {
            const history = state.data.debts.filter(d => d.party === name).sort((a, b) => new Date(b.date) - new Date(a.date));
            const contact = (state.data.contacts && state.data.contacts.find(c => c.name === name)) || { relation: 'Friend', creditScore: 100 };

            const t = document.getElementById('modal-title');
            const c = document.getElementById('modal-content');
            const b = document.getElementById('modal-backdrop');

            t.innerText = `${name}'s Ledger`;
            c.innerHTML = `
                <div class="space-y-6">
                     <div class="flex justify-between items-center bg-slate-50 p-6 rounded-3xl border border-slate-100">
                         <div>
                             <p class="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-1">Relationship</p>
                             <p class="text-xl font-black text-slate-800">${contact.relation || 'Contact'}</p>
                         </div>
                         <div class="text-right">
                             <p class="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-1">Lifetime Score</p>
                             <p class="text-xl font-black text-indigo-500">${window.calcTrustScore(name)}%</p>
                         </div>
                     </div>
                     
                     <div class="space-y-3">
                         ${history.length > 0 ? history.map(d => `
                             <div class="bg-white p-4 rounded-2xl border border-slate-100 flex justify-between items-center ${d.settled ? 'opacity-60' : ''}">
                                 <div class="text-left">
                                     <p class="font-bold text-sm text-slate-800 flex items-center gap-2">
                                        ${d.type === 'receivable' ? 'Lent' : 'Borrowed'}
                                        ${d.settled ? '<span class="text-[8px] bg-emerald-100 text-emerald-600 px-1.5 py-0.5 rounded font-black uppercase">Settled</span>' : ''}
                                     </p>
                                     <p class="text-[10px] text-slate-400 font-bold uppercase">${d.repaymentDate || d.date ? (d.date || '').split('T')[0] : 'No Date'}</p>
                                 </div>
                                 <div class="text-right">
                                     <p class="font-black text-slate-900">${d.amount} ${d.currency}</p>
                                 </div>
                             </div>
                         `).join('') : '<p class="text-center text-slate-300 font-bold py-10">No records found.</p>'}
                     </div>
                </div>
            `;
            b.classList.replace('hidden', 'flex');
            lucide.createIcons();
        };

        // new Action Required Logic
        window.renderActionRequired = function () {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // User Filter: "Show only amount which is due for TODAY"
            const todayStr = today.toDateString();

            const actions = [];

            // 1. BNPL Installments
            state.data.debts.filter(d => d.isBnpl && !d.settled).forEach(d => {
                const pending = d.schedule.find(s => !s.paid);
                if (pending) {
                    // Check date or dueDate
                    const dStr = pending.date ? new Date(pending.date).toDateString() : (pending.dueDate ? new Date(pending.dueDate).toDateString() : '');
                    if (dStr === todayStr) {
                        actions.push({
                            type: 'BNPL',
                            name: d.party,
                            amount: pending.amount,
                            currency: d.currency,
                            date: 'TODAY',
                            id: d.id,
                            idx: d.schedule.indexOf(pending),
                            isBnpl: true
                        });
                    }
                }
            });

            // 2. Personal Debts (Modified for 1-Day Advance Notice)
            state.data.debts.filter(d => !d.isBnpl && d.type === 'payable' && !d.settled).forEach(d => {
                const dDate = new Date(d.repaymentDate);
                const dStr = dDate.toDateString();

                // Calculate Tomorrow
                const uniqueTomorrow = new Date();
                uniqueTomorrow.setDate(uniqueTomorrow.getDate() + 1);
                const tomorrowStr = uniqueTomorrow.toDateString();

                if (dStr === tomorrowStr || dStr === todayStr) {
                    const label = dStr === todayStr ? 'TODAY' : 'TOMORROW';
                    actions.push({ type: 'Debt', name: d.party, amount: d.amount, currency: d.currency, date: label, id: d.id, isBnpl: false });
                }
            });

            if (actions.length === 0) return '';

            return `<div class="bg-rose-50 p-6 rounded-[2.5rem] border border-rose-100 mb-8 shadow-sm text-left">
                <div class="flex items-center gap-2 mb-4">
                    <i data-lucide="siren" class="w-5 h-5 text-rose-500 animate-pulse"></i>
                    <h4 class="text-[10px] font-black uppercase text-rose-400 tracking-widest">Action Required</h4>
                </div>
                <div class="space-y-3">
                    ${actions.map(a => `
                        <div class="bg-white p-4 rounded-2xl border border-rose-100 flex justify-between items-center shadow-sm">
                            <div>
                                <p class="text-[9px] font-bold text-rose-400 uppercase mb-0.5">${a.type} ‚Ä¢ Due ${a.date}</p>
                                <p class="font-black text-slate-800 text-sm">${a.name}</p>
                                <p class="text-xs font-bold text-slate-500">${a.amount} ${a.currency}</p>
                            </div>
                            <div>
                                ${a.isBnpl ?
                    `<button onclick="window.settleInstallment('${a.id}', ${a.idx})" class="px-3 py-1.5 bg-rose-500 text-white rounded-lg font-black text-[10px] uppercase shadow-md active:scale-95">Settle</button>` :
                    `<button onclick="window.openSettleFlow('${a.id}')" class="px-3 py-1.5 bg-rose-500 text-white rounded-lg font-black text-[10px] uppercase shadow-md active:scale-95">Pay</button>`
                }
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>`;
        };

        // --- BNPL HELPER: Pay Split ---
        window.payBnplSplit = async function (id, idx) {
            const d = state.data.debts.find(x => x.id === id);
            if (!d || !d.schedule[idx] || d.schedule[idx].paid) return;

            const inst = d.schedule[idx];
            const amt = parseFloat(inst.amount);

            // 1. Prepare Account Options
            const accounts = state.data.accounts.filter(a => ['Bank Account', 'Cash', 'Wallet'].includes(a.type));
            if (accounts.length === 0) {
                window.showToast("No payment accounts found!", "error");
                return;
            }

            let msg = `Pay AED ${amt} for ${d.party} (Month ${idx + 1}/${d.installments})?\n\nSelect Payment Method:\n`;
            accounts.forEach((a, i) => {
                msg += `${i + 1}. ${a.name} (${a.currency} ${window.toCurrency(a.balance)})\n`;
            });
            msg += `\nEnter number (1-${accounts.length}):`;

            // 2. Prompt for Selection
            window.showPrompt("Confirm Payment", msg, async (val) => {
                const choice = parseInt(val) - 1;
                const acc = accounts[choice];

                if (!acc) {
                    window.showToast("Invalid selection. Payment cancelled.", "error");
                    return;
                }

                // 3. Process Payment
                inst.paid = true;
                d.currentAmount -= amt;
                if (d.currentAmount < 0.1) { d.currentAmount = 0; d.settled = true; }

                // 4. Update Balance & Log
                acc.balance -= (acc.currency === 'AED' ? amt : amt / state.data.settings.rate); // Simple conversion if needed

                window.saveTransaction({
                    id: window.genId(), accountId: acc.id,
                    type: 'expense', amount: amt, category: 'BNPL Payment',
                    note: `Paid ${d.party} - Installment ${idx + 1}/${d.installments}`,
                    date: new Date().toISOString()
                });

                await window.updateDb();
                window.renderApp();

                // Instant UI Update for Modal
                const modalContent = document.getElementById('modal-content');
                if (modalContent && !document.getElementById('modal-backdrop').classList.contains('hidden')) {
                    modalContent.innerHTML = window.renderDebtUI();
                    lucide.createIcons();
                }

                window.showToast(`Paid via ${acc.name}!`, "success");
            }, "1"); // Default to 1
        };

        window.renderDebtUI = function () {
            // 1. Split Data
            const bnpl = state.data.debts.filter(d => !d.settled && (d.subtype === 'bnpl' || d.isBnpl));
            const personal = state.data.debts.filter(d => !d.settled && d.subtype !== 'bnpl' && !d.isBnpl);

            // 2. Render BNPL (Active Installments) - Granular & Corrected
            // 2. Render BNPL (Active Installments) - Enhanced Card UI
            const renderBnplItem = (d) => {
                const nextDue = d.schedule.find(s => !s.paid);
                const nextDate = nextDue ? (nextDue.date || nextDue.dueDate) : 'Settled';
                const progress = ((d.originalAmount - d.currentAmount) / d.originalAmount) * 100;
                const safeId = d.id;

                // Notification Logic
                const now = new Date();
                const isDueSoon = nextDue && (new Date(nextDate) - now) / (1000 * 60 * 60 * 24) < 3;

                return `<div class="bg-white rounded-[2.5rem] border border-slate-100 shadow-sm relative overflow-hidden group mb-4 transition-all hover:shadow-md cursor-pointer" onclick="document.getElementById('bnpl-det-${safeId}').classList.toggle('hidden')">
                     
                     <!-- Header -->
                     <div class="flex justify-between items-center p-5 bg-white z-10 relative">
                        <div class="flex items-center gap-3">
                            <div class="relative">
                                <div class="w-10 h-10 rounded-2xl bg-indigo-50 flex items-center justify-center text-indigo-400 shadow-inner">
                                     <i data-lucide="shopping-bag" class="w-5 h-5"></i>
                                </div>
                                ${isDueSoon ? `<div class="absolute -top-1 -right-1 w-3 h-3 bg-rose-500 rounded-full border-2 border-white animate-pulse"></div>` : ''}
                            </div>
                            <div>
                                <h3 class="font-black text-slate-800 text-sm">${d.party}</h3>
                                <p class="text-[9px] text-slate-400 font-bold uppercase">Next: ${nextDate}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="text-right bg-indigo-50 px-2 py-1.5 rounded-lg border border-indigo-100">
                                <p class="text-[7px] font-black uppercase text-indigo-400 mb-0.5">${d.currency}</p>
                                <p class="font-black text-sm text-indigo-600 num-font">${Math.round(d.currentAmount).toLocaleString()}</p>
                            </div>
                            <i data-lucide="chevron-down" class="w-4 h-4 text-slate-300 transition-transform duration-300"></i>
                        </div>
                     </div>

                     <div class="px-5 pb-3">
                          <div class="w-full bg-slate-100 rounded-full h-1.5 relative overflow-hidden">
                               <div class="bg-indigo-500 h-full rounded-full transition-all duration-1000" style="width: ${progress}%"></div>
                          </div>
                     </div>

                     <!-- Collapsible Details -->
                     <div id="bnpl-det-${safeId}" class="hidden bg-slate-50 border-t border-slate-100 p-4 space-y-2 cursor-auto" onclick="event.stopPropagation()">
                          <p class="text-[8px] font-black uppercase text-slate-300 tracking-widest mb-2">Payment Plan</p>
                          ${d.schedule.map((s, idx) => `
                              <div class="flex justify-between items-center bg-white p-3 rounded-xl border border-slate-100 ${s.paid ? 'opacity-50' : ''}">
                                   <div class="flex items-center gap-3">
                                       <div class="w-6 h-6 rounded-full ${s.paid ? 'bg-emerald-100 text-emerald-500' : 'bg-slate-100 text-slate-400'} flex items-center justify-center text-[10px] font-black">
                                           ${idx + 1}
                                       </div>
                                       <div>
                                           <p class="text-[10px] font-bold text-slate-700">${s.paid ? 'Paid' : (s.date || s.dueDate || 'Pending')}</p>
                                           <p class="text-[9px] font-black text-slate-300 uppercase">${s.paid ? 'Completed' : 'Pending'}</p>
                                       </div>
                                   </div>
                                   <div class="flex items-center gap-2">
                                        <span class="font-black text-xs text-slate-700">${s.amount}</span>
                                        ${!s.paid ?
                        `<button onclick="window.openBnplSettleModal('${d.id}', ${idx})" class="w-8 h-8 flex items-center justify-center bg-slate-900 text-white rounded-full hover:bg-emerald-500 transition-colors shadow-md active:scale-95">
                                            <i data-lucide="banknote" class="w-4 h-4"></i>
                                        </button>`
                        :
                        `<i data-lucide="check-circle-2" class="w-4 h-4 text-emerald-400"></i>`
                    }
                                   </div>
                              </div>
                          `).join('')}
                     </div>
                </div>`;
            };

            // NEW: Full Modal for BNPL Payment
            // Moved global definitions to window scope (see below)

            // 3. Render People (Grouped)
            const people = {};
            // Helper to aggregate based on currency
            personal.forEach(d => {
                const p = d.party;
                if (!people[p]) people[p] = { name: p, totals: {}, items: [], trust: window.calcTrustScore(p), virtualNet: 0 };

                // Init currency bucket if needed
                if (!people[p].totals[d.currency]) people[p].totals[d.currency] = 0;

                let v = parseFloat(d.amount);

                // Add to specific currency bucket
                if (d.type === 'payable') people[p].totals[d.currency] -= v;
                else people[p].totals[d.currency] += v;

                // Virtual Net (For Sorting Only)
                // Convert to Base (AED) for simple weight sorting
                const r = state.data.settings.rate;
                const vInAed = d.currency === 'AED' ? v : v / r;
                if (d.type === 'payable') people[p].virtualNet -= vInAed;
                else people[p].virtualNet += vInAed;

                people[p].items.push(d);
            });

            // Sort by Virtual Net (Debtors First)
            const sortedPeople = Object.values(people).sort((a, b) => a.virtualNet - b.virtualNet);

            const renderHistory = (debtId) => {
                const txs = state.data.transactions.filter(t => t.debtId === debtId).sort((a, b) => new Date(b.date) - new Date(a.date));
                if (txs.length === 0) return '';
                return `
                    <div class="mt-3 bg-slate-50 rounded-xl p-3 border border-slate-100">
                    <p class="text-[8px] font-bold text-slate-400 uppercase mb-2">Payment History</p>
                    <div class="space-y-1">
                        ${txs.map(t => `
                            <div class="flex justify-between items-center text-[9px]">
                                <span class="text-slate-500">${new Date(t.date).toLocaleDateString()}</span>
                                <span class="font-bold text-slate-700">${t.amount}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            };

            const renderPerson = (p) => {
                const stars = "‚≠ê".repeat(Math.round(p.trust / 20));
                const safeId = p.name.replace(/[^a-zA-Z0-9]/g, '_');

                // Net Status
                // Net Status
                const isNetOwe = p.virtualNet < -1.0;
                const isSettled = Math.abs(p.virtualNet) < 20.0;
                const netLabel = isNetOwe ? "You Owe" : (isSettled ? "Settled" : "Owes You");
                const netColor = isNetOwe ? "text-rose-500" : (isSettled ? "text-slate-400" : "text-emerald-500");

                // Dominant Currency Logic
                const activeCurrencies = Object.entries(p.totals).filter(([c, v]) => Math.abs(v) > 1.0);
                let displayAmount = Math.abs(p.virtualNet); // Default Base
                let displayCurrency = 'AED';

                if (activeCurrencies.length === 1) {
                    displayCurrency = activeCurrencies[0][0];
                    displayAmount = Math.abs(activeCurrencies[0][1]);
                }

                // Append Currency to Display
                const finalDisplay = `${displayAmount.toLocaleString()} <span class="text-[9px] font-bold">${displayCurrency}</span>`;

                // Notification Logic: Check if any item is due within 3 days or overdue
                const now = new Date();
                const dueSoon = p.items.some(d => {
                    if (!d.repaymentDate) return false;
                    const diff = new Date(d.repaymentDate) - now;
                    const diffDays = diff / (1000 * 60 * 60 * 24);
                    return diffDays < 3 && !d.settled;
                });

                // Generate Badges for each Currency (Resized)
                const badges = Object.keys(p.totals).map(curr => {
                    const val = p.totals[curr];
                    if (Math.round(val) === 0) return '';

                    const isOwe = val < 0;
                    const absVal = Math.abs(val);
                    const color = isOwe ? 'rose' : 'emerald';

                    return `
                    <div class="text-right bg-${color}-50 px-2 py-1.5 rounded-lg border border-${color}-100">
                             <p class="text-[7px] font-black uppercase text-${color}-400 mb-0.5">${curr}</p>
                             <p class="font-black text-sm text-${color}-600 num-font">${Math.round(absVal).toLocaleString()}</p>
                        </div>
                    `;
                }).join('');

                const debtSummary = Object.entries(p.totals)
                    .filter(([c, v]) => Math.round(v) !== 0)
                    .map(([c, v]) => `${Math.round(Math.abs(v))} ${c}`)
                    .join(' + ');

                // Aggregate Notes
                const uniqNotes = [...new Set(p.items.map(d => d.notes).filter(n => n))].join(', ');
                const finalSummary = debtSummary + (uniqNotes ? ` (Purpose: ${uniqNotes})` : '');

                return `<div class="bg-white rounded-[2.5rem] border border-slate-100 shadow-sm relative overflow-hidden group mb-4 transition-all hover:shadow-md cursor-pointer" onclick="window.togglePersonDetails('${p.name}')">
                    <!--Header -->
                    <div class="flex justify-between items-center p-5 bg-white z-10 relative">
                        <div class="flex items-center gap-3">
                            <div class="relative">
                                <div class="w-10 h-10 rounded-2xl bg-slate-50 flex items-center justify-center text-lg font-black text-slate-300 shadow-inner">
                                    ${p.name.charAt(0).toUpperCase()}
                                </div>
                                ${dueSoon ? `<div class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-white animate-pulse"></div>` : ''}
                            </div>
                            
                            <div class="text-left">
                                <h3 class="font-black text-slate-800 text-sm leading-none flex items-center gap-2">
                                    ${p.name} 
                                </h3>
                                <div class="flex items-center gap-2 mt-1">
                                <p class="text-xs font-bold ${netColor} mr-2">Net: ${netLabel} ${!isSettled ? ` ${finalDisplay}` : ''}</p>
                                <span class="text-[8px] px-1.5 py-0.5 bg-slate-100 rounded-full text-slate-400 font-bold tracking-widest">TRUST ${Math.round(p.trust)}%</span>
                                    ${(state.data.contacts.find(c => c.name === p.name)?.phone) ? '<i data-lucide="phone" class="w-3 h-3 text-emerald-400"></i>' : ''}
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="flex flex-col gap-1.5">
                                ${badges || `<span class="px-2 py-1 bg-slate-100 text-slate-400 rounded-lg text-[8px] font-bold uppercase">Settled</span>`}
                            </div>
                            
                            ${dueSoon ? `<i data-lucide="bell-ring" class="w-5 h-5 text-red-500 animate-bounce"></i>` :
                        `<i id="chev-${safeId}" data-lucide="chevron-down" class="w-4 h-4 text-slate-300 transition-transform duration-300"></i>`
                    }
                        </div>
                    </div>
                    
                    <!--Collapsible Details-->
                <div id="p-det-${safeId}" class="hidden cursor-auto border-t border-slate-50 p-6 bg-slate-50/30" onclick="event.stopPropagation()">
                    <!-- Ledger Preview -->
                    <div class="space-y-1 bg-white rounded-2xl p-2 border border-slate-100 mb-4">
                        ${p.items.map(d => {
                        // Progress Calculation (Feature 2)
                        let progress = 0;
                        if (d.originalAmount && d.originalAmount > 0) {
                            progress = ((d.originalAmount - d.amount) / d.originalAmount) * 100;
                        }

                        return `
                                <div class="p-2 rounded-xl border-b border-slate-50 last:border-0 hover:bg-slate-50 transition-colors">
                                    <div class="flex justify-between items-center mb-1">
                                        <div class="text-left flex items-center gap-2">
                                            <div class="w-1 h-8 rounded-full ${d.type === 'receivable' ? 'bg-emerald-400' : 'bg-rose-400'}"></div>
                                            <div>
                                                <p class="text-[10px] font-black text-slate-700 uppercase">${d.type === 'receivable' ? 'Lent' : 'Borrowed'}</p>
                                                <p class="text-[9px] text-slate-400 uppercase font-bold">Due ${d.repaymentDate || 'N/A'}</p>
                                                ${d.notes ? `<p class="text-[9px] text-indigo-400 italic font-bold">"${d.notes}"</p>` : ''}
                                            </div>
                                        </div>
                                            <div class="text-right flex items-center gap-2">
                                            
                                            <!-- WRITE OFF BUTTON -->
                                            <button onclick="event.stopPropagation(); window.writeOffDebt('${d.id}')" title="Write Off / Forgive (No Money Deducted)" class="w-8 h-8 flex items-center justify-center bg-slate-100 text-slate-400 border border-slate-200 rounded-full hover:bg-rose-50 hover:text-rose-500 hover:border-rose-200 transition-all shadow-sm transform active:scale-95">
                                                <i data-lucide="eraser" class="w-4 h-4"></i>
                                            </button>

                                            <div>
                                                <p class="font-black text-sm ${d.type === 'receivable' ? 'text-emerald-500' : 'text-rose-500'}">${d.amount} ${d.currency}</p>
                                            </div>
                                            ${d.type === 'payable' ?
                                `<button onclick="event.stopPropagation(); window.openSettleFlow('${d.id}')" title="Pay Now" class="w-8 h-8 flex items-center justify-center bg-slate-900 text-white rounded-full hover:bg-emerald-500 transition-colors shadow-md transform active:scale-95">
                                    <i data-lucide="banknote" class="w-4 h-4"></i>
                                </button>` :
                                `<button onclick="event.stopPropagation(); window.openSettleFlow('${d.id}')" title="Mark Received" class="w-8 h-8 flex items-center justify-center bg-white text-emerald-500 border border-emerald-200 rounded-full hover:bg-emerald-500 hover:text-white transition-all shadow-sm transform active:scale-95">
                                    <i data-lucide="check" class="w-4 h-4"></i>
                                </button>`
                            }
                                        </div>
                                    </div>
                                    
                                    ${progress > 0 ? `
                                        <div class="w-full bg-slate-100 rounded-full h-1.5 mt-1 relative overflow-hidden">
                                            <div class="bg-emerald-400 h-full rounded-full" style="width: ${progress}%"></div>
                                        </div>
                                        <p class="text-[8px] text-emerald-600 font-bold mt-0.5 text-right">${Math.round(progress)}% Paid off</p>
                                    ` : ''}
                                    
                                    <!-- HISTORY INJECT -->
                                    ${renderHistory(d.id)}
                                </div>
                            `}).join('')}
                    </div>

                    <!-- Actions -->
                    <div class="flex justify-between items-center">
                        <button onclick="window.openFriendLedger('${p.name}')" class="text-xs font-bold text-slate-400 hover:text-indigo-600 flex items-center gap-1"><i data-lucide="history" class="w-3 h-3"></i> Full History</button>
                        <button onclick="window.sendWhapiReminder('${p.name}', '${finalSummary}')" class="px-4 py-2 bg-indigo-50 text-[10px] font-black uppercase text-indigo-600 hover:text-white hover:bg-indigo-500 rounded-xl transition-all flex items-center gap-2">
                            <i data-lucide="zap" class="w-3 h-3"></i> Auto-Remind
                        </button>
                    </div>
                </div>
                </div>`;
            };

            // --- WRITE OFF LOGIC ---
            window.writeOffDebt = function (id) {
                const d = state.data.debts.find(x => x.id === id);
                if (!d) return;

                window.showConfirm(
                    "Write Off Debt?",
                    `Mark ${d.amount} ${d.currency} as settled WITHOUT any payment? (Use for bad debts or corrections)`,
                    async () => {
                        d.settled = true;
                        d.notes = (d.notes || '') + " [Written Off]";
                        // No transaction created.
                        await updateDb();
                        window.renderDebtUI();
                        window.showToast("Debt Written Off (Archived)", "success");
                    },
                    "Write Off"
                );
            };

            // Split Logic
            const iOwe = sortedPeople.filter(p => p.virtualNet < -0.1);
            const owesMe = sortedPeople.filter(p => p.virtualNet >= -0.1); // Fix: Include 0 (Settled/Balanced)

            // STATE MANAGEMENT FOR TABS
            // Default to 'home' if not set
            if (!state.ui) state.ui = {};
            if (!state.ui.debtView) state.ui.debtView = 'home';

            const goHome = () => {
                state.ui.debtView = 'home';
                const html = window.renderDebtUI();
                const c = document.getElementById('modal-content');
                if (c) { c.innerHTML = html; lucide.createIcons(); }
            };
            const goView = (v) => {
                state.ui.debtView = v;
                const html = window.renderDebtUI();
                const c = document.getElementById('modal-content');
                if (c) { c.innerHTML = html; lucide.createIcons(); }
            };
            window.navDebt = goView; // Exposure for onclick
            window.navDebtHome = goHome;

            // --- MAIN DASHBOARD (HOME) ---
            if (state.ui.debtView === 'home') {
                return `<div class="max-w-2xl mx-auto space-y-8 text-center">
                    
                <!--NEW: DTI HEALTH GAUGE(Feature 5)-->
                ${window.renderFinancialHealth()}

                <!--ADD DEBT FORM-->
                <div class="bg-slate-50 p-8 rounded-[2.5rem] border border-slate-100 space-y-4 shadow-sm text-center">
                    <div class="grid grid-cols-2 gap-3">
                        <select id="dt" onchange="window.toggleDebtFields()" class="p-3 border rounded-xl font-bold bg-white text-xs text-center">
                            <option value="payable">I Owe (Personal)</option>
                            <option value="bnpl">BNPL (Tabby/Tamara)</option>
                            <option value="receivable">Owed to me (Asset)</option>
                        </select>
                        <div id="debt-party-container" class="flex gap-2">
                            <select id="dw" class="w-full p-3 border rounded-xl font-bold text-xs text-center bg-white">
                                <option value="">-- Select Person --</option>
                                ${(state.data.contacts || []).map(c => `<option value="${c.name}">${c.name}</option>`).join('')}
                            </select>
                            <button onclick="window.openContactModal()" class="p-3 bg-indigo-50 text-indigo-500 rounded-xl hover:bg-indigo-100 transition-colors" title="Add New Contact"><i data-lucide="user-plus" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 text-center">
                        <select id="dc" class="p-3 border rounded-xl font-bold bg-white text-xs text-center"><option value="AED">AED</option><option value="INR">INR</option></select>
                        <input type="number" id="da" placeholder="Amount" oninput="window.calcInstallment()" class="p-3 border rounded-xl font-black text-xs text-center">
                    </div>

                    <input type="text" id="dn" placeholder="Purpose / Note (Optional)" class="w-full p-3 border rounded-xl font-bold text-center text-xs">

                        <div id="bnpl-fields" class="hidden space-y-3 bg-indigo-50 p-3 rounded-xl border border-indigo-100">
                            <input type="text" id="bnpl-product" placeholder="Product / Service Name" class="w-full p-2 border rounded-lg font-bold text-center text-xs outline-none">
                                <div class="grid grid-cols-2 gap-3 items-center">
                                    <div class="text-left">
                                        <p class="text-[8px] font-black uppercase text-indigo-300 mb-1">Split (Months)</p>
                                        <input type="number" id="db-split" value="4" oninput="window.calcInstallment()" class="w-full p-2 border rounded-lg font-black text-center text-indigo-600 text-xs">
                                    </div>
                                    <div class="text-right">
                                        <p class="text-[8px] font-black uppercase text-indigo-300 mb-1">Per Month</p>
                                        <p id="bnpl-preview" class="text-sm font-black text-indigo-600 num-font">Wait...</p>
                                    </div>
                                </div>
                        </div>

                        <div class="bg-white p-3 rounded-xl border border-slate-100">
                            <p class="text-[8px] font-black uppercase text-slate-400 mb-1">Linked Account (Optional)</p>
                            <select id="ds" class="w-full p-2 border rounded-lg font-bold bg-slate-50 text-[10px] text-center">
                                <option value="">-- No Balance Adjustment --</option>
                                ${state.data.accounts.map(a => `<option value="${a.id}">${a.name} (${a.currency})</option>`).join('')}
                            </select>
                        </div>

                        <input type="date" id="drd" class="w-full p-3 border rounded-xl font-bold text-center text-xs">
                            <button id="btn-commit-debt" onclick="window.commitDebt()" class="w-full bg-amber-500 text-white p-3 rounded-xl font-black uppercase text-xs shadow-lg active:scale-95 transition-transform">Commit Record</button>
                        </div>

                        <!-- NEW: PAYMENT TIMELINE (Feature 3) -->
                        ${window.renderPaymentTimeline()}

                        <!-- GRID NAVIGATION MENU -->
                        <div class="grid grid-cols-2 gap-4">
                            <!-- 1. BNPL -->
                            <div onclick="window.navDebt('bnpl')" class="bg-indigo-600 text-white p-6 rounded-[2rem] shadow-lg relative overflow-hidden cursor-pointer hover:scale-[1.02] transition-transform flex flex-col justify-between h-40">
                                <div class="absolute -right-4 -bottom-4 opacity-20"><i data-lucide="shopping-bag" class="w-24 h-24"></i></div>
                                <div class="relative z-10 text-left">
                                    <div class="bg-white/20 w-10 h-10 rounded-full flex items-center justify-center mb-4"><i data-lucide="shopping-cart" class="w-5 h-5"></i></div>
                                    <h3 class="text-lg font-black leading-none">Active<br>Installments</h3>
                                    <p class="text-indigo-200 text-[10px] font-bold mt-2">${bnpl.length} Items</p>
                                </div>
                            </div>

                            <!-- 2. PERSONAL (Consolidated) -->
                            <div onclick="window.navDebt('personal')" class="bg-white text-slate-800 p-6 rounded-[2rem] border shadow-sm relative overflow-hidden cursor-pointer hover:scale-[1.02] transition-transform flex flex-col justify-between h-40">
                                <div class="absolute -right-4 -bottom-4 opacity-5"><i data-lucide="users" class="w-24 h-24"></i></div>
                                <div class="relative z-10 text-left">
                                    <div class="bg-slate-100 w-10 h-10 rounded-full flex items-center justify-center mb-4"><i data-lucide="user-check" class="w-5 h-5 text-slate-500"></i></div>
                                    <h3 class="text-lg font-black leading-none">Personal<br>Liability</h3>
                                    <p class="text-slate-400 text-[10px] font-bold mt-2">${sortedPeople.length} People</p>
                                </div>
                            </div>
                        </div>

                         <!-- 3. ARCHIVE (Full Width) -->
                         <div onclick="window.navDebt('archive')" class="bg-slate-50 text-slate-600 p-6 rounded-[2rem] border border-slate-100 cursor-pointer hover:bg-slate-100 transition-colors flex items-center justify-between">
                             <div class="flex items-center gap-4">
                                 <div class="bg-white w-10 h-10 rounded-full flex items-center justify-center shadow-sm"><i data-lucide="archive" class="w-5 h-5 text-slate-400"></i></div>
                                 <div class="text-left">
                                     <h3 class="text-sm font-black">Settled Archive</h3>
                                     <p class="text-[10px] font-bold text-slate-400">View previous records</p>
                                 </div>
                             </div>
                             <i data-lucide="chevron-right" class="w-5 h-5 text-slate-300"></i>
                         </div>
                </div>`;
            }

            // --- FOLDER: PERSONAL (Merged Payables/Receivables) ---
            if (state.ui.debtView === 'personal') {
                return `<div class="max-w-xl mx-auto space-y-6 min-h-[50vh]">
                    <div class="flex items-center gap-4 mb-4">
                        <button onclick="window.navDebt('home')" class="p-3 bg-white rounded-xl shadow-sm border border-slate-100"><i data-lucide="arrow-left" class="w-5 h-5 text-slate-400"></i></button>
                        <h3 class="text-xl font-black text-slate-800">Personal Liability</h3>
                    </div>

                    <!-- SEARCH / FILTER BAR (Optional Future?) -->

                    <div class="space-y-4">
                        ${sortedPeople.length > 0 ? sortedPeople.map(renderPerson).join('') :
                        '<div class="text-center py-20 opacity-50"><i data-lucide="users" class="w-16 h-16 mx-auto mb-4 text-slate-300"></i><p class="font-bold">No active personal debts.</p></div>'}
                    </div>
                </div>`;
            }

            // --- FOLDER: BNPL ---
            if (state.ui.debtView === 'bnpl') {
                // Sort by next due
                bnpl.sort((a, b) => {
                    const nextA = a.schedule?.find(s => !s.paid)?.date || '9999';
                    const nextB = b.schedule?.find(s => !s.paid)?.date || '9999';
                    return nextA.localeCompare(nextB);
                });

                return `<div class="max-w-xl mx-auto space-y-6 min-h-[50vh]">
                <div class="flex items-center gap-4 mb-4">
                    <button onclick="window.navDebt('home')" class="p-3 bg-white rounded-xl shadow-sm border border-slate-100"><i data-lucide="arrow-left" class="w-5 h-5 text-slate-400"></i></button>
                    <h3 class="text-xl font-black text-slate-800">Active Installments</h3>
                </div>

                     ${bnpl.length > 0 ? bnpl.map(renderBnplItem).join('') : '<div class="p-10 text-center border-2 border-dashed border-slate-200 rounded-3xl"><p class="text-slate-300 font-bold uppercase text-xs mb-2">No active installments</p><p class="text-[10px] text-slate-400">Purchases will appear here</p></div>'}
                </div>`;
            }

            // --- FOLDER: ARCHIVE ---
            if (state.ui.debtView === 'archive') {
                const settled = state.data.debts.filter(d => d.settled);
                return `<div class="max-w-xl mx-auto space-y-6 min-h-[50vh]">
                <div class="flex items-center gap-4 mb-6">
                    <button onclick="window.navDebtHome()" class="bg-slate-100 p-3 rounded-xl hover:bg-slate-200"><i data-lucide="arrow-left" class="w-5 h-5 text-slate-600"></i></button>
                    <h2 class="text-2xl font-black text-slate-800">Archive / Settled</h2>
                </div>
                     ${settled.length > 0 ? settled.map(d => {
                    // Simple Render for Archive
                    return `<div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 mb-2 opacity-75 grayscale hover:grayscale-0 transition-all">
                                 <div class="flex justify-between items-center">
                                      <div class="text-left">
                                          <p class="font-black text-slate-700 text-sm">${d.party}</p>
                                          <p class="text-[9px] font-bold text-slate-400 uppercase">${d.type} ‚Ä¢ ${d.amount} ${d.currency}</p>
                                      </div>
                                      <span class="px-2 py-1 bg-slate-200 text-slate-500 text-[8px] font-bold uppercase rounded">Settled</span>
                                 </div>
                                 <div class="mt-2 text-[9px] text-slate-400 border-t border-slate-200 pt-2">
                                     ${renderHistory(d.id)}
                                 </div>
                             </div>`;
                }).join('') :
                        `<div class="text-center py-20 opacity-50"><i data-lucide="archive" class="w-16 h-16 mx-auto mb-4 text-slate-300"></i><p class="font-bold">No archival records.</p></div>`
                    }
                </div>`;
            }
        };

        window.renderDistributionInsights = function () {
            const spend = state.data.transactions.filter(t => t.type === 'expense'), total = spend.reduce((s, t) => { const acc = state.data.accounts.find(a => a.id === t.accountId); const cur = t.currency || acc?.currency || 'AED'; return s + (Number(t.amount) * (cur === 'AED' ? state.data.settings.rate : 1)); }, 0);
            return `<div class="max-w-xl mx-auto p-10 bg-white rounded-[3rem] border text-center shadow-sm text-center text-center text-center text-center text-center"><h4 class="text-[10px] font-black uppercase text-slate-400 mb-10 tracking-widest text-center text-center text-center">Weight distribution</h4>
                <div class="text-right mb-6 flex justify-end gap-2">
                    <button onclick="window.downloadCSV()" class="bg-slate-100 text-slate-600 py-2 px-4 rounded-xl font-bold text-[10px] uppercase hover:bg-slate-200">CSV</button>
                    <button onclick="window.generatePDF()" class="bg-slate-900 text-white py-2 px-4 rounded-xl font-bold text-[10px] uppercase shadow-lg hover:bg-emerald-500 transition-colors">Download Official PDF</button>
                </div>
                <div class="space-y-4">
                    ${[...new Set(spend.map(t => t.category))].map(cat => { const val = spend.filter(t => t.category === cat).reduce((s, t) => { const acc = state.data.accounts.find(a => a.id === t.accountId); const cur = t.currency || acc?.currency || 'AED'; return s + (Number(t.amount) * (cur === 'AED' ? state.data.settings.rate : 1)); }, 0), p = total > 0 ? (val / total * 100) : 0; return `<div class="flex justify-between items-center space-y-3"><span class="font-black text-xs uppercase w-24 text-left">${cat}</span><div class="flex-1 mx-4 h-2 bg-slate-50 rounded-full overflow-hidden"><div class="h-full bg-slate-900" style="width: ${p}%"></div></div><span class="font-bold text-xs text-slate-400 w-12 text-right num-font">${Math.round(p)}%</span></div>`; }).join('') || '<p class="text-xs italic text-slate-300">No records</p>'}
                </div>
            </div>`;
        }

        window.generatePDF = function () {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const r = state.data.settings.rate;

            // -- HEADER --
            doc.setFontSize(22);
            doc.setFont("helvetica", "bold");
            doc.text("Financial Statement", 105, 20, null, null, "center");

            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(100);
            doc.text(`Generated on ${new Date().toLocaleDateString()} | Finshaanire Wealth Hub`, 105, 26, null, null, "center");

            // -- SUMMARY --
            let totalAssets = 0, totalLiabilities = 0;
            state.data.accounts.forEach(a => totalAssets += (a.currency === 'AED' ? a.balance * r : a.balance));
            state.data.debts.forEach(d => {
                if (!d.settled) {
                    const val = Number(d.amount) * (d.currency === 'AED' ? r : 1);
                    if (d.type === 'payable') totalLiabilities += val;
                    else totalAssets += val;
                }
            });
            const netWorth = totalAssets - totalLiabilities;

            doc.setFillColor(248, 250, 252); // slate-50
            doc.roundedRect(14, 35, 182, 30, 3, 3, 'F');

            doc.setTextColor(0);
            doc.setFontSize(10);
            doc.text("Total Net Worth", 105, 45, null, null, "center");
            doc.setFontSize(24);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(16, 185, 129); // emerald-500
            doc.text(`INR ${Math.round(netWorth).toLocaleString()} `, 105, 58, null, null, "center");

            // -- ASSETS TABLE --
            doc.setTextColor(0);
            doc.setFontSize(14);
            doc.text("Asset Holdings", 14, 80);

            const assetRows = state.data.accounts.map(a => [
                a.name,
                a.type,
                `${a.currency} ${a.balance.toLocaleString()} `,
                `INR ${Math.round(a.currency === 'AED' ? a.balance * r : a.balance).toLocaleString()} `
            ]);

            doc.autoTable({
                startY: 85,
                head: [['Asset Name', 'Type', 'Native Balance', 'INR Value']],
                body: assetRows,
                theme: 'grid',
                headStyles: { fillColor: [15, 23, 42] }, // slate-900
                styles: { fontSize: 9 }
            });

            // -- RECENT TRANSACTIONS --
            const finalY = doc.lastAutoTable.finalY + 15;
            doc.setFontSize(14);
            doc.text("Recent Ledger Activity (Last 20)", 14, finalY);

            const txRows = state.data.transactions
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 20)
                .map(t => [
                    new Date(t.date).toLocaleDateString(),
                    t.category || t.type,
                    t.note || '-',
                    `${t.type.includes('income') || t.type === 'transfer_in' ? '+' : '-'} ${parseFloat(t.amount).toLocaleString()
                    } `
                ]);

            doc.autoTable({
                startY: finalY + 5,
                head: [['Date', 'Category', 'Note', 'Amount']],
                body: txRows,
                theme: 'striped',
                headStyles: { fillColor: [100, 116, 139] },
                styles: { fontSize: 8 }
            });

            doc.save(`Finshaanire_Statement_${new Date().toISOString().split('T')[0]}.pdf`);
        };

        window.csvExport = function () {
            // ... existing csv code ...
        }

        // --- REMITTANCE ARBITRAGE TRACKER ---
        window.renderRemittance = function () {
            // 1. Identify Cross-Currency Transfers (AED -> INR)
            const remittance = [];
            const r = state.data.settings.rate;

            // Find "Transfer Out" from AED accounts
            const outTx = state.data.transactions.filter(t => t.type === 'transfer_out');

            outTx.forEach(tx => {
                const acc = state.data.accounts.find(a => a.id === tx.accountId);
                if (!acc || acc.currency !== 'AED') return;

                // Look for matching "Transfer In" (Checking by Note content or Timeframe is tricky without Link ID)
                // Reliable Method: We rely on the "Note" we auto-generated: "To [Name]: [UserNote]"
                // Or better, we just check if the user *explicitly* logged a rate in the note? NO.
                // We need to match the Pair. 
                // In `doTransfer`, we created two TXs with nearly identical timestamps.

                // Let's use a blurred timestamp match (+/- 1 sec) and opposite amount approx?
                // Actually, `doTransfer` pushes them sequentially. ID is random.
                // Let's assume for V1: We visualize "Implied Rate" based on the Manual Log if available?
                // BETTER: We can't robustly link past transfers without a `relatedTxId`.
                // FUTURE FIX: Update `doTransfer` to link IDs.

                // FOR NOW: We will assume any "Transfer Out" from AED account that mentions "Transfer" 
                // and has a "Transfer In" to an INR account with same User Note is a match.

                const matchIn = state.data.transactions.find(t2 =>
                    t2.type === 'transfer_in' &&
                    t2.note.includes(tx.note.split(':')[1]?.trim()) &&
                    Math.abs(new Date(t2.date) - new Date(tx.date)) < 2000 // 2 seconds tolerance
                );

                if (matchIn) {
                    const accIn = state.data.accounts.find(a => a.id === matchIn.accountId);
                    if (accIn && accIn.currency === 'INR') {
                        const sent = parseFloat(tx.amount);
                        const received = parseFloat(matchIn.amount);
                        const realizedRate = received / sent;

                        remittance.push({
                            date: tx.date,
                            sent, received, rate: realizedRate,
                            note: tx.note
                        });
                    }
                }
            });

            remittance.sort((a, b) => new Date(a.date) - new Date(b.date));

            // metrics
            const totalSent = remittance.reduce((s, i) => s + i.sent, 0); // AED
            const totalRec = remittance.reduce((s, i) => s + i.received, 0); // INR
            const avgRate = totalSent > 0 ? (totalRec / totalSent).toFixed(2) : 0;
            const marketRate = state.data.settings.rate;
            const diff = (avgRate - marketRate).toFixed(2);

            const beatsMarket = parseFloat(avgRate) > marketRate;

            return `<div class="max-w-xl mx-auto space-y-8">
                <div class="bg-gradient-to-br from-indigo-900 to-slate-900 text-white p-8 rounded-[3rem] shadow-2xl relative overflow-hidden group text-center">
                    <div class="relative z-10">
                        <p class="text-[10px] uppercase font-black text-indigo-300 tracking-[0.3em] mb-4">Arbitrage Performance</p>
                        <h3 class="text-6xl font-black text-white mb-2">${avgRate}<span class="text-2xl text-slate-400 font-bold"> INR/AED</span></h3>
                        <p class="text-indigo-200 font-medium text-xs">Your Realized Average</p>
                        
                        <div class="mt-8 flex justify-center items-center gap-4 text-xs font-bold border-t border-white/10 pt-6">
                            <div class="bg-white/10 px-4 py-2 rounded-xl">Market: ${marketRate}</div>
                            <div class="${beatsMarket ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/20 text-red-400'} px-4 py-2 rounded-xl border border-white/5">
                                ${beatsMarket ? `Winning by +${diff}` : `Losing by ${diff}`}
                            </div>
                        </div>
                    </div>
                </div>

                <!--CHART -->
                <div class="bg-white p-6 rounded-[2.5rem] border shadow-sm text-center">
                    <h4 class="text-[10px] font-black uppercase text-slate-400 mb-4 tracking-widest">Rate History</h4>
                    <div class="relative h-64 w-full">
                        <canvas id="chart-remit"></canvas>
                    </div>
                </div>

                <!--LOG -->
                <div class="space-y-4">
                    <h4 class="text-[10px] font-black uppercase text-slate-400 mb-4 tracking-widest text-left px-4">Transfer Log</h4>
                    ${remittance.length > 0 ? remittance.map(r => `
                        <div class="p-5 bg-white border border-slate-100 rounded-3xl flex justify-between items-center shadow-sm">
                            <div class="text-left">
                                <p class="font-bold text-sm text-slate-800">Sent AED ${Math.round(r.sent).toLocaleString()}</p>
                                <p class="text-[9px] font-black text-slate-400 uppercase">${new Date(r.date).toLocaleDateString()}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-black text-lg text-emerald-600 num-font">${r.rate.toFixed(2)}</p>
                                <p class="text-[8px] font-bold text-slate-400 uppercase">Rate Secured</p>
                            </div>
                        </div>
                     `).join('') : '<p class="text-center text-slate-300 text-xs font-bold uppercase py-10">No AED -> INR transfers detected</p>'}
                </div>
            </div>`;
        };

        window.renderRemitChart = function () {
            // Need to fetch data again or store it? Re-calc is cheap.
            const r = state.data.settings.rate;
            const remittance = [];
            // ... Logic duplication for simplicity in "script" context, or attach to window ...
            // Let's DRY: we need to extract this logic if possible, but for now inline to avoid globals pollution
            const outTx = state.data.transactions.filter(t => t.type === 'transfer_out');
            outTx.forEach(tx => {
                const acc = state.data.accounts.find(a => a.id === tx.accountId);
                if (!acc || acc.currency !== 'AED') return;
                const matchIn = state.data.transactions.find(t2 => t2.type === 'transfer_in' && t2.note.includes(tx.note.split(':')[1]?.trim()) && Math.abs(new Date(t2.date) - new Date(tx.date)) < 2000);
                if (matchIn) {
                    const accIn = state.data.accounts.find(a => a.id === matchIn.accountId);
                    if (accIn && accIn.currency === 'INR') {
                        remittance.push({ date: tx.date, rate: parseFloat(matchIn.amount) / parseFloat(tx.amount) });
                    }
                }
            });
            remittance.sort((a, b) => new Date(a.date) - new Date(b.date));

            const ctx = document.getElementById('chart-remit');
            if (remittance.length === 0 || !ctx) return;

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: remittance.map(r => new Date(r.date).toLocaleDateString(undefined, { month: 'short', day: 'numeric' })),
                    datasets: [
                        {
                            label: 'Your Rate',
                            data: remittance.map(r => r.rate),
                            borderColor: '#6366f1', // Indigo
                            backgroundColor: 'rgba(99, 102, 241, 0.1)',
                            borderWidth: 3,
                            tension: 0.3,
                            pointRadius: 4,
                            pointBackgroundColor: '#fff',
                            pointBorderWidth: 2
                        },
                        {
                            label: 'Market Base',
                            data: Array(remittance.length).fill(r),
                            borderColor: '#cbd5e1', // Slate 300
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true, position: 'bottom' } },
                    scales: { y: { beginAtZero: false } }
                }
            });
        };

        // --- BNPL ANALYZER (Tabby/Tamara) ---
        window.renderBNPLAnalyzer = function () {
            const r = state.data.settings.rate;

            // 1. Calculate Avg Income (3 Months)
            const now = new Date();
            const threeMonthsAgo = new Date(); threeMonthsAgo.setDate(now.getDate() - 90);
            const incomeTxs = state.data.transactions.filter(t => t.type === 'income' && new Date(t.date) >= threeMonthsAgo);
            const totalInc = incomeTxs.reduce((s, t) => {
                const acc = state.data.accounts.find(a => a.id === t.accountId);
                const cur = t.currency || acc?.currency || 'AED';
                return s + (Number(t.amount) * (cur === 'AED' ? 1 : (1 / r)));
            }, 0);
            const uniqueMonths = new Set(incomeTxs.map(t => new Date(t.date).getMonth() + '-' + new Date(t.date).getFullYear())).size;
            const avgIncome = totalInc / (uniqueMonths || 1);

            // 2. Fixed Obligations
            const fixedCats = state.data.fixedCategories || [];
            const fixedBudgetSum = fixedCats.reduce((s, cat) => s + (state.data.budgets[cat] || 0), 0);
            const discretionary = Math.max(0, avgIncome - fixedBudgetSum);
            const safeLimit = discretionary * 0.20;
            const availableCapacity = safeLimit;

            return `<div class="bg-indigo-50 p-6 rounded-[2.5rem] border border-indigo-100 relative overflow-hidden text-center mb-8">
                <div class="flex justify-between items-center mb-4 relative z-10 px-2">
                    <h4 class="text-[10px] font-black uppercase text-indigo-400 tracking-widest flex items-center gap-2">
                        <i data-lucide="shopping-bag" class="w-4 h-4"></i> BNPL Power
                    </h4>
                    <div class="flex items-center gap-2 bg-indigo-100 px-2 py-1 rounded-lg">
                        <span class="text-[9px] font-bold text-indigo-400 uppercase">Split:</span>
                        <input type="number" id="bnpl-split" value="4" min="1" max="60" oninput="window.calcBNPLSafe(${availableCapacity})" class="bg-transparent text-indigo-600 w-8 font-black text-[9px] text-center border-none outline-none num-font">
                        <span class="text-[9px] font-bold text-indigo-400 uppercase">Months</span>
                    </div>
                </div>

                <div class="relative z-10">
                    <p class="text-[10px] uppercase font-black text-slate-400 mb-1">Safe Monthly Capacity</p>
                    <h3 class="text-3xl font-black text-slate-800 mb-1 num-font">AED ${Math.round(availableCapacity).toLocaleString()}</h3>
                    <p class="text-xs text-slate-400 font-bold mb-6">Based on 20% of your free cash (AED ${Math.round(discretionary).toLocaleString()})</p>

                    <!-- SIMULATOR -->
                    <div class="bg-white p-4 rounded-2xl border border-indigo-50 shadow-sm text-left">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-[9px] font-black uppercase text-slate-400 block ml-1">Purchase Simulator</label>
                            <span class="text-[8px] font-bold text-emerald-500 bg-emerald-50 px-2 py-0.5 rounded-md uppercase">Interest-Free Only</span>
                        </div>
                        <div class="flex gap-4 items-center">
                            <input type="number" id="bnpl-price" oninput="window.calcBNPLSafe(${availableCapacity})" placeholder="Total Price (AED)" class="w-full p-3 border rounded-xl font-bold text-center outline-none focus:border-indigo-500 num-font">
                            <i data-lucide="arrow-right" class="w-4 h-4 text-slate-300"></i>
                            <div id="bnpl-result" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-xs text-center text-slate-400">
                                Enter Amount
                            </div>
                        </div>
                    </div>
                    <p id="bnpl-warning" class="text-[9px] text-slate-400 mt-3 italic opacity-60">"Avoid plans > 4 months to pay zero interest."</p>
                </div>
            </div>`;
        };

        window.calcBNPLSafe = function (limit) {
            const val = parseFloat(document.getElementById('bnpl-price').value);
            const split = parseInt(document.getElementById('bnpl-split').value) || 4;
            const res = document.getElementById('bnpl-result');

            if (isNaN(val) || val <= 0) {
                res.innerHTML = "Enter Amount";
                res.className = "w-full p-3 bg-slate-50 rounded-xl font-bold text-xs text-center text-slate-400";
                return;
            }

            const installment = val / split;
            const isSafe = installment <= limit;

            if (isSafe) {
                res.innerHTML = `<span class="text-emerald-500 block">‚úÖ AED ${Math.round(installment)} /mo</span> <span class="text-[8px] uppercase">Safe over ${split} mo</span>`;
                res.className = "w-full p-2 bg-emerald-50 border border-emerald-100 rounded-xl font-bold text-xs text-center";
            } else {
                res.innerHTML = `<span class="text-red-500 block">‚ùå AED ${Math.round(installment)} /mo</span> <span class="text-[8px] uppercase">Too Risky</span>`;
                res.className = "w-full p-2 bg-red-50 border border-red-100 rounded-xl font-bold text-xs text-center";
            }

            // Update Warning
            const warn = document.getElementById('bnpl-warning');
            if (warn) {
                if (split > 4) {
                    warn.innerText = "‚ö†Ô∏è Caution: Ensure 0% Interest. Banks often charge processing fees for 12 months.";
                    warn.className = "text-[9px] text-amber-500 mt-3 italic font-bold";
                } else {
                    warn.innerText = "\"Avoid plans> 4 months to pay zero interest.\"";
                    warn.className = "text-[9px] text-slate-400 mt-3 italic opacity-60";
                }
            }
        };

        window.addCategory = async function (type) {
            const inpId = type === 'income' ? 'new-inc-cat' : 'new-exp-cat';
            const listKey = type === 'income' ? 'incomeCategories' : 'expenseCategories';
            const val = document.getElementById(inpId)?.value?.trim();
            if (!val || state.data[listKey].includes(val)) return;
            state.data[listKey].push(val); await updateDb(); window.openModal('settings');
        };

        window.toggleFixedCat = async function (cat) {
            if (!state.data.fixedCategories) state.data.fixedCategories = [];
            if (state.data.fixedCategories.includes(cat)) {
                state.data.fixedCategories = state.data.fixedCategories.filter(c => c !== cat);
            } else {
                state.data.fixedCategories.push(cat);
            }
            await updateDb();
            window.openModal('settings');
        };

        window.delCategory = async function (type, name) {
            const listKey = type === 'income' ? 'incomeCategories' : 'expenseCategories';
            state.data[listKey] = state.data[listKey].filter(c => c !== name);
            await updateDb(); window.openModal('settings');
        };

        // --- CONTACTS MANAGER ---
        window.checkContactSelect = function () {
            const val = document.getElementById('dw').value;
            if (val === 'new') window.openContactModal();
        };

        window.openContactModal = function () {
            window.showPrompt("Add New Contact", "Enter full name (e.g. Ali Baba)", (name) => {
                if (!name) { document.getElementById('dw').value = ''; return; }

                window.showPrompt("Mobile Number", "e.g. 971501234567 (Optional) - Leave blank if unknown", (phone) => {
                    window.showPrompt("Relationship", "Friend, Family, or Business?", async (rel) => {
                        const newC = { id: window.genId(), name: name, phone: phone || null, relation: rel || 'Friend', creditScore: 100 };
                        if (!state.data.contacts) state.data.contacts = [];

                        // Check for duplicates
                        if (state.data.contacts.find(c => c.name === name)) {
                            window.showToast("Contact already exists", "warn");
                            return;
                        }

                        state.data.contacts.push(newC);
                        await window.updateDb();
                        window.showToast("Contact Added", "success");

                        // 1. Re-render Main App (Background)
                        if (typeof renderApp === 'function') renderApp(); else window.location.reload();

                        // 2. Re-render Modal if open (Foreground)
                        // This fixes the dropdown not updating issue
                        const modalContent = document.getElementById('modal-content');
                        if (modalContent && !document.getElementById('modal-backdrop').classList.contains('hidden')) {
                            // Assuming we are in Debt UI if the dropdown was visible
                            // We re-render the current debt view to refresh the select options
                            if (window.renderDebtUI) {
                                modalContent.innerHTML = window.renderDebtUI();
                                lucide.createIcons();
                            }
                        }

                        // Set value after re-render
                        setTimeout(() => {
                            const el = document.getElementById('dw');
                            if (el) el.value = name;
                        }, 300);
                    }, 'text', true); // Allow empty relationship (defaults to Friend)
                }, 'tel', true); // Allow empty phone
            });
        };

        window.handleLogin = function () {
            const e = document.getElementById('login-email').value, p = document.getElementById('login-pass').value;
            signInWithEmailAndPassword(auth, e, p).catch(() => {
                const msg = document.getElementById('auth-error-msg');
                if (msg) { msg.innerText = "Invalid credentials."; msg.classList.remove('hidden'); }
            });
        };

        window.handleRegister = function () {
            const e = document.getElementById('login-email').value, p = document.getElementById('login-pass').value;
            createUserWithEmailAndPassword(auth, e, p).catch(() => alert("Registry failed."));
        };

        window.openBudgetSettings = function () {
            document.getElementById('modal-content').innerHTML = `<div class="max-w-md mx-auto bg-slate-50 p-10 rounded-[3rem] border space-y-6 text-center">
                <p class="text-[10px] font-black uppercase text-slate-400">Monthly Budget Targets (AED)</p>
                <div class="space-y-4">
                    ${state.data.expenseCategories.map(cat => `
                        <div class="flex items-center space-x-4">
                            <span class="w-1/3 text-xs font-black text-left text-slate-500 uppercase">${cat}</span>
                            <input type="number" id="budget-${cat}" value="${state.data.budgets[cat] || 0}" class="w-2/3 p-4 border rounded-xl font-black text-center outline-none focus:border-emerald-500 bg-white shadow-sm transition-all">
                        </div>
                    `).join('')}
                </div>
                <button onclick="window.saveBudgets()" class="w-full bg-emerald-500 text-white p-5 rounded-2xl font-black uppercase hover:bg-emerald-600 transition-colors shadow-lg shadow-emerald-200">Update Targets</button>
            </div>`;
        };

        window.saveBudgets = async function () { state.data.expenseCategories.forEach(cat => { state.data.budgets[cat] = parseFloat(document.getElementById(`budget-${cat}`).value) || 0; }); await updateDb(); window.openModal('budget'); };
        window.toggleVisibility = function () { state.data.settings.isPrivate = !state.data.settings.isPrivate; updateDb().then(renderApp); };
        window.svS = async function () {
            // Save Currency Rate
            const r = parseFloat(document.getElementById('sr').value);
            if (!isNaN(r)) state.data.settings.rate = r;

            // Save Commodity Rates
            if (!state.data.commodityRates) state.data.commodityRates = {};
            ['Gold', 'Silver', 'Platinum', 'Palladium'].forEach(metal => {
                const el = document.getElementById('rate-' + metal);
                if (el) state.data.commodityRates[metal] = parseFloat(el.value) || 0;
            });

            await updateDb();
            window.renderApp(); // Re-render to update asset values
            closeModal();
        };
        window.exportBackup = function () { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(state.data)], { type: 'application/json' })); a.download = `Wealth_Back_${new Date().toISOString().split('T')[0]}.json`; a.click(); };
        window.importBackup = function (i) { const reader = new FileReader(); reader.onload = async (e) => { try { const imp = JSON.parse(e.target.result); if (imp.accounts) { state.data = imp; await updateDb(); window.showToast("Restored.", "success"); window.closeModal(); } } catch (err) { window.showToast("Error importing backup.", "error"); } }; if (i.files[0]) reader.readAsText(i.files[0]); };
        window.copyReminder = function (party, amount, currency, date, note) { const msg = `Hi ${party}, a friendly reminder regarding the repayment of ${amount} ${currency} scheduled for ${date || 'today'} ${note ? `(Purpose: ${note})` : ''}. Please settle it when you have a moment.Thanks!`; const el = document.createElement('textarea'); el.value = msg; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); window.showToast("Draft Copied!", "success"); };
        window.delAccount = async function (id) {
            window.showConfirm("Permanently wipe?", "This will delete the account and cannot be undone.", async () => {
                state.data.accounts = state.data.accounts.filter(x => x.id !== id);
                await updateDb();
                window.closeModal();
            });
        };

        window.toggleDebtFields = function () {
            const type = document.getElementById('dt').value;
            const bnplFields = document.getElementById('bnpl-fields');
            const partyContainer = document.getElementById('debt-party-container');

            if (type === 'bnpl') {
                if (bnplFields) bnplFields.classList.remove('hidden');
                if (partyContainer) partyContainer.classList.add('hidden');
            } else {
                if (bnplFields) bnplFields.classList.add('hidden');
                if (partyContainer) partyContainer.classList.remove('hidden');
            }
        };

        window.commitDebt = function () {
            const type = document.getElementById('dt').value;
            let who = document.getElementById('dw').value;
            const cur = document.getElementById('dc').value;
            const amt = parseFloat(document.getElementById('da').value);
            const date = document.getElementById('drd').value;
            const note = document.getElementById('dn').value;
            const accId = document.getElementById('ds').value;

            // BNPL Override: Auto-assign "who" if empty
            if (type === 'bnpl') {
                const prod = document.getElementById('bnpl-product').value;
                who = prod || "BNPL Purchase"; // Use product name or default
            } else {
                // Personal Debt requires a person
                if (!who) return window.showToast('Please select a person', 'error');
            }

            // BNPL FLAG: If BNPL selected in dropdown, force 'bnpl' type logic if user missed it?
            // User selects "BNPL" in 'dt' (Debt Type). 'dt' value is 'bnpl'.
            // So type IS 'bnpl'. Consistency check handled.

            if (isNaN(amt)) return window.showToast('Please enter amount', 'error');

            if (amt <= 0) return window.showToast('Amount must be positive', 'error');

            window.setBtnLoading('btn-commit-debt', true);

            // Stash
            window.dataToCommit = { type, who, cur, amt, date, note, accId };

            // LENDING SAFE CHECK
            if (type === 'receivable') {
                const limit = state.data.settings.lendingLimit || 50000; // Default warning threshold
                if (amt > limit) {
                    return window.showConfirm(
                        "High Value Lending",
                        `You are about to lend ${amt} ${cur}. Ensure you have proper documentation.Proceed ? `,
                        () => window.finalizeCommitDebt(),
                        "Proceed", // Context aware label
                        () => window.setBtnLoading('btn-commit-debt', false) // FIX: Reset loading on cancel
                    );
                }

                const r = state.data.settings.rate;
                const liquidAssets = state.data.accounts
                    .filter(a => ['Bank Account', 'Cash'].includes(a.type))
                    .reduce((s, a) => s + (a.currency === 'AED' ? a.balance : a.balance / r), 0);

                const now = new Date();
                const last30 = new Date(); last30.setDate(now.getDate() - 30);
                const burn = state.data.transactions
                    .filter(t => t.type === 'expense' && new Date(t.date) > last30)
                    .reduce((s, t) => {
                        const acc = state.data.accounts.find(a => a.id === t.accountId);
                        const tCur = t.currency || (acc ? acc.currency : 'AED');
                        return s + (parseFloat(t.amount) * (tCur === 'AED' ? 1 : 1 / r));
                    }, 0) || 3000;

                const loanAmt = (cur === 'AED' ? amt : amt / r);
                const runwayAfterLoan = (liquidAssets - loanAmt) / (burn || 1);

                if (runwayAfterLoan < 1) {
                    window.showConfirm(
                        `‚ö†Ô∏è High Risk Warning`,
                        `Lending leaves only ~${runwayAfterLoan.toFixed(1)} months of runway.Proceed ? `,
                        () => window.finalizeCommitDebt(),
                        "Proceed",
                        () => window.setBtnLoading('btn-commit-debt', false) // Reset loading on cancel
                    );
                    return;
                }
            }

            window.finalizeCommitDebt();
        };

        window.finalizeCommitDebt = async function () {
            const { type, who, cur, amt, date, note, accId } = window.dataToCommit;
            const r = state.data.settings.rate;

            if (type === 'bnpl') {
                const split = parseInt(document.getElementById('db-split').value) || 3;
                const schedule = [];
                const perMonth = amt / split;
                const start = date ? new Date(date) : new Date();

                for (let i = 0; i < split; i++) {
                    const d = new Date(start);
                    // 29-day logic as per user request (buffer)
                    d.setDate(d.getDate() + (29 * i));
                    schedule.push({
                        date: d.toISOString().split('T')[0],
                        amount: perMonth.toFixed(2),
                        paid: false
                    });
                }

                state.data.debts.push({
                    id: window.genId(),
                    type: 'payable',
                    subtype: 'bnpl',
                    party: who,
                    amount: amt,
                    currentAmount: amt,
                    originalAmount: amt,
                    currency: cur,
                    installments: split,
                    schedule: schedule,
                    repaymentDate: schedule[0].date, // Fixed: use .date not .dueDate
                    notes: 'BNPL Split',
                    settled: false,
                    isBnpl: true
                });
            } else {
                state.data.debts.push({
                    id: window.genId(),
                    type: type,
                    party: who,
                    amount: amt,
                    originalAmount: amt,
                    currency: cur,
                    repaymentDate: date,
                    notes: note || '',
                    settled: false
                });

                // AUTOMATED LENDING MESSAGE
                if (type === 'receivable' && state.data.settings.whapiToken) {
                    const contact = state.data.contacts.find(c => c.name === who);
                    if (contact && contact.phone) {
                        const noteText = note ? `(Purpose: ${note})` : '';
                        const msg = `Hey ${who}, just confirming I transferred ${amt} ${cur} to you. Scheduled back by: ${date ? new Date(date).toLocaleDateString() : 'open'} ${noteText}. Thanks!`;
                        window.sendWhapiReminder(who, msg, true); // Fire and forget
                    }
                }
            }

            // Linked Account Adjustment
            if (accId) {
                const acc = state.data.accounts.find(a => a.id === accId);
                if (acc) {
                    if (type === 'payable' && !type.isBnpl) {
                        window.saveTransaction({
                            id: window.genId(), accountId: acc.id,
                            type: 'income', amount: amt, category: 'Loan',
                            note: `Borrowed from ${who}`, date: new Date().toISOString()
                        });
                    } else if (type === 'receivable') {
                        window.saveTransaction({
                            id: window.genId(), accountId: acc.id,
                            type: 'expense', amount: amt, category: 'Loan Given',
                            note: `Lent to ${who}`, date: new Date().toISOString()
                        });
                    }
                }
            }

            await window.updateDb();
            window.renderApp();
            window.showToast('Debt Recorded Successfully');
            window.setBtnLoading('btn-commit-debt', false);
        };

        // --- ASSET SELL FLOW HELPERS ---
        window.toggleSellFields = function () {
            const sId = document.getElementById('ts').value;
            const acc = state.data.accounts.find(a => a.id === sId);
            const area = document.getElementById('asset-sell-area');

            if (!acc || !area) return;

            const isGold = acc.type === 'Commodity' || (acc.subtype && ['Gold', 'Silver', 'Platinum'].includes(acc.subtype));
            const isMF = acc.type === 'Mutual Fund';

            if (isGold || isMF) {
                area.classList.remove('hidden');
                document.getElementById('lbl-sell-qty').innerText = isMF ? "Units to Redeem" : "Grams to Sell";
                document.getElementById('lbl-sell-rate').innerText = isMF ? "NAV (Price per Unit)" : "Rate per Gram";

                // Auto-Fill Rate if known?
                if (isGold) {
                    const rate = state.data.commodityRates[acc.subtype] || 0;
                    if (rate > 0) document.getElementById('sell-rate').value = rate;
                }
                if (isMF && acc.schemeCode && state.data.portfolio[acc.schemeCode]) {
                    const nav = state.data.portfolio[acc.schemeCode].nav;
                    document.getElementById('sell-rate').value = nav;
                }

            } else {
                area.classList.add('hidden');
                // Reset fields
                document.getElementById('sell-qty').value = '';
                document.getElementById('sell-rate').value = '';
            }
        };

        window.calcSellTotal = function () {
            const qty = parseFloat(document.getElementById('sell-qty').value) || 0;
            const rate = parseFloat(document.getElementById('sell-rate').value) || 0;
            const total = qty * rate;

            if (total > 0) {
                const tamt = document.getElementById('tamt');
                tamt.value = total.toFixed(2);
                window.calcRemit(total); // Update estimation preview
            }
        };

        window.calcRemit = function (v) {
            const sId = document.getElementById('ts').value, tId = document.getElementById('ttg').value;
            const sAcc = state.data.accounts.find(a => a.id === sId), tAcc = state.data.accounts.find(a => a.id === tId);
            const rate = state.data.settings.rate;
            let est = 0;
            if (sAcc && tAcc) {
                if (sAcc.currency === tAcc.currency) est = parseFloat(v);
                else if (sAcc.currency === 'AED' && tAcc.currency === 'INR') est = parseFloat(v) * rate;
                else if (sAcc.currency === 'INR' && tAcc.currency === 'AED') est = parseFloat(v) / rate;
                else est = parseFloat(v);
            }
            const el = document.getElementById('remit-preview');
            if (el) el.innerText = `Estimate: ${est.toFixed(2)} ${tAcc ? tAcc.currency : ''} `;
        };

        window.setT = function (t) {
            document.getElementById('tt').value = t;
            const list = t === 'income' ? state.data.incomeCategories : state.data.expenseCategories;
            const select = document.getElementById('tc');
            if (select) select.innerHTML = list.map(c => `<option value = "${c}"> ${c}</option> `).join('');
            document.getElementById('be').className = t === 'expense' ? "p-4 rounded-xl border-4 border-emerald-500 bg-emerald-50 text-emerald-700 font-black text-xs uppercase" : "p-4 rounded-xl border-4 border-slate-100 text-slate-300 font-black text-xs uppercase";
            document.getElementById('bi').className = t === 'income' ? "p-4 rounded-xl border-4 border-emerald-500 bg-emerald-50 text-emerald-700 font-black text-xs uppercase" : "p-4 rounded-xl border-4 border-slate-100 text-slate-300 font-black text-xs uppercase";
        };

        window.toggleAssetFields = function () {
            const type = document.getElementById('at').value;
            const invType = document.getElementById('inv-type').value;

            // Toggle Secondary Dropdown logic
            const isInv = type === 'Investment';
            document.getElementById('inv-type-container').classList.toggle('hidden', !isInv);

            // Hide All First
            ['inp-balance', 'inp-balance-note', 'inp-commodity', 'inp-fund', 'inp-re', 'inp-crypto', 'inp-bond'].forEach(id => {
                document.getElementById(id)?.classList.add('hidden');
            });

            // Logic Tree
            if (type === 'Real Estate') {
                document.getElementById('inp-balance').classList.remove('hidden');
                document.getElementById('inp-re').classList.remove('hidden');
            }
            else if (isInv) {
                // Investment Sub-logic
                if (invType === 'Commodity') document.getElementById('inp-commodity').classList.remove('hidden');
                else if (invType === 'Mutual Fund') document.getElementById('inp-fund').classList.remove('hidden');
                else if (invType === 'Crypto') {
                    document.getElementById('inp-balance').classList.remove('hidden');
                    document.getElementById('inp-crypto').classList.remove('hidden');
                }
                else if (invType === 'Bond') {
                    document.getElementById('inp-balance').classList.remove('hidden');
                    document.getElementById('inp-bond').classList.remove('hidden');
                }
                else document.getElementById('inp-balance').classList.remove('hidden'); // General Stock
            }
            else if (type === 'Bank Account') {
                document.getElementById('inp-balance').classList.remove('hidden');
                document.getElementById('inp-balance-note').classList.remove('hidden');
            }
            else {
                // Cash, Savings, etc.
                document.getElementById('inp-balance').classList.remove('hidden');
            }
        };

        window.saveAccount = async function () {
            const n = document.getElementById('an')?.value;
            const c = document.getElementById('ac')?.value || 'AED';
            let t = document.getElementById('at')?.value;
            // Resolve Nested Type
            if (t === 'Investment') {
                t = document.getElementById('inv-type').value;
                if (t === 'General') t = 'Investment'; // Fallback to generic
            }

            const bal = parseFloat(document.getElementById('ab').value) || 0;
            const w = parseFloat(document.getElementById('aw')?.value) || 0;
            const u = parseFloat(document.getElementById('au')?.value) || 0;
            const code = document.getElementById('asc')?.value;

            // Capture Extra Fields
            const subtype = t === 'Commodity' ? document.getElementById('commodity-type')?.value :
                (t === 'Asset' ? 'General' : null);

            const category = document.getElementById('mf-cat')?.value || document.getElementById('re-type')?.value || 'General';
            const location = document.getElementById('re-loc')?.value;
            const area = document.getElementById('re-area')?.value;
            const vehicle = { make: document.getElementById('veh-make')?.value, model: document.getElementById('veh-model')?.value, year: document.getElementById('veh-year')?.value };
            const crypto = { sym: document.getElementById('cry-sym')?.value, net: document.getElementById('cry-net')?.value };
            const collectible = { brand: document.getElementById('col-brand')?.value, cond: document.getElementById('col-cond')?.value };

            if (!n) return;
            window.setBtnLoading('btn-save-acc', true);

            const newAcc = {
                id: window.genId(), name: n, currency: c, type: t,
                balance: bal, weight: w, units: u, schemeCode: code,
                subtype: subtype, category: category,
                details: { location, area, ...vehicle, ...crypto, ...collectible }
            };

            if (t === 'Commodity') {
                newAcc.weight = w;
                newAcc.subtype = document.getElementById('asub')?.value || document.getElementById('commodity-type')?.value || 'Gold';
                newAcc.purity = document.getElementById('apurity')?.value || '24K';
                newAcc.form = document.getElementById('aform')?.value || 'Bar';
                newAcc.makingCharges = parseFloat(document.getElementById('amc')?.value) || 0;
                const originalCostValue = document.getElementById('original-cost')?.value;
                newAcc.originalCost = parseFloat(originalCostValue) || 0;
                console.log(`Saving commodity: ${n}, originalCost input value: "${originalCostValue}", parsed: ${newAcc.originalCost}`);

                let rate = state.data.commodityRates[newAcc.subtype] || 0;
                // Purity Adjustment (Simple Logic: 22K is ~91.6% of 24K value)
                if (newAcc.purity === '22K') rate = rate * 0.916;
                if (newAcc.purity === '18K') rate = rate * 0.750;

                newAcc.balance = window.toCurrency(w * rate);
            } else if (t === 'Mutual Fund') {
                newAcc.units = u;
                newAcc.schemeCode = code;
                newAcc.folio = document.getElementById('afolio')?.value || '';
                newAcc.category = document.getElementById('acat')?.value || 'Equity';
                newAcc.sipDetails = document.getElementById('asip')?.value || '';
                newAcc.balance = 0;
            } else {
                // LEDGER-BASED REFACTOR: Initial Balance for Cash/Bank is an "Opening Balance" transaction
                if (bal !== 0 && ['Bank Account', 'Cash', 'Savings'].includes(t)) {
                    newAcc.balance = 0; // Starts at 0, transaction will fill it
                    // We need to push the transaction AFTER pushing the account so the ID exists? 
                    // Actually ID is generated in newAcc object. reliable.
                    state.data.transactions.push({
                        id: window.genId(),
                        accountId: newAcc.id,
                        amount: window.toCurrency(bal),
                        type: 'income', // Treat as income or special 'opening'? 'income' is safest for sum.
                        category: 'Opening Balance',
                        note: 'Initial Balance',
                        tags: ['#init'],
                        date: new Date().toISOString(),
                        exchangeRate: state.data.settings.rate
                    });
                    // Note: We don't call recalculateBalances yet, we do it at end of function via updateDb/renderApp cycle
                } else {
                    newAcc.balance = window.toCurrency(bal); // For other types or 0 balance
                }
            }

            state.data.accounts.push(newAcc);

            // If MF, try fetch initial NAV immediately
            if (t === 'Mutual Fund' && code) {
                // Background fetch, don't await blocking UI
                window.refreshFund(newAcc.id);
            }

            await updateDb();
            window.setBtnLoading('btn-save-acc', false);
            closeModal();
        };

        window.saveTransaction = async function (txData) {
            let transaction = txData;

            // 1. UI Mode: Scrape from DOM if no data provided
            if (!transaction) {
                const aId = document.getElementById('ta')?.value;
                const amtEl = document.getElementById('tam');
                const amt = parseFloat(amtEl?.value);
                const type = document.getElementById('tt')?.value;
                const cat = document.getElementById('tc')?.value;
                const note = document.getElementById('tn')?.value;
                const tagsVal = document.getElementById('ttags')?.value || '';
                const tags = tagsVal.split(' ').filter(t => t.startsWith('#'));

                if (!aId || isNaN(amt)) return;

                // Security: Prevent negative amounts
                if (amt < 0) {
                    window.showToast("Amount cannot be negative", "error");
                    // QoL: Ensure button is reset
                    const btn = document.getElementById('btn-save-tx');
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = btn.innerHTML.includes('Update') ? 'Update Entry' : 'Save Transaction';
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                    return;
                }

                window.setBtnLoading('btn-save-tx', true);

                const idx = state.data.accounts.findIndex(a => a.id === aId);
                const currentBal = state.data.accounts[idx].balance;

                // Insufficient Funds Check
                if (type === 'expense' && currentBal < amt) {
                    window.showToast("Insufficient Funds!", "error");
                    window.setBtnLoading('btn-save-tx', false);
                    return;
                }

                // Snapshot current exchange rate
                const rateSnapshot = state.data.settings.rate;

                transaction = {
                    id: window.genId(),
                    accountId: aId,
                    amount: window.toCurrency(amt),
                    type,
                    category: cat,
                    note,
                    tags,
                    date: new Date().toISOString(),
                    exchangeRate: rateSnapshot
                };
            }

            // 2. Commit to State
            state.data.transactions.push(transaction);

            // 3. Persist & Clean Up
            window.recalculateBalances(); // Derive new balances
            await updateDb();

            // Only handle UI cleanup if called from UI
            if (!txData) {
                window.setBtnLoading('btn-save-tx', false);
                closeModal();
                window.renderApp();
                // success toast handled by caller if programmatic, else here
                window.showToast("Transaction Saved", "success");
            }
        };

        window.doTransfer = async function () {
            const sId = document.getElementById('ts').value, tId = document.getElementById('ttg').value, val = parseFloat(document.getElementById('tamt').value), n = document.getElementById('trn').value;
            if (!sId || !tId || isNaN(val)) return;

            // Security: Prevent negative amounts
            if (val <= 0) {
                window.showToast("Transfer amount must be positive", "error");
                return;
            }

            if (sId === tId) {
                window.showToast("Cannot transfer to the same account", "error");
                return;
            }

            window.setBtnLoading('btn-do-transfer', true);

            const rate = state.data.settings.rate;
            const sIdx = state.data.accounts.findIndex(x => x.id === sId), tIdx = state.data.accounts.findIndex(x => x.id === tId);
            const sAcc = state.data.accounts[sIdx], tAcc = state.data.accounts[tIdx];

            if (sAcc.balance < val) {
                const errDiv = document.getElementById('transfer-error-msg');
                if (errDiv) {
                    errDiv.innerText = "Insufficient Funds in Source Account";
                    errDiv.classList.remove('hidden');
                } else {
                    window.showToast("Insufficient Funds in Source Account", "error");
                }
                window.setBtnLoading('btn-do-transfer', false);
                return;
            } else {
                const errDiv = document.getElementById('transfer-error-msg');
                if (errDiv) errDiv.classList.add('hidden');
            }

            let finalAmt = val;
            let noteSuffix = "";

            if (sAcc.currency !== tAcc.currency) {
                if (sAcc.currency === 'AED' && tAcc.currency === 'INR') finalAmt = val * rate;
                else if (sAcc.currency === 'INR' && tAcc.currency === 'AED') finalAmt = val / rate;
            }

            // --- INVESTMENT LOGIC (Auto-Buy/Sell Units) ---

            // 1. DESTINATION (Buying/Depositing)
            if (tAcc.type === 'Mutual Fund' && tAcc.schemeCode) {
                const meta = state.data.portfolio ? state.data.portfolio[tAcc.schemeCode] : null;
                const nav = meta ? parseFloat(meta.nav) : 0;
                if (nav > 0) {
                    const unitsBought = finalAmt / nav;
                    state.data.accounts[tIdx].units = (state.data.accounts[tIdx].units || 0) + unitsBought;
                    noteSuffix += ` [Bought ${unitsBought.toFixed(3)} Units @${nav}]`;
                }
            } else if (tAcc.type === 'Commodity' && tAcc.subtype) {
                const metalRate = state.data.commodityRates[tAcc.subtype] || 0;
                if (metalRate > 0) {
                    // Correction: finalAmt is currently in Target Currency (which might be INR for commodities)
                    // We assume Commodity Account Currency acts as the valuation currency.
                    const weightBought = finalAmt / metalRate;
                    state.data.accounts[tIdx].weight = (state.data.accounts[tIdx].weight || 0) + weightBought;
                    // Track original cost: add the transfer amount (in account currency) to originalCost
                    state.data.accounts[tIdx].originalCost = (state.data.accounts[tIdx].originalCost || 0) + finalAmt;
                    noteSuffix += ` [Bought ${weightBought.toFixed(3)}g @${metalRate}/g]`;
                }
            }

            // 2. SOURCE (Selling/Withdrawing)
            const explicitSellQty = parseFloat(document.getElementById('sell-qty').value);
            const explicitSellRate = parseFloat(document.getElementById('sell-rate').value);
            const isSellFlow = !document.getElementById('asset-sell-area').classList.contains('hidden') && explicitSellQty > 0;

            if (isSellFlow) {
                // USE EXPLICIT USER INPUTS (High Precision)
                // GHOST COST FIX: Reduce originalCost proportionally
                const preWeight = sAcc.weight || 0;
                const preUnits = sAcc.units || 0;

                if (sAcc.type === 'Commodity' || (sAcc.subtype && ['Gold', 'Silver', 'Platinum'].includes(sAcc.subtype))) {
                    state.data.accounts[sIdx].weight = Math.max(0, preWeight - explicitSellQty);
                    noteSuffix += ` [Sold ${explicitSellQty}g @ ${explicitSellRate}]`;

                    // Reduce Cost Basis
                    if (preWeight > 0 && sAcc.originalCost) {
                        const ratio = explicitSellQty / preWeight;
                        state.data.accounts[sIdx].originalCost = Math.max(0, sAcc.originalCost - (sAcc.originalCost * ratio));
                    }

                } else if (sAcc.type === 'Mutual Fund') {
                    state.data.accounts[sIdx].units = Math.max(0, preUnits - explicitSellQty);
                    noteSuffix += ` [Sold ${explicitSellQty} Units @ ${explicitSellRate}]`;

                    // Reduce Cost Basis (if tracked for MFs, usually implicit in NAV but good to track)
                    // Accounts for MFs don't strictly have originalCost in this schema yet, but if they did:
                    if (preUnits > 0 && sAcc.originalCost) {
                        const ratio = explicitSellQty / preUnits;
                        state.data.accounts[sIdx].originalCost = Math.max(0, sAcc.originalCost - (sAcc.originalCost * ratio));
                    }
                }
            } else {
                // FALLBACK TO AUTO-CALC (Standard Logic)
                if (sAcc.type === 'Mutual Fund' && sAcc.schemeCode) {
                    const meta = state.data.portfolio ? state.data.portfolio[sAcc.schemeCode] : null;
                    const nav = meta ? parseFloat(meta.nav) : 0;
                    if (nav > 0) {
                        const unitsSold = val / nav; // Val is in Source Currency (INR)
                        state.data.accounts[sIdx].units = Math.max(0, (state.data.accounts[sIdx].units || 0) - unitsSold);
                        noteSuffix += ` [Sold ${unitsSold.toFixed(3)} Units]`;
                    }
                } else if (sAcc.type === 'Commodity' && sAcc.subtype) {
                    const metalRate = state.data.commodityRates[sAcc.subtype] || 0;
                    if (metalRate > 0) {
                        const weightSold = val / metalRate; // Val is Source Currency (INR)
                        state.data.accounts[sIdx].weight = Math.max(0, (state.data.accounts[sIdx].weight || 0) - weightSold);
                        noteSuffix += ` [Sold ${weightSold.toFixed(3)}g]`;
                    }
                }
            }

            // LEDGER-BASED REFACTOR: Do not manually update balances

            // 3. Transactions
            const dateIso = new Date().toISOString();
            const rateSnapshot = state.data.settings.rate;

            state.data.transactions.push({
                id: window.genId(), accountId: sId, amount: window.toCurrency(val), type: 'transfer_out', category: 'Transfer', note: `To ${tAcc.name}: ${n}${noteSuffix} `, date: dateIso, exchangeRate: rateSnapshot
            });
            state.data.transactions.push({
                id: window.genId(), accountId: tId, amount: window.toCurrency(finalAmt), type: 'transfer_in', category: 'Transfer', note: `From ${sAcc.name}: ${n}${noteSuffix} `, date: dateIso, exchangeRate: rateSnapshot
            });

            window.recalculateBalances();
            await updateDb();
            window.setBtnLoading('btn-do-transfer', false);
            closeModal();
            window.renderApp();
            window.showToast("Transfer Successful", "success");
        };

        window.openSettleFlow = function (id) {
            const d = state.data.debts.find(x => x.id === id), c = document.getElementById('modal-content');
            document.getElementById('modal-title').innerText = "Process Settlement";
            c.innerHTML = `<div class="max-w-md mx-auto bg-slate-50 p-10 rounded-[3rem] border space-y-6 text-center shadow-xl">
                <p class="text-[10px] font-black uppercase">Entity: ${d.party}</p>
                <p class="text-3xl font-black">${d.amount} <span class="text-xs opacity-30">${d.currency}</span></p>
                <div class="text-left text-center"><label class="text-[10px] font-black uppercase block mb-1">Enter Volume (${d.currency})</label><input type="number" id="samt" step="0.01" value="${d.amount}" class="w-full p-4 border rounded-xl font-black text-xl text-center outline-none"></div>
                <div class="text-left text-center"><label class="text-[10px] font-black uppercase block mb-1">Select account</label><select id="sacc" class="w-full p-4 border rounded-xl bg-white font-bold text-center">${state.data.accounts.map(acc => `<option value="${acc.id}">${acc.name} (${acc.currency})</option>`).join('')}</select></div>
                <button id="btn-finalize-settle" onclick="window.finalizeSettle('${id}')" class="w-full bg-emerald-500 text-white p-5 rounded-2xl font-black uppercase shadow-lg text-center text-center">Authorize Movement</button>
            </div> `;
            window.closeReminder(); document.getElementById('modal-backdrop').classList.replace('hidden', 'flex');
        };

        window.finalizeSettle = async function (id) {
            const aId = document.getElementById('sacc').value;
            const enteredAmt = parseFloat(document.getElementById('samt').value);

            const dIdx = state.data.debts.findIndex(d => d.id === id);
            const d = state.data.debts[dIdx];
            const aIdx = state.data.accounts.findIndex(a => a.id === aId);

            if (aIdx === -1 || isNaN(enteredAmt) || enteredAmt <= 0 || enteredAmt > d.amount) return;

            window.setBtnLoading('btn-finalize-settle', true);

            // --- WHAPI AUTOMATION START ---
            try {
                const contact = state.data.contacts.find(c => c.name === d.party);
                if (contact && contact.phone && state.data.settings.whapiToken) {
                    const remaining = d.amount - enteredAmt;
                    const isFullSettle = (remaining <= 0.1);
                    const borrowedDate = new Date(d.repaymentDate || d.id.split('_')[0] || Date.now()).toLocaleDateString();
                    const noteText = d.notes ? `(Purpose: ${d.notes})` : '';

                    let msg = '';
                    if (d.type === 'receivable') {
                        // I received money (User was lender)
                        msg = `Hi ${d.party}, received ${enteredAmt} ${d.currency}. Thanks for settling that! ${noteText} ${isFullSettle ? '' : ` (Remaining: ${remaining.toFixed(2)} ${d.currency})`}`;
                    } else {
                        // I paid money (User was borrower)
                        msg = `Hi ${d.party}, I've sent ${enteredAmt} ${d.currency} to clear the pending balance. Please confirm when you get it. ${noteText} ${isFullSettle ? '' : ` (Remaining: ${remaining.toFixed(2)} ${d.currency})`}`;
                    }
                    // Fire and forget (don't await to block UI)
                    window.sendWhapiReminder(contact.name, msg, true); // isRaw = true
                    window.showToast("üîî Settlement automated message sent!", "success");
                }
            } catch (e) {
                console.error("Whapi Auto-Settle Error", e);
            }
            // --- WHAPI AUTOMATION END ---

            const acc = state.data.accounts[aIdx];
            const rate = state.data.settings.rate;
            let finalTxAmt = enteredAmt;

            if (d.currency !== acc.currency) {
                if (d.currency === 'AED' && acc.currency === 'INR') finalTxAmt = enteredAmt * rate;
                else if (d.currency === 'INR' && acc.currency === 'AED') finalTxAmt = enteredAmt / rate;
            }

            const currentBal = acc.balance;
            // LEDGER-BASED REFACTOR: Do not manually update balance
            // state.data.accounts[aIdx].balance = window.toCurrency(d.type === 'receivable' ? currentBal + finalTxAmt : currentBal - finalTxAmt);

            const fxNote = [];
            if (d.currency !== acc.currency) {
                // FX Calculation
                // valueOfDebtPaid (Base) = enteredAmt (in Debt Cur) * (Debt Rate? We don't track historical debt rate perfectly yet, 
                // but let's assume current rate for "Cost to Pay" vs "Value Extinguished")

                // Simplified: User paid 'finalTxAmt' in Account Currency.
                // Value of Debt extinguished = enteredAmt in Debt Currency.
                // We need to compare them in ONE currency (Base AED usually).

                const baseRate = state.data.settings.rate;
                let costInAED = 0;
                let valueInAED = 0;

                // 1. Cost in AED
                if (acc.currency === 'AED') costInAED = finalTxAmt;
                else costInAED = finalTxAmt / baseRate; // INR -> AED

                // 2. Value in AED
                if (d.currency === 'AED') valueInAED = enteredAmt;
                else valueInAED = enteredAmt / baseRate; // INR -> AED

                const diff = valueInAED - costInAED; // Positive = Gain (Paid less than value), Negative = Loss
                if (Math.abs(diff) > 1) {
                    fxNote.push(`(FX ${diff >= 0 ? 'Gain' : 'Loss'}: ${Math.abs(diff).toFixed(2)} AED)`);
                }
            }

            state.data.transactions.push({
                id: window.genId(),
                accountId: aId,
                amount: window.toCurrency(finalTxAmt),
                type: d.type === 'receivable' ? 'income' : 'expense',
                category: 'Settlement',
                note: `${d.party} (${enteredAmt} ${d.currency}) ${fxNote.join(' ')}`,
                debtId: id, // Link to Debt
                date: new Date().toISOString()
            });

            // Math Safety & Auto-Settle
            const newAmount = d.amount - enteredAmt;
            if (newAmount <= 0.1) { // Threshold for float dust
                state.data.debts[dIdx].amount = 0;
                state.data.debts[dIdx].settled = true;
            } else {
                state.data.debts[dIdx].amount = window.toCurrency(newAmount);
            }

            window.recalculateBalances();
            await updateDb();
            window.setBtnLoading('btn-finalize-settle', false);
            renderApp();
            document.getElementById('modal-content').innerHTML = `<div class="flex flex-col items-center justify-center space-y-4 py-20 fade-in text-center text-center"><div class="w-20 h-20 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto text-center"><i data-lucide="check-circle-2" class="w-10 h-10"></i></div><h3 class="text-2xl font-black">Success!</h3><button onclick="window.closeModal()" class="px-8 py-3 bg-slate-900 text-white rounded-xl font-bold uppercase text-[10px] text-center">Done</button></div> `;
            lucide.createIcons();
        };

        window.openRescheduleFlow = function (id) {
            const d = state.data.debts.find(x => x.id === id), b = document.getElementById('modal-backdrop'), t = document.getElementById('modal-title'), c = document.getElementById('modal-content');
            t.innerText = "Schedule Later";
            c.innerHTML = `<div class="max-w-md mx-auto bg-white p-10 rounded-[3rem] border shadow-xl space-y-6 text-center text-center"><p class="text-[10px] font-black uppercase text-slate-400">Extension for ${d.party}</p><div class="text-left text-center"><label class="text-[10px] font-black uppercase block mb-2 text-center text-center">New Date</label><input type="date" id="new-date" class="w-full p-4 border rounded-xl font-bold text-center outline-none"></div><button id="btn-resched" onclick="window.finalizeReschedule('${id}')" class="w-full bg-slate-900 text-white p-5 rounded-3xl font-black uppercase shadow-lg text-center text-center">Commit</button></div> `;
            b.classList.replace('hidden', 'flex'); window.closeReminder(); lucide.createIcons();
        };

        window.finalizeReschedule = async function (id) {
            const dt = document.getElementById('new-date').value; if (!dt) return;
            window.setBtnLoading('btn-resched', true);
            state.data.debts[state.data.debts.findIndex(i => i.id === id)].repaymentDate = dt;
            await updateDb(); renderApp();
            document.getElementById('modal-content').innerHTML = `<div class="flex flex-col items-center justify-center space-y-6 py-20 fade-in text-center text-center text-center"><div class="w-20 h-20 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center mx-auto text-center"><i data-lucide="calendar-check" class="w-12 h-12"></i></div><h3 class="text-2xl font-black text-center text-center">Updated</h3><button onclick="window.closeModal()" class="px-8 py-3 bg-slate-900 text-white rounded-xl font-bold uppercase text-[10px] text-center">Done</button></div> `;
            lucide.createIcons();
        };

        window.openMasterLedger = function () {
            const b = document.getElementById('modal-backdrop');
            const t = document.getElementById('modal-title');
            const c = document.getElementById('modal-content');

            t.innerText = "Transaction Ledger";
            c.innerHTML = `
            <div class="max-w-5xl mx-auto space-y-6 pb-8">
                <!--Search & Export Header-->
                <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-4 rounded-3xl border border-slate-100 shadow-sm">
                    <div class="relative w-full md:w-auto flex-grow max-w-md">
                        <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                        <input type="text" id="ledger-search" oninput="window.filterLedger()" 
                            placeholder="Search #tags, notes, amounts..." 
                            class="pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-2xl text-xs font-bold outline-none focus:border-emerald-500 w-full transition-all">
                    </div>
                    <button onclick="window.openModal('reports')" class="flex items-center space-x-2 bg-slate-900 text-white px-6 py-3 rounded-2xl font-bold text-[10px] uppercase hover:bg-emerald-600 transition-all shadow-lg active:scale-95">
                        <i data-lucide="download" class="w-4 h-4"></i> <span>Export Data</span>
                    </button>
                </div>

                <!--Filter Chips-->
            <div class="flex flex-wrap gap-2 px-2">
                <button id="filter-btn-all" onclick="window.setLedgerFilter('all')" class="px-4 py-2 bg-slate-900 text-white rounded-xl text-[10px] font-black uppercase shadow-lg transform scale-105 transition-all">All</button>
                <button id="filter-btn-income" onclick="window.setLedgerFilter('income')" class="px-4 py-2 bg-slate-100 text-slate-500 hover:bg-slate-200 rounded-xl text-[10px] font-bold uppercase transition-all">Income</button>
                <button id="filter-btn-expense" onclick="window.setLedgerFilter('expense')" class="px-4 py-2 bg-slate-100 text-slate-500 hover:bg-slate-200 rounded-xl text-[10px] font-bold uppercase transition-all">Expense</button>
                <button id="filter-btn-transfer" onclick="window.setLedgerFilter('transfer')" class="px-4 py-2 bg-slate-100 text-slate-500 hover:bg-slate-200 rounded-xl text-[10px] font-bold uppercase transition-all">Transfers</button>
                <button id="filter-btn-high" onclick="window.setLedgerFilter('high')" class="px-4 py-2 bg-slate-100 text-slate-500 hover:bg-slate-200 rounded-xl text-[10px] font-bold uppercase transition-all">High Value (>5k)</button>

                <div class="h-6 w-px bg-slate-200 mx-2"></div>

                <div class="flex items-center space-x-2">
                    <input type="date" id="ledger-date-from" onchange="window.filterLedger()" class="px-3 py-2 bg-slate-50 border border-slate-200 rounded-xl text-[10px] font-bold text-slate-500 uppercase outline-none focus:border-emerald-500 transition-all cursor-pointer hover:bg-white text-center w-28" placeholder="From">
                        <span class="text-slate-300 font-bold">-</span>
                        <input type="date" id="ledger-date-to" onchange="window.filterLedger()" class="px-3 py-2 bg-slate-50 border border-slate-200 rounded-xl text-[10px] font-bold text-slate-500 uppercase outline-none focus:border-emerald-500 transition-all cursor-pointer hover:bg-white text-center w-28" placeholder="To">
                        </div>
                </div>

                <!-- Table Container -->
                <div class="bg-white rounded-[2.5rem] border border-slate-200 overflow-hidden shadow-xl max-h-[60vh] overflow-y-auto custom-scrollbar">
                    <table class="w-full text-left relative">
                        <thead class="bg-slate-50 border-b border-slate-100 sticky top-0 z-10">
                            <tr>
                                <th class="px-6 py-4 font-black text-[9px] uppercase tracking-widest text-slate-400">Date</th>
                                <th class="px-6 py-4 font-black text-[9px] uppercase tracking-widest text-slate-400">Details</th>
                                <th class="px-6 py-4 font-black text-[9px] uppercase tracking-widest text-slate-400 text-center">Account</th>
                                <th class="px-6 py-4 font-black text-[9px] uppercase tracking-widest text-slate-400 text-right">Amount</th>
                                <th class="px-6 py-4 font-black text-[9px] uppercase tracking-widest text-slate-400 text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody id="master-ledger-body" class="divide-y divide-slate-100 text-sm"></tbody>
                    </table>
                </div>

                <div class="text-center pt-2">
                    <button onclick="window.closeModal()" class="px-8 py-3 bg-slate-100 text-slate-400 hover:text-slate-600 rounded-xl font-bold uppercase text-[10px] transition-colors">Close View</button>
                </div>
            </div>`;

            // Render Filters
            window.setLedgerFilter = function (filterType) {
                window.activeLedgerFilter = filterType;

                // Visual Update
                ['all', 'income', 'expense', 'transfer', 'high'].forEach(f => {
                    const btn = document.getElementById('filter-btn-' + f);
                    if (btn) {
                        if (f === filterType) {
                            btn.className = "px-4 py-2 bg-slate-900 text-white rounded-xl text-[10px] font-black uppercase shadow-lg transform scale-105 transition-all";
                        } else {
                            btn.className = "px-4 py-2 bg-slate-100 text-slate-500 hover:bg-slate-200 rounded-xl text-[10px] font-bold uppercase transition-all";
                        }
                    }
                });

                window.filterLedger();
            };

            // Init Filter State
            window.activeLedgerFilter = 'all';

            b.classList.replace('hidden', 'flex');
            if (typeof window.renderLedger === 'function') {
                window.renderLedger(state.data.transactions);
            }
            lucide.createIcons();
        };

        window.viewAccountLedger = function (id) {
            const a = state.data.accounts.find(x => x.id === id);
            if (!a) return;

            const ts = state.data.transactions.filter(t => t.accountId === id).sort((x, y) => new Date(y.date) - new Date(x.date));
            const t = document.getElementById('modal-title'), c = document.getElementById('modal-content');

            t.innerText = a.name;

            // --- METRICS CALCULATION ---
            const r = state.data.settings.rate;
            const isInv = ['Investment', 'Mutual Fund', 'Commodity'].includes(a.type);

            // 1. Current Value (in INR for uniform display, or native?)
            // Let's show Native + INR equivalent
            const curNative = a.balance;
            const curINR = a.currency === 'AED' ? curNative * r : curNative;

            // 2. Invested Amount (Net Inflow)
            // Transfer In = Deposit, Transfer Out = Withdrawal
            const deps = ts.filter(t => t.type === 'transfer_in').reduce((s, t) => s + parseFloat(t.amount), 0);
            const withs = ts.filter(t => t.type === 'transfer_out').reduce((s, t) => s + parseFloat(t.amount), 0);

            // For commodities OR Mutual Funds OR any investment, use originalCost if available + net transfers
            let investedNative;

            // Base calculation from ledger (Deposits - Withdrawals)
            const netTransfers = deps - withs;

            // If historical cost is set, add it. This is the "Base".
            if (a.originalCost !== undefined) {
                investedNative = a.originalCost + netTransfers;
            } else {
                investedNative = Math.max(0, netTransfers);
            }

            const investedINR = a.currency === 'AED' ? investedNative * r : investedNative;

            // 3. Profit / Loss
            const plNative = curNative - investedNative;
            const plINR = curINR - investedINR;
            const plPercent = investedNative > 0 ? (plNative / investedNative * 100) : 0;
            const isProfit = plNative >= 0;

            // 4. Projection (Simple CAGR @ 10% for 5Y/10Y)
            const growthRate = isInv ? 0.10 : 0.04; // 10% for inv, 4% for banks
            const fv5 = curINR * Math.pow(1 + growthRate, 5);
            const fv10 = curINR * Math.pow(1 + growthRate, 10);

            // --- RENDER UI ---
            c.innerHTML = `
                <div class="space-y-8 max-w-2xl mx-auto">
                    
                    <!--HERO CARD-->
                    <div class="bg-slate-900 text-white p-8 rounded-[3rem] text-center shadow-xl relative overflow-hidden">
                        <div class="relative z-10">
                            <p class="text-[10px] text-emerald-400 font-black uppercase mb-1 tracking-widest">Current Value</p>
                            <div class="flex items-baseline justify-center space-x-2">
                                <span class="text-4xl font-black">${a.currency} ${curNative.toLocaleString()}</span>
                            </div>
                            ${a.currency === 'AED' ? `<p class="text-xs text-slate-500 font-bold mt-1">‚âà ‚Çπ${Math.round(curINR).toLocaleString()}</p>` : ''}
                            
                            ${isInv ? `
                            <div class="grid grid-cols-2 gap-4 mt-8 border-t border-slate-700/50 pt-6">
                                <div>
                                    <p class="text-[9px] text-slate-400 uppercase font-bold">Invested</p>
                                    <p class="font-bold text-lg">${a.currency} ${investedNative.toLocaleString()}</p>
                                </div>
                                <div>
                                    <p class="text-[9px] text-slate-400 uppercase font-bold">Returns</p>
                                    <p class="font-bold text-lg ${isProfit ? 'text-emerald-400' : 'text-red-400'}">
                                        ${isProfit ? '+' : ''}${plNative.toLocaleString()} <span class="text-xs opacity-70">(${plPercent.toFixed(1)}%)</span>
                                    </p>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <!--PROJECTION CARDS(Conditional)-->
            ${isInv ? `
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white p-6 rounded-[2.5rem] border text-center shadow-sm">
                            <p class="text-[9px] text-slate-400 font-black uppercase mb-2">5 Year Forecast</p>
                            <p class="text-xl font-black text-slate-800">‚Çπ${Math.round(fv5).toLocaleString()}</p>
                            <p class="text-[8px] text-emerald-600 font-bold mt-1">+${(growthRate * 100)}% CAGR</p>
                        </div>
                        <div class="bg-white p-6 rounded-[2.5rem] border text-center shadow-sm">
                            <p class="text-[9px] text-slate-400 font-black uppercase mb-2">10 Year Forecast</p>
                            <p class="text-xl font-black text-slate-800">‚Çπ${Math.round(fv10).toLocaleString()}</p>
                            <p class="text-[8px] text-emerald-600 font-bold mt-1">Compound Power</p>
                        </div>
                    </div>` : ''
                }

                    <!--ACTIONS -->
                    <div class="flex justify-center space-x-4">
                         ${isInv ? `<button onclick="window.editOriginalCost('${id}')" class="px-6 py-3 bg-slate-100 text-slate-500 rounded-xl font-bold text-xs uppercase hover:bg-slate-200 transition-all">Set Initial Investment</button>` : ''}
                         <button onclick="window.delAccount('${id}')" class="px-6 py-3 bg-red-50 text-red-500 rounded-xl font-bold text-xs uppercase hover:bg-red-100 transition-all">Delete Asset</button>
                    </div>

                    <!--LEDGER -->
            <div class="space-y-4 text-left">
                <h4 class="text-xs font-black uppercase text-slate-400 tracking-widest px-2">Recent History</h4>
                ${ts.map(t => {
                    const isPositive = t.type === 'income' || t.type === 'transfer_in';
                    const color = isPositive ? 'text-emerald-500' : 'text-red-400';
                    const sign = isPositive ? '+' : '-';
                    return `<div class="p-5 bg-white border border-slate-100 rounded-3xl flex justify-between items-center shadow-sm">
                                <div>
                                    <p class="font-bold text-sm text-slate-800">${t.category || 'Transfer'}</p>
                                    <p class="text-[9px] font-black text-slate-400 uppercase">${new Date(t.date).toLocaleDateString()} ‚Äî ${t.note || '-'}</p>
                                </div>
                                <p class="font-black text-sm ${color}">${sign}${Number(t.amount).toLocaleString()}</p>
                            </div>`;
                }).join('') || '<div class="p-8 text-center border border-dashed rounded-3xl text-slate-300 text-xs font-bold uppercase">No transactions recorded</div>'}
            </div>
                </div> `;

            document.getElementById('modal-backdrop').classList.replace('hidden', 'flex');
        };

        // --- HELPER: Set Original Cost for Existing Commodities ---
        window.setOriginalCost = async function () {
            const commodities = state.data.accounts.filter(a =>
                a.type === 'Commodity' || (a.subtype && ['Gold', 'Silver', 'Platinum', 'Palladium', 'Oil', 'Diamond'].includes(a.subtype))
            );

            if (commodities.length === 0) {
                window.showToast('No commodity accounts found', 'info');
                return;
            }

            // Show list of commodities
            const list = commodities.map((acc, idx) =>
                `${idx + 1}. ${acc.name} (${acc.subtype || 'Commodity'}) - Current: ${acc.originalCost !== undefined ? acc.currency + ' ' + acc.originalCost : 'Not Set'}`
            ).join('\n');

            window.showPrompt(
                'Set Original Cost',
                `Select commodity by number:\n\n${list}\n\nEnter: [Number] [Amount]\nExample: 1 750`,
                async (input) => {
                    const parts = input.trim().split(' ');
                    if (parts.length !== 2) {
                        window.showToast('Invalid format. Use: [Number] [Amount]', 'error');
                        return;
                    }

                    const idx = parseInt(parts[0]) - 1;
                    const cost = parseFloat(parts[1]);

                    if (isNaN(idx) || idx < 0 || idx >= commodities.length || isNaN(cost)) {
                        window.showToast('Invalid input', 'error');
                        return;
                    }

                    const acc = commodities[idx];
                    const accIdx = state.data.accounts.findIndex(a => a.id === acc.id);
                    state.data.accounts[accIdx].originalCost = cost;

                    await updateDb();
                    window.showToast(`Original cost set to ${acc.currency} ${cost} for ${acc.name}`, 'success');
                    window.renderApp();
                },
                'text'
            );
        };

        // --- NEW: Edit Initial Cost for ANY Investment Account (MF, Stocks, Broken history) ---
        window.editOriginalCost = function (id) {
            const acc = state.data.accounts.find(a => a.id === id);
            if (!acc) return;

            window.showPrompt(
                "Set Initial Investment",
                `Enter the amount you invested BEFORE you started using this app.\n\n(Current Set Value: ${acc.originalCost || 0} ${acc.currency})`,
                async (val) => {
                    const cost = parseFloat(val);
                    if (isNaN(cost) || cost < 0) {
                        return window.showToast("Invalid Amount", "error");
                    }

                    acc.originalCost = cost;
                    await updateDb();
                    window.showToast("Initial Investment Updated!", "success");

                    // Refresh View
                    window.viewAccountLedger(id);
                },
                'number',
                acc.originalCost || '' // Pre-fill
            );
        };

        // --- ANALYTICS & CHARTS ---
        // --- SMART INSIGHTS ENGINE ---
        window.generateSmartInsights = function () {
            const insights = [];
            const r = state.data.settings.rate;
            const now = new Date();
            const dayOfMonth = now.getDate();
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            const monthProgress = dayOfMonth / daysInMonth;

            // 1. BUDGET PACING ALERTS
            state.data.expenseCategories.forEach(cat => {
                const budget = state.data.budgets[cat] || 0;
                if (budget > 0) {
                    // Calc spent this month
                    const mStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    const spent = state.data.transactions
                        .filter(t => t.type === 'expense' && t.category === cat && new Date(t.date) >= mStart)
                        .reduce((s, t) => {
                            const cur = t.currency || (state.data.accounts.find(a => a.id === t.accountId)?.currency) || 'AED';
                            return s + (Number(t.amount) * (cur === 'AED' ? 1 : (1 / r))); // Budget is usually tracked in primary currency (AED assumed base here for budget input, or matched. Let's assume budgets are set in AED as per UI labels)
                            // Logic correction: Budgets input label says "Limits (AED)". So we convert everything to AED.
                        }, 0);

                    const spentPct = spent / budget;
                    // Trigger: Spent % is 15% higher than Month %
                    if (spentPct > (monthProgress + 0.15) && spentPct < 1.0) {
                        insights.push({
                            type: 'warning',
                            icon: 'alert-triangle',
                            text: `Slow down on <b> ${cat}</b> !You've used ${Math.round(spentPct * 100)}% of budget, but month is only ${Math.round(monthProgress * 100)}% done.`
                        });
                    } else if (spentPct >= 1.0) {
                        insights.push({
                            type: 'danger',
                            icon: 'x-octagon',
                            text: `<b>${cat}</b> budget exceeded by ${Math.round((spentPct - 1) * 100)}%. Stop spending here!`
                        });
                    }
                }
            });

            // 2. ASSET PERFORMANCE (Simple Check)
            // Check if Investments/Gold have grown (Mock check as we don't have historical valuation snapshots yet)
            // We can check if today's commodity rate is high vs average? Or just a random encouragement if wealth is high?
            // Let's use a simple "Wealth Milestone" check
            const totalWealthAED = state.data.accounts.reduce((s, a) => s + (a.currency === 'AED' ? a.balance : a.balance / r), 0);
            if (totalWealthAED > 100000) {
                insights.push({
                    type: 'success',
                    icon: 'trending-up',
                    text: `Your net worth is looking strong! Keep investing to hit your next milestone.`
                });
            }

            return insights;
        };

        window.renderSmartInsights = function () {
            const list = document.getElementById('insights-list');
            if (!list) return;
            const msgs = window.generateSmartInsights();

            if (msgs.length === 0) {
                document.getElementById('smart-insights-panel').classList.add('hidden');
                return;
            }

            document.getElementById('smart-insights-panel').classList.remove('hidden');
            list.innerHTML = msgs.map(m => {
                const colors = m.type === 'warning' ? 'bg-amber-50 text-amber-700 border-amber-100' :
                    (m.type === 'danger' ? 'bg-red-50 text-red-700 border-red-100' : 'bg-emerald-50 text-emerald-700 border-emerald-100');
                const iconColor = m.type === 'warning' ? 'text-amber-500' : (m.type === 'danger' ? 'text-red-500' : 'text-emerald-500');
                return `
                <div class="p-4 rounded-2xl border ${colors} flex items-start gap-3 shadow-sm text-left">
                    <div class="mt-0.5"><i data-lucide="${m.icon}" class="w-5 h-5 ${iconColor}"></i></div>
                    <p class="text-xs font-medium leading-relaxed">${m.text}</p>
                </div>`;
            }).join('');
            lucide.createIcons();

            // Auto-hide after 1 minute (60000ms)
            setTimeout(() => {
                document.getElementById('smart-insights-panel').classList.add('hidden');
            }, 60000);
        };

        // --- ANALYTICS & CHARTS ---


        window.renderCharts = function () {
            const r = state.data.settings.rate;

            // --- 0. PRE-CALCULATIONS (Runway) ---
            // Liquid Cash: Bank Accounts (Savings/Current) + Cash. Exclude Investments/Commodities.
            const liquidCash = state.data.accounts
                .filter(a => !['Investment', 'Mutual Fund', 'Commodity'].includes(a.type))
                .reduce((sum, a) => sum + (a.currency === 'AED' ? a.balance * r : a.balance), 0);

            // Avg Monthly Expense (Last 6 Months)
            const dNow = new Date();
            let totalExp6m = 0;
            for (let i = 0; i < 6; i++) {
                const queryDate = new Date(dNow.getFullYear(), dNow.getMonth() - i, 1);
                const txs = state.data.transactions.filter(t => {
                    const td = new Date(t.date);
                    return td.getMonth() === queryDate.getMonth() && td.getFullYear() === queryDate.getFullYear() && t.type === 'expense';
                });
                totalExp6m += txs.reduce((s, t) => s + (t.currency === 'AED' ? Number(t.amount) * r : Number(t.amount)), 0);
            }
            const avgMonthlyExp = totalExp6m / 6;
            const runway = avgMonthlyExp > 0 ? (liquidCash / avgMonthlyExp).toFixed(1) : '‚àû';

            const runwayEl = document.getElementById('runway-months');
            if (runwayEl) {
                runwayEl.innerText = runway;
                const limit = state.data.settings.minRunwayMonths || 6;
                const isDanger = runway < (limit / 2);
                const isGood = runway >= limit;
                runwayEl.className = `text-4xl font-black ${isDanger ? 'text-red-400' : (isGood ? 'text-emerald-400' : 'text-amber-400')}`;
            }

            // --- CHART CONTEXTS ---
            const chartIds = ['chart-forecast', 'chart-allocation', 'chart-savings', 'chart-lifestyle', 'chart-debt-burndown'];
            const ctxs = {};
            chartIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) ctxs[id] = el.getContext('2d');
            });

            if (Object.keys(ctxs).length === 0) return;

            // --- 1. LIFESTYLE MONITOR (Expense Trends) ---
            if (ctxs['chart-lifestyle']) {
                // 1. Identify Top 3 Categories in last 6 months
                const catTotals = {};
                // Re-use logic to analyze 6 months
                const sixMonthsLabels = [];
                for (let i = 5; i >= 0; i--) {
                    const d = new Date();
                    d.setMonth(d.getMonth() - i);
                    sixMonthsLabels.push(d.toLocaleString('default', { month: 'short' }));
                }

                state.data.transactions.forEach(t => {
                    const td = new Date(t.date);
                    const ageInMonths = (new Date().getFullYear() - td.getFullYear()) * 12 + (new Date().getMonth() - td.getMonth());
                    if (ageInMonths < 6 && t.type === 'expense') {
                        const val = t.currency === 'AED' ? Number(t.amount) * r : Number(t.amount);
                        catTotals[t.category] = (catTotals[t.category] || 0) + val;
                    }
                });

                // Sort and pick top 3
                const topCats = Object.entries(catTotals).sort((a, b) => b[1] - a[1]).slice(0, 3).map(e => e[0]);

                // Build datasets
                const datasets = topCats.map((cat, idx) => {
                    const dataPoints = [];
                    for (let i = 5; i >= 0; i--) {
                        const d = new Date(); d.setMonth(d.getMonth() - i);
                        const monthExp = state.data.transactions
                            .filter(t => {
                                const td = new Date(t.date);
                                return t.category === cat && t.type === 'expense' && td.getMonth() === d.getMonth() && td.getFullYear() === d.getFullYear();
                            })
                            .reduce((s, t) => s + (t.currency === 'AED' ? Number(t.amount) * r : Number(t.amount)), 0);
                        dataPoints.push(monthExp);
                    }
                    const colors = ['#ec4899', '#8b5cf6', '#06b6d4']; // Pink, Violet, Cyan
                    return {
                        label: cat,
                        data: dataPoints,
                        borderColor: colors[idx],
                        backgroundColor: colors[idx] + '20', // transparent fill
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 4
                    };
                });

                new Chart(ctxs['chart-lifestyle'], {
                    type: 'line',
                    data: { labels: sixMonthsLabels, datasets: datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        scales: { x: { grid: { display: false } }, y: { display: false } } // minimalist
                    }
                });
            }

            // --- 2. DEBT BURNDOWN (Countdown) ---
            if (ctxs['chart-debt-burndown']) {
                // Current Total Debt
                const totalDebt = state.data.debts
                    .filter(d => !d.settled && d.type === 'payable')
                    .reduce((s, d) => s + (Number(d.amount) * (d.currency === 'AED' ? r : 1)), 0);

                // Avg Repayment Rate (Last 6 months settlement categories)
                // "Settlement" category is used for debt payments
                let totalPaid6m = 0;
                const txs = state.data.transactions.filter(t => {
                    const ageInMonths = (new Date().getFullYear() - new Date(t.date).getFullYear()) * 12 + (new Date().getMonth() - new Date(t.date).getMonth());
                    return ageInMonths < 6 && (t.category === 'Settlement' || t.category === 'Debt Repayment') && t.type === 'expense';
                });
                totalPaid6m = txs.reduce((s, t) => s + (t.currency === 'AED' ? Number(t.amount) * r : Number(t.amount)), 0);

                const avgRepay = totalPaid6m / 6 || (totalDebt * 0.05); // Fallback to 5% if no history

                const monthsToFreedom = avgRepay > 0 ? Math.ceil(totalDebt / avgRepay) : 0;

                const labels = [];
                const data = [];

                // Show 12 months projection or until 0
                const projectMonths = Math.min(monthsToFreedom + 2, 24); // Cap visualization
                let runningDebt = totalDebt;

                for (let i = 0; i <= projectMonths; i++) {
                    labels.push(i === 0 ? 'Now' : `+${i}M`);
                    data.push(Math.max(0, runningDebt));
                    runningDebt -= avgRepay;
                    if (runningDebt < -avgRepay) break; // Stop when clear
                }

                new Chart(ctxs['chart-debt-burndown'], {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Debt Balance',
                            data: data,
                            borderColor: '#ffffff',
                            backgroundColor: 'rgba(255,255,255,0.2)',
                            fill: true,
                            tension: 0.1,
                            borderDash: [5, 5]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { ticks: { color: 'rgba(255,255,255,0.6)', font: { size: 9 } }, grid: { display: false } },
                            y: { display: false }
                        }
                    }
                });
            }

            // --- 3. NET WORTH FORECAST ---
            if (ctxs['chart-forecast']) {
                // Calc current NW in INR
                let currentNW = 0;
                state.data.accounts.forEach(a => currentNW += (a.currency === 'AED' ? a.balance * r : a.balance));
                state.data.debts.filter(d => !d.settled && d.type === 'receivable').forEach(d => currentNW += (Number(d.amount) * (d.currency === 'AED' ? r : 1)));
                state.data.debts.filter(d => !d.settled && d.type === 'payable').forEach(d => currentNW -= (Number(d.amount) * (d.currency === 'AED' ? r : 1)));

                const growthRate = (state.data.settings.forecastReturn || 8) / 100;
                const labels = ['Now', '+1Y', '+2Y', '+3Y', '+4Y', '+5Y'];
                const data = [];
                for (let i = 0; i <= 5; i++) data.push(currentNW * Math.pow(1 + growthRate, i));

                new Chart(ctxs['chart-forecast'], {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Projected Wealth (INR)',
                            data: data,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { color: '#94a3b8' } }, x: { grid: { display: false }, ticks: { color: '#94a3b8' } } } }
                });
            }

            // --- 4. DETAILED ALLOCATION ---
            if (ctxs['chart-allocation']) {
                const breakdown = {};
                state.data.accounts.forEach(a => {
                    let key = a.type;
                    if (a.type === 'Commodity') key = a.subtype || 'Gold';
                    const val = a.currency === 'AED' ? a.balance * r : a.balance;
                    breakdown[key] = (breakdown[key] || 0) + val;
                });

                new Chart(ctxs['chart-allocation'], {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(breakdown),
                        datasets: [{
                            data: Object.values(breakdown),
                            backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#6366f1', '#ec4899', '#8b5cf6'],
                            borderWidth: 0
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } } }
                });
            }

            // --- 5. SAVINGS TREND (6 MONTHS) ---
            if (ctxs['chart-savings']) {
                const months = [];
                const savingsRates = [];

                for (let i = 5; i >= 0; i--) {
                    const d = new Date(); d.setMonth(d.getMonth() - i);
                    months.push(d.toLocaleString('default', { month: 'short' }));

                    const txs = state.data.transactions.filter(t => {
                        const td = new Date(t.date); return td.getMonth() === d.getMonth() && td.getFullYear() === d.getFullYear();
                    });

                    const inc = txs.filter(t => t.type === 'income').reduce((s, t) => s + (t.currency === 'AED' ? t.amount * r : t.amount), 0);
                    const exp = txs.filter(t => t.type === 'expense').reduce((s, t) => s + (t.currency === 'AED' ? t.amount * r : t.amount), 0);

                    savingsRates.push(inc > 0 ? ((inc - exp) / inc * 100) : 0);
                }

                new Chart(ctxs['chart-savings'], {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Savings Rate %',
                            data: savingsRates,
                            borderColor: '#3b82f6',
                            borderDash: [5, 5],
                            tension: 0.3,
                            pointRadius: 3
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { min: 0, max: 100 } } }
                });
            }
        };

        // --- AUTOMATION: SELF REMINDERS ---
        window.checkSelfReminders = function () {
            if (!state.data.settings.whapiToken) return;
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];
            const myName = state.user.displayName || "Me";
            const myPhone = state.user.phoneNumber || state.data.settings.myPhone;

            if (!myPhone) return;

            // 1. BNPL Due Today
            state.data.debts.filter(d => d.isBnpl && !d.settled).forEach(d => {
                d.schedule.forEach((s, idx) => {
                    if (!s.paid && (s.date === todayStr || s.dueDate === todayStr)) {
                        const msg = `üîî *Payment Due Today*\n\nInstallment ${idx + 1}/${d.installments} for **${d.party}**\nAmount: ${d.currency} ${s.amount}\n\nPlease ensure sufficient funds are available.`;
                        window.sendWhapiReminder(myName, msg, true); // sendToSelf=true
                    }
                });
            });

            // 2. Personal Payables Due Today (New)
            state.data.debts.filter(d => d.type === 'payable' && !d.isBnpl && !d.settled && d.repaymentDate === todayStr).forEach(d => {
                const msg = `üîî *Payment Due Today*\n\nYou owe **${d.party}** ${d.currency} ${d.amount}\nNote: ${d.notes || 'No notes'}\n\nPlease settle this debt.`;
                window.sendWhapiReminder(myName, msg, true);
            });

            // 2. Receivables Due Today (Existing logic presumed)
            state.data.debts.filter(d => d.type === 'receivable' && !d.settled && d.repaymentDate === todayStr).forEach(d => {
                const msg = `üîî *Collection Due Today*\n\n${d.party} owes you ${d.currency} ${d.amount}\nNote: ${d.notes || 'No notes'}`;
                window.sendWhapiReminder(myName, msg, true);
            });
        };

        // --- NEW FUNCTIONS ---

        window.saveSinkingFund = async () => {
            const name = document.getElementById('sf-name').value;
            const target = parseFloat(document.getElementById('sf-target').value);
            const date = document.getElementById('sf-date').value;
            const currency = document.getElementById('sf-currency').value || 'AED';

            if (!name || isNaN(target) || !date) {
                window.showToast("Please fill all fields properly.", "error");
                return;
            }

            state.data.sinkingFunds.push({
                id: window.genId(),
                name, target, date, currency,
                current: 0
            });

            await updateDb();
            window.showToast("Sinking Fund Created!", "success");
            window.closeModal();
            window.renderApp();
        };

        window.cloneTransaction = async (id) => {
            const tx = state.data.transactions.find(t => t.id === id);
            if (!tx || tx.accountId === 'virtual_writeoff' || tx.type.includes('transfer')) {
                alert("Cannot clone this transaction type.");
                return;
            }

            const newTx = {
                ...tx,
                id: window.genId(),
                date: new Date().toISOString(),
                note: tx.note + ' (Clone)'
            };

            state.data.transactions.push(newTx);
            await updateDb();
            // Integrity: Recalculate balances from ledger instead of manual math
            window.recalculateBalances();
            window.renderApp();
            window.showToast("Transaction Cloned", "success");
        };

        window.deleteTransaction = async (id) => {
            window.showConfirm(
                "‚ö†Ô∏è DELETE TRANSACTION?",
                "This will permanently remove the record and update your balances.",
                async () => {
                    try {
                        const tx = state.data.transactions.find(t => t.id === id);
                        if (!tx) {
                            window.showToast("Error: Transaction ID not found.", "error");
                            return;
                        }

                        // 1. REVERSE DEBT (If linked)
                        if (tx.debtId) {
                            const dIdx = state.data.debts.findIndex(d => d.id === tx.debtId);
                            if (dIdx !== -1) {
                                // Revert amount logic
                                const d = state.data.debts[dIdx];
                                // If it was a payment (settlement/install), we ADD back to debt
                                // If it was a 'loan given' transaction... usually we don't delete those to reverse, we delete the debt.
                                // But if we delete a "Repayment" transaction:
                                if (d.type === 'payable' || d.type === 'receivable') {
                                    // Logic: d.amount is the *remaining* balance.
                                    // We need to add back the tx.amount.
                                    // Security: Validate tx.amount > 0 and d.amount matches expected?
                                    // Just add it back.
                                    // 1. If it was settled, unsettle it.
                                    if (d.settled) state.data.debts[dIdx].settled = false;

                                    // 2. Add amount
                                    state.data.debts[dIdx].amount = window.toCurrency((parseFloat(d.amount) || 0) + parseFloat(tx.amount));

                                    console.log(`Reverted Debt ${d.id}: +${tx.amount}`);
                                }
                            }
                        }

                        // 2. Remove Transaction
                        state.data.transactions = state.data.transactions.filter(t => t.id !== id);

                        // 2. Save & Refresh
                        await updateDb();

                        // Integrity: Recalculate balances from ledger
                        window.recalculateBalances();

                        console.log("Deleted transaction:", id);
                        window.showToast("Transaction Deleted", "success");
                        window.renderApp();

                    } catch (error) {
                        console.error("Delete failed:", error);
                        window.showToast("Delete failed: " + error.message, "error");
                    }
                }
            );
        };

        window.editTransaction = (id) => {
            const tx = state.data.transactions.find(t => t.id === id);
            if (!tx) return;

            // Block complex edits
            if (tx.type.includes('transfer') || ['Settlement', 'Lending', 'Borrowing'].includes(tx.category) || tx.accountId === 'virtual_writeoff') {
                alert("‚ö†Ô∏è Complex Entry Locked\n\nTransfers, Debt Settlements, and Write-offs cannot be edited directly because they affect multiple records.\n\nPlease DELETE this entry and create a new one.");
                return;
            }

            // Open Modal
            window.openModal('transaction');

            // Fill values
            document.getElementById('tt').value = tx.type;
            window.setT(tx.type); // Update UI buttons
            document.getElementById('ta').value = tx.accountId;
            document.getElementById('tc').value = tx.category;
            document.getElementById('tam').value = tx.amount;
            document.getElementById('tn').value = tx.note;

            // Change Save button to Update
            const btn = document.getElementById('btn-save-tx');
            btn.innerText = "Update Entry";
            btn.onclick = () => window.updateTransaction(id);
        };

        window.updateTransaction = async (id) => {
            // Get New Values
            const aId = document.getElementById('ta').value;
            const amt = parseFloat(document.getElementById('tam').value);
            const type = document.getElementById('tt').value;
            const cat = document.getElementById('tc').value;
            const note = document.getElementById('tn').value;

            if (!aId || isNaN(amt)) return;

            // Security: Prevent negative amounts
            if (amt < 0) {
                window.showToast("Amount cannot be negative", "error");
                return;
            }

            window.setBtnLoading('btn-save-tx', true);

            // 1. Update Transaction Object
            const txIdx = state.data.transactions.findIndex(t => t.id === id);
            const oldTx = state.data.transactions[txIdx];

            state.data.transactions[txIdx] = {
                ...oldTx,
                accountId: aId,
                amount: window.toCurrency(amt),
                type: type,
                category: cat,
                note: note,
            };

            await updateDb();
            // Integrity: Recalculate balances from ledger
            window.recalculateBalances();

            window.closeModal();
            window.renderApp();
            window.showToast("Transaction Updated", "success");
            window.setBtnLoading('btn-save-tx', false);
        };

        onAuthStateChanged(auth, (user) => {
            state.user = user;
            const projectTag = document.getElementById('project-tag');
            if (user && !user.isAnonymous) {
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-content').style.display = 'flex';
                onSnapshot(doc(db, 'artifacts', appId, 'users', user.uid, 'finance', 'main'), async (snap) => {
                    if (snap.exists()) {
                        const dbData = snap.data();
                        state.data = { ...state.data, ...dbData };
                        // THEME PERSISTENCE
                        if (state.data.settings && state.data.settings.theme) {
                            window.applyTheme(state.data.settings.theme);
                        }

                        // Defensive Defaults
                        if (!state.data.goals) state.data.goals = [];
                        if (!state.data.portfolio) state.data.portfolio = {};
                        if (!state.data.commodityRates) state.data.commodityRates = { Gold: 7200, Silver: 90, Platinum: 2500, Palladium: 3000 };
                        if (!state.data.contacts) state.data.contacts = []; // New Feature: People Ledger
                        if (!state.data.allocationTargets) state.data.allocationTargets = { 'Real Estate': 0, 'Gold': 20, 'Equity': 50, 'Cash': 30 };
                        if (!state.data.budgets) state.data.budgets = {};
                        if (!state.data.budgetRollovers) state.data.budgetRollovers = {};
                        if (!state.data.fixedCategories) state.data.fixedCategories = []; // New Feature
                        if (!state.data.subscriptions) state.data.subscriptions = [];
                        if (!state.data.sinkingFunds) state.data.sinkingFunds = []; // New Feature
                        if (!state.data.settings.theme) state.data.settings.theme = 'emerald';

                        // Force update asset types to ensure new features appear
                        const requiredTypes = ['Bank Account', 'Cash', 'Savings', 'Investment', 'Real Estate'];
                        state.data.assetTypes = [...new Set([...(state.data.assetTypes || []), ...requiredTypes])].filter(t => t !== 'Commodity' && t !== 'Mutual Fund' && t !== 'Vehicle' && t !== 'Collectible'); // Clean up

                        // Retrofit existing accounts if needed
                        state.data.accounts.forEach(a => {
                            if (!a.currency) a.currency = 'INR'; // Default fallback
                        });

                        // Messaging Migration
                        if (state.data.settings.whapiToken && !state.data.settings.messagingToken) {
                            state.data.settings.messagingToken = state.data.settings.whapiToken;
                        }
                        try {
                            window.checkDueDebts();
                            window.checkSelfReminders();
                            window.fetchExchangeRate();
                            window.checkSubscriptions();
                            await window.checkBudgetRollover();
                            window.renderApp();
                        } catch (e) {
                            console.error("Init Error", e);
                        }
                    } else {
                        // Init new user
                        state.data = { accounts: [], transactions: [], settings: { rate: 22.75 } }; // Basic default
                        updateDb();
                    }
                });
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('app-content').style.display = 'none';
            }
        });
        // --- SINKING FUNDS LOGIC ---
        window.addSinkingFund = function () {
            window.openModal('sinking-add');
        };
        window.deleteSinkingFund = async (id) => {
            window.showConfirm("Delete this Sinking Fund?", "This cannot be undone.", async () => {
                state.data.sinkingFunds = state.data.sinkingFunds.filter(f => f.id !== id);
                await updateDb(); window.renderApp();
            });
        };

        // --- IMPULSE TEST LOGIC ---
        window.runImpulseTest = function () {
            window.showPrompt("Impulse Reality Check", "Cost of item you want to buy (AED)?", (priceStr) => {
                const price = parseFloat(priceStr);
                if (!price || isNaN(price)) return;

                // 1. Calc Passive Income Speed (Avg Monthly Gain)
                // Scan all investment accounts
                const investAccs = state.data.accounts.filter(a => ['Investment', 'Mutual Fund', 'Commodity'].includes(a.type));
                let totalGain = 0;
                let totalMonths = 0;
                let count = 0;

                investAccs.forEach(acc => {
                    const txs = state.data.transactions.filter(t => t.accountId === acc.id);
                    // Simple Net Cashflow
                    const tIn = txs.filter(t => t.type === 'transfer_in').reduce((s, t) => s + Number(t.amount), 0);
                    const tOut = txs.filter(t => t.type === 'transfer_out').reduce((s, t) => s + Number(t.amount), 0);
                    const netInvested = Math.max(0, tIn - tOut);

                    const curVal = acc.currency === 'AED' ? window.toCurrency(acc.balance * state.data.settings.rate) : acc.balance;
                    const invVal = acc.currency === 'AED' ? window.toCurrency(netInvested * state.data.settings.rate) : netInvested;

                    if (invVal > 0) {
                        totalGain += (curVal - invVal);
                        // Estimate age
                        const first = txs[0] ? new Date(txs[0].date) : new Date();
                        const ageMonths = Math.max(1, (new Date() - first) / (1000 * 60 * 60 * 24 * 30));
                        totalMonths += ageMonths;
                        count++;
                    }
                });

                // Conservative Estimate: Total Gain / Avg Age? 
                // Better: Sum of (Gain / Age) for each asset?
                // Let's do: Total Portfolio Gain / Max Age (to be safe)
                const maxAge = Math.max(1, totalMonths / (count || 1)); // Avg age
                const monthlyPassive = totalGain / maxAge;

                if (monthlyPassive <= 0) {
                    window.showToast("üìâ You have no passive income yet! Invest first!", "warning");
                    return;
                }

                const recoveryMonths = price / monthlyPassive;
                const years = (recoveryMonths / 12).toFixed(1);

                window.showConfirm(
                    "‚è≥ TIME TO RECOVERY",
                    `To earn back the cost of **AED ${price.toLocaleString()}** passively, it will take your portfolio:\n\nüìÖ **${recoveryMonths.toFixed(1)} MONTHS**\n\n(Based on avg growth of AED ${Math.round(monthlyPassive)}/mo).\n\nIs it worth ${Math.round(recoveryMonths * 30)} days of freedom?`,
                    () => { } // No action on OK, just info
                );
            }, "number");
        };

        // --- OVERRIDE: Budgeting in AED ---
        window.renderBudgetUI = function () {
            const startDay = state.data.settings.budgetStartDay || 1;
            const today = new Date();
            const currentDay = today.getDate();

            // Determine Cycle (Payday to Payday-1)
            let startDate, endDate;
            if (currentDay >= startDay) {
                startDate = new Date(today.getFullYear(), today.getMonth(), startDay);
                // Ends next month on startDay - 1
                // Handle edge case: if startDay is 1, end is 0 (last day of prev month? No)
                // If start 1: Jan 1 to Jan 31.
                // If start 25: Jan 25 to Feb 24.

                // Construct next month date
                let nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, startDay);
                nextMonth.setDate(nextMonth.getDate() - 1); // Subtract 1 day
                endDate = nextMonth;
            } else {
                // Previous cycle
                startDate = new Date(today.getFullYear(), today.getMonth() - 1, startDay);
                let thisMonth = new Date(today.getFullYear(), today.getMonth(), startDay);
                thisMonth.setDate(thisMonth.getDate() - 1);
                endDate = thisMonth;
            }

            // Set restriction: time components (00:00:00 vs 23:59:59)
            startDate.setHours(0, 0, 0, 0);
            endDate.setHours(23, 59, 59, 999);

            const totalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            const daysPassed = Math.ceil((today - startDate) / (1000 * 60 * 60 * 24));
            // Correct logic: if today is start date, passed is 0? No, should be 1?
            // Let's settle on: Days Left
            const daysLeft = Math.max(0, Math.ceil((endDate - today) / (1000 * 60 * 60 * 24)));
            const progressMonth = Math.min(100, Math.max(0, ((totalDays - daysLeft) / totalDays) * 100)); // Visual progress

            const rate = state.data.settings.rate;

            let totalFixedBudget = 0, totalFixedSpend = 0;
            let totalDiscBudget = 0, totalDiscSpend = 0;

            // Prepare Data
            const items = state.data.expenseCategories.map(cat => {
                const b = (state.data.budgets && state.data.budgets[cat]) || 0;
                const rollover = (state.data.budgetRollovers && state.data.budgetRollovers[cat]) || 0;
                const totalLimit = b + rollover;
                const isFixed = (state.data.fixedCategories || []).includes(cat);

                // Calc spend this cycle (Normalized to AED)
                const spend = state.data.transactions.filter(t => {
                    if (t.type !== 'expense' || t.category !== cat) return false;
                    const d = new Date(t.date);
                    return d >= startDate && d <= endDate;
                }).reduce((s, t) => {
                    const acc = state.data.accounts.find(a => a.id === t.accountId);
                    const cur = t.currency || acc?.currency || 'AED';
                    let val = parseFloat(t.amount);
                    if (cur !== 'AED') val = val / rate;
                    return s + window.toCurrency(val);
                }, 0);

                // Forecast
                // Daily avg based on DAYS PASSED in cycle
                const daysGone = totalDays - daysLeft;
                const dailyAvg = daysGone > 0 ? (spend / daysGone) : 0;
                const forecast = spend + (dailyAvg * daysLeft);
                const forecastPct = totalLimit > 0 ? (forecast / totalLimit) * 100 : 0;
                const currentPct = totalLimit > 0 ? (spend / totalLimit) * 100 : 0;

                if (isFixed) { totalFixedBudget += totalLimit; totalFixedSpend += spend; }
                else { totalDiscBudget += totalLimit; totalDiscSpend += spend; }

                return { cat, b, rollover, totalLimit, spend, isFixed, forecast, forecastPct, currentPct };
            });

            // GHOST EXPENSE: Inject BNPL Obligations
            let bnplLimit = 0;
            let bnplSpent = 0;
            state.data.debts.filter(d => d.isBnpl && !d.settled).forEach(d => {
                d.schedule.forEach(s => {
                    const sDate = new Date(s.date || s.dueDate);
                    // Check if due in this cycle
                    if (sDate >= startDate && sDate <= endDate) {
                        const amt = parseFloat(s.amount) * (d.currency === 'AED' ? 1 : (1 / rate));
                        bnplLimit += amt;
                        if (s.paid) bnplSpent += amt;
                    }
                });
            });

            if (bnplLimit > 0) {
                items.push({
                    cat: 'BNPL Commitments üõçÔ∏è',
                    b: bnplLimit,
                    rollover: 0,
                    totalLimit: bnplLimit,
                    spend: bnplSpent,
                    isFixed: true,
                    forecast: bnplLimit, // Obligatory
                    forecastPct: 100,
                    currentPct: (bnplSpent / bnplLimit) * 100
                });
                totalFixedBudget += bnplLimit;
                totalFixedSpend += bnplSpent;
            }

            // Calc Sinking Funds Lock
            const sinkingFunds = (state.data.sinkingFunds || []).map(f => {
                const due = new Date(f.date);
                const now = new Date();
                const diffTime = Math.abs(due - now);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const safeMonths = Math.max(1, Math.ceil(diffDays / 30));

                const monthly = f.target / safeMonths;
                return { ...f, monthly, months: safeMonths };
            });
            const totalSinkingLock = sinkingFunds.reduce((s, f) => {
                let v = f.monthly;
                if (f.currency === 'INR') v = v / rate;
                return s + v;
            }, 0);

            // Calc Safe Spend (Discretionary Only - Sinking Locks)
            const remainingDisc = Math.max(0, (totalDiscBudget - totalDiscSpend) - totalSinkingLock);
            const safeDaily = daysLeft > 0 ? (remainingDisc / daysLeft) : 0;

            // Separate lists
            const fixedItems = items.filter(i => i.isFixed);
            const discItems = items.filter(i => !i.isFixed);

            const renderItem = (i) => {
                const isOver = i.spend > i.totalLimit;
                const isTrendingOver = i.forecast > i.totalLimit;
                const alertLim = state.data.settings.budgetAlertLimit || 80;
                const color = isOver ? 'bg-red-500' : (i.currentPct > alertLim ? 'bg-amber-500' : 'bg-emerald-500');
                const canSweep = !i.isFixed && !isTrendingOver && i.spend > 0 && daysLeft < 10; // Only sweep near end of month or if safe

                return `<div class="bg-white p-5 rounded-[2rem] border shadow-sm relative overflow-hidden">
                    <div class="flex justify-between items-center mb-2 relative z-10">
                        <div class="flex items-center gap-2">
                             ${i.isFixed ? '<i data-lucide="lock" class="w-3 h-3 text-slate-300"></i>' : ''}
                             <p class="font-black text-slate-800">${i.cat}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs font-black text-slate-900 num-font mb-0.5">AED ${Math.round(i.spend).toLocaleString()} <span class="text-slate-400 font-sans tracking-normal">/ ${i.totalLimit.toLocaleString()}</span></p>
                            ${i.rollover > 0 ? `<p class="text-[8px] font-bold text-amber-500 uppercase">+AED ${Math.round(i.rollover)} Rollover</p>` : ''}
                        </div>
                    </div>
                    
                    <!-- Progress Bar Container -->
                    <div class="h-3 w-full bg-slate-100 rounded-full overflow-hidden relative mb-2">
                        <!-- Ghost Bar (Forecast) -->
                        <div class="absolute top-0 left-0 h-full bg-slate-200 transition-all duration-700 w-0" style="width: ${Math.min(100, i.forecastPct)}%"></div>
                        <!-- Month Line Marker -->
                        <div class="absolute top-0 h-full border-r-2 border-slate-300/50 z-20" style="left: ${progressMonth}%"></div>
                        <!-- Actual Spend -->
                        <div class="absolute top-0 left-0 h-full ${color} w-0 transition-all duration-1000 z-10" style="width: ${Math.min(100, i.currentPct)}%"></div>
                    </div>

                    <div class="flex justify-between items-center relative z-10">
                        <div class="flex gap-2">
                            <button onclick="window.setBudget('${i.cat}')" class="text-[9px] font-bold text-slate-400 hover:text-emerald-500 uppercase">Edit Limit</button>
                            ${canSweep ? `<button onclick="window.sweepBudget('${i.cat}', ${Math.max(0, i.totalLimit - i.spend)})" class="text-[9px] font-bold text-emerald-600 bg-emerald-50 px-2 rounded-full hover:bg-emerald-100 uppercase flex items-center gap-1"><i data-lucide="sparkles" class="w-3 h-3"></i> Sweep AED ${Math.round(i.totalLimit - i.spend)}</button>` : ''}
                        </div>
                        
                        ${isTrendingOver && !isOver ? `<p class="text-[8px] font-bold text-amber-500 uppercase animate-pulse">Trending Over (+AED ${Math.round(i.forecast - i.totalLimit)})</p>` :
                        `<p class="text-[9px] font-bold text-slate-400 uppercase">AED ${Math.max(0, i.totalLimit - i.spend).toLocaleString()} Left</p>`}
                    </div>
                </div>`;
            };

            return `<div class="max-w-xl mx-auto space-y-8">

                <!-- 0. BNPL ANALYZER (Tabby/Tamara) -->
                ${window.renderBNPLAnalyzer ? window.renderBNPLAnalyzer() : ''}

                <!-- 0.5 SINKING FUNDS MANAGER -->
                <div class="bg-indigo-900 text-white p-6 rounded-[2.5rem] shadow-xl relative overflow-hidden text-left mb-6">
                    <div class="flex justify-between items-center mb-4 relative z-10">
                         <h4 class="text-[10px] font-black uppercase text-indigo-200 tracking-widest flex items-center gap-2">
                            <i data-lucide="anchor" class="w-4 h-4"></i> Sinking Funds
                        </h4>
                        <button onclick="window.addSinkingFund()" class="bg-indigo-800 p-2 rounded-full hover:bg-indigo-700 text-[10px] font-bold uppercase transition-colors">
                            + Add Fund
                        </button>
                    </div>
                    <div class="relative z-10">
                        <h2 class="text-3xl font-black text-indigo-300 mb-1 num-font">AED ${Math.round(totalSinkingLock).toLocaleString()}</h2>
                        <p class="text-[10px] text-indigo-400 font-bold mb-4">Locked from Monthly Budget</p>
                        
                        <div class="space-y-3">
                            ${sinkingFunds.map(f => `
                            <div class="flex justify-between items-center bg-indigo-950/50 p-3 rounded-xl border border-indigo-800/50">
                                <div>
                                    <p class="font-bold text-xs text-indigo-100">${f.name}</p>
                                    <p class="text-[9px] text-indigo-400">Due in ${f.months} months</p>
                                </div>
                                <div class="text-right">
                                    <p class="font-black text-xs text-indigo-300 num-font mb-0.5">${f.currency || 'AED'} ${Math.round(f.monthly)}/mo</p>
                                     <button onclick="window.deleteSinkingFund('${f.id}')" class="text-[8px] text-indigo-500 hover:text-red-400 uppercase">Remove</button>
                                </div>
                            </div>`).join('') || '<p class="text-indigo-400/50 text-xs italic text-center py-2">No active sinking funds</p>'}
                        </div>
                    </div>
                    <i data-lucide="piggy-bank" class="absolute -right-4 -bottom-4 text-white/5 w-32 h-32"></i>
                </div>
                
                <!-- 1. VELOCITY CARD -->
                <div class="bg-slate-900 text-white p-8 rounded-[3rem] shadow-xl text-center relative overflow-hidden">
                    <button onclick="window.runImpulseTest()" class="absolute top-6 right-6 text-slate-500 hover:text-white transition-colors z-20" title="Impulse Test"><i data-lucide="timer" class="w-5 h-5"></i></button>
                    <div class="relative z-10">
                        <p class="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-1">Daily Safe Spend</p>
                        <h2 class="text-4xl font-black text-emerald-400 mb-1 num-font">AED ${Math.floor(safeDaily).toLocaleString()}<span class="text-sm text-slate-500 font-sans tracking-normal ml-1">/day</span></h2>
                        <p class="text-[10px] font-bold text-slate-500 mt-2">${daysLeft} Days Left ‚Ä¢ AED ${Math.round(remainingDisc).toLocaleString()} Available</p>
                    </div>
                    <div class="absolute -right-4 -bottom-4 opacity-10"><i data-lucide="activity" class="w-32 h-32"></i></div>
                </div>

                <!-- 2. FIXED OBLIGATIONS -->
                ${fixedItems.length > 0 ? `
                <div>
                     <h4 class="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-4 ml-4">Fixed Obligations</h4>
                     <div class="space-y-4 opacity-80 hover:opacity-100 transition-opacity">
                        ${fixedItems.map(renderItem).join('')}
                     </div>
                </div>` : ''}

                <!-- 3. DISCRETIONARY -->
                <div>
                    <div class="flex justify-between items-center mb-4 px-4">
                        <h4 class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Discretionary</h4>
                        <button onclick="window.openBudgetSettings()" class="bg-slate-100 text-slate-500 p-2 rounded-full hover:bg-slate-200"><i data-lucide="settings-2" class="w-4 h-4"></i></button>
                    </div>
                    <div class="space-y-4">
                        ${discItems.map(renderItem).join('')}
                    </div>
                </div>
            </div>`;
        };

        // Global Alias for BNPL Settlement (Moved from renderDebtUI)
        window.openBnplSettleModal = function (id, idx) {
            const d = state.data.debts.find(x => x.id === id);
            if (!d || !d.schedule[idx]) return;

            const inst = d.schedule[idx];
            const amt = inst.amount;

            window.showConfirm("Process Settlement", `
                <div class="space-y-4 text-left">
                    <div class="bg-indigo-50 p-4 rounded-xl text-center">
                        <p class="text-[10px] uppercase font-black text-indigo-400">Payment Amount</p>
                        <h3 class="text-3xl font-black text-indigo-600">${amt} <span class="text-xs text-indigo-400">${d.currency}</span></h3>
                        <p class="text-[10px] font-bold text-indigo-400 mt-1">${d.party} ‚Ä¢ Installment ${idx + 1}/${d.installments}</p>
                    </div>
                    
                    <div>
                            <label class="text-[9px] font-bold text-slate-400 uppercase ml-1">Paid From</label>
                            <select id="bnpl-pay-acc" class="w-full p-3 bg-slate-50 border rounded-xl font-bold text-xs outline-none focus:border-indigo-500">
                                ${state.data.accounts.filter(a => ['Bank Account', 'Cash', 'Wallet'].includes(a.type)).map(a =>
                `<option value="${a.id}">${a.name} (${window.toCurrency(a.balance)} ${a.currency})</option>`
            ).join('')}
                            </select>
                    </div>

                    <div>
                        <label class="text-[9px] font-bold text-slate-400 uppercase ml-1">Date Paid</label>
                        <input type="date" id="bnpl-pay-date" value="${new Date().toISOString().split('T')[0]}" class="w-full p-3 bg-slate-50 border rounded-xl font-bold text-xs outline-none focus:border-indigo-500">
                    </div>

                        <div>
                        <label class="text-[9px] font-bold text-slate-400 uppercase ml-1">Note</label>
                        <input type="text" id="bnpl-pay-note" value="Paid ${d.party} Installment ${idx + 1}" class="w-full p-3 bg-slate-50 border rounded-xl font-bold text-xs outline-none focus:border-indigo-500">
                    </div>
                </div>
            `, async () => {
                // Action Callback
                const accId = document.getElementById('bnpl-pay-acc').value;
                const dateVal = document.getElementById('bnpl-pay-date').value;
                const note = document.getElementById('bnpl-pay-note').value;
                const acc = state.data.accounts.find(a => a.id === accId);

                if (!acc) return;

                // 1. Mark Paid
                inst.paid = true;
                inst.status = 'paid'; // FIXED: Explicitly set status string to break visibility loop
                // Recalculate current amount to be safe from float drift
                let remaining = 0;
                d.schedule.forEach(s => { if (!s.paid) remaining += parseFloat(s.amount); });
                d.currentAmount = remaining;

                if (d.currentAmount < 0.1) { d.currentAmount = 0; d.settled = true; }

                // 2. Prepare Transaction Data
                const finalAmt = parseFloat(amt);
                const baseAmt = (acc.currency === 'AED') ? finalAmt : (finalAmt / state.data.settings.rate);

                // Date Logic: Use current time if selected date is Today (for Sorting Visibility)
                const selDate = new Date(dateVal);
                const today = new Date();
                let finalDateIso = selDate.toISOString();
                if (selDate.toDateString() === today.toDateString()) {
                    finalDateIso = today.toISOString();
                }

                // Note Logic: Append original amount if currency converted
                let finalNote = note;
                if (Math.abs(baseAmt - finalAmt) > 0.01) {
                    finalNote += ` (Paid ${finalAmt} ${d.currency})`;
                }

                // 3. Log Transaction (Handles State Push + DB Save + Recalc Balances)
                // We save the amount in the ACCOUNT'S Check currency to ensure the Ledger subtracts correctly.
                await window.saveTransaction({
                    id: window.genId(),
                    accountId: acc.id,
                    type: 'expense',
                    amount: window.toCurrency(baseAmt),
                    currency: acc.currency,
                    category: 'BNPL Payment',
                    note: finalNote,
                    date: finalDateIso,
                    debtId: d.id,
                    tags: ['#BNPL']
                });

                // 4. UI Refresh
                window.renderApp();

                // Refresh Modal Content (Instant Feedback)
                const modalContent = document.getElementById('modal-content');
                if (modalContent) { modalContent.innerHTML = window.renderDebtUI(); lucide.createIcons(); }

                window.showToast("Payment Recorded Successfully", "success");

            }, "Confirm Payment");
        };
        window.settleInstallment = window.openBnplSettleModal;

        // Initialize (re-call just in case it was missed, though existing call should be fine)
        if (window.init) window.init();

    </script>
</body>

</html>
