<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finshaanire | Wealth Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        :root { --primary: #10b981; --bg-main: #f8fafc; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-main); overflow-x: hidden; }
        .fs-logo { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid var(--primary); border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #app-content, #auth-screen { display: none; }
        .btn-action:active { transform: scale(0.95); }
        .rate-live { animation: pulse-green 2s infinite; }
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
    </style>
</head>
<body class="text-slate-800 text-center">

    <!-- 1. AUTH SCREEN -->
    <div id="auth-screen" class="min-h-screen flex flex-col items-center justify-center p-6 bg-white">
        <div class="w-full max-w-md space-y-10 text-center">
            <div>
                <div class="fs-logo w-20 h-20 rounded-2xl flex items-center justify-center text-white font-black text-4xl mx-auto mb-6 shadow-xl shadow-emerald-500/20">FS</div>
                <h1 class="text-4xl font-extrabold tracking-tight text-slate-900 text-center">Finshaanire</h1>
                <p class="text-slate-500 mt-2 font-medium text-center">Wealth Management and Budgeting.</p>
            </div>
            <div class="bg-white p-8 rounded-3xl shadow-2xl border border-slate-100 space-y-6 text-center">
                <div id="auth-error-msg" class="hidden p-4 bg-red-50 text-red-700 text-xs font-bold rounded-2xl border border-red-100 text-center"></div>
                <div class="space-y-4 text-left">
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-widest ml-1 text-center">Email</label>
                        <input type="email" id="login-email" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none text-center" placeholder="name@email.com">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-widest ml-1 text-center">Password</label>
                        <input type="password" id="login-pass" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none transition-all text-center" placeholder="••••••••">
                    </div>
                </div>
                <div class="space-y-3 text-center">
                    <button id="login-btn" onclick="window.handleLogin()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold hover:bg-emerald-600 transition-all shadow-lg flex items-center justify-center space-x-2 text-center text-center">
                        <span id="btn-text">Sign In</span>
                        <div id="btn-loader" class="hidden loader border-white"></div>
                    </button>
                    <button onclick="window.handleRegister()" class="w-full py-2 text-sm text-slate-400 hover:text-emerald-600 font-bold transition-all text-center text-center">Create Account</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. MAIN DASHBOARD -->
    <div id="app-content" class="min-h-screen flex flex-col">
        <nav class="bg-white border-b border-slate-200 h-20 flex-shrink-0 sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-6 h-full flex justify-between items-center text-center">
                <div class="flex items-center space-x-4 text-left">
                    <div class="fs-logo w-10 h-10 rounded-xl flex items-center justify-center text-white font-black text-xl text-center">FS</div>
                    <span class="text-2xl font-black tracking-tight text-slate-900 text-center">Finshaanire</span>
                </div>
                <div class="flex items-center space-x-4 text-center">
                    <div id="exchange-rate-badge" class="hidden md:flex bg-emerald-50 text-emerald-700 px-4 py-2 rounded-full text-xs font-bold border border-emerald-100 text-center">
                        <span class="opacity-60 mr-1 uppercase text-[9px]">Live Rate:</span> 
                        <span id="rate-display">22.75</span> 
                        <span class="ml-1 opacity-60 uppercase text-[9px]">INR</span>
                    </div>
                    <button onclick="window.openModal('auth')" class="flex items-center space-x-2 bg-slate-50 px-3 py-2 rounded-xl border border-slate-200 text-slate-600 font-bold text-xs uppercase tracking-widest text-center text-center">
                        <i data-lucide="user" class="w-4 h-4 text-center"></i> <span id="user-label">Profile</span>
                    </button>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto px-6 py-8 w-full flex-grow space-y-8 text-center text-center">
            <!-- Dues Notifications -->
            <section id="notification-panel" class="hidden fade-in space-y-4 text-center">
                <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest px-2 flex items-center justify-center lg:justify-start text-center">
                    <i data-lucide="bell" class="w-3 h-3 mr-2 text-amber-500 text-center"></i> Action Required
                </h3>
                <div id="upcoming-dues-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-center"></div>
            </section>

            <!-- Summary -->
            <section class="grid grid-cols-1 lg:grid-cols-3 gap-8 text-center">
                <div class="lg:col-span-2 bg-white rounded-[2.5rem] p-10 border border-slate-200 flex flex-col justify-between shadow-sm relative overflow-hidden text-center">
                    <div class="flex justify-between items-start text-center">
                        <div class="text-left text-center">
                            <p class="text-slate-400 text-[10px] font-black uppercase tracking-widest text-left">Current Net Wealth</p>
                            <div class="flex items-baseline space-x-4 text-left">
                                <span id="total-primary" class="text-4xl md:text-6xl font-black tracking-tighter text-slate-900 text-left">₹0.00</span>
                                <span id="total-secondary" class="text-xl font-bold text-teal-600/60 text-left">AED 0.00</span>
                            </div>
                        </div>
                        <div class="flex space-x-2 text-center text-center">
                            <button onclick="window.openModal('budget')" class="p-3 bg-slate-50 hover:bg-slate-100 rounded-2xl border border-slate-200 text-slate-400 text-center" title="Budgeting"><i data-lucide="target" class="w-5 h-5 mx-auto text-center"></i></button>
                            <button onclick="window.openModal('analytics')" class="p-3 bg-slate-50 hover:bg-slate-100 rounded-2xl border border-slate-200 text-slate-400 text-center" title="Charts"><i data-lucide="pie-chart" class="w-5 h-5 mx-auto text-center"></i></button>
                            <button onclick="window.toggleVisibility()" class="p-3 bg-slate-50 hover:bg-slate-100 rounded-2xl border border-slate-200 text-slate-400 text-center"><i data-lucide="eye" id="vis-icon" class="w-5 h-5 mx-auto text-center"></i></button>
                            <button onclick="window.openModal('settings')" class="p-3 bg-slate-50 hover:bg-slate-100 rounded-2xl border border-slate-200 text-slate-400 text-center"><i data-lucide="settings" class="w-5 h-5 mx-auto text-center"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mt-12 border-t border-slate-100 pt-8 text-center text-center text-center">
                        <div><p class="text-[9px] uppercase font-black text-slate-400 mb-1 text-center">UAE Vault</p><p id="uae-val" class="font-bold text-lg text-slate-800 text-center">AED 0.00</p></div>
                        <div><p class="text-[9px] uppercase font-black text-slate-400 mb-1 text-center">India Portfolio</p><p id="india-val" class="font-bold text-lg text-slate-800 text-center">₹0.00</p></div>
                        <div><p class="text-[9px] uppercase font-black text-slate-400 mb-1 text-red-500 text-center">I Owe</p><p id="pay-val" class="font-bold text-lg text-red-500 text-center">₹0.00</p></div>
                        <div><p class="text-[9px] uppercase font-black text-slate-400 mb-1 text-emerald-600 text-center">Investments</p><p id="inv-val" class="font-bold text-lg text-emerald-600 text-center">₹0.00</p></div>
                    </div>
                </div>

                <div class="bg-white rounded-[2.5rem] p-8 border border-slate-200 flex flex-col justify-between shadow-sm text-center">
                    <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest flex items-center mb-6 justify-center lg:justify-start text-center"><i data-lucide="layout-grid" class="w-4 h-4 mr-2 text-center text-center text-center"></i> Navigation</h3>
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <button onclick="window.openModal('transaction')" class="flex flex-col items-center justify-center p-6 rounded-3xl bg-emerald-500 text-white shadow-lg active:scale-95 transition-all text-center">
                            <i data-lucide="plus" class="w-6 h-6 mb-2 mx-auto text-center"></i><span class="text-[10px] font-black uppercase tracking-widest text-center">Entry</span>
                        </button>
                        <button onclick="window.openModal('transfer')" class="flex flex-col items-center justify-center p-6 rounded-3xl bg-slate-900 text-white shadow-lg active:scale-95 transition-all text-center">
                            <i data-lucide="arrow-right-left" class="w-6 h-6 mb-2 mx-auto text-center"></i><span class="text-[10px] font-black uppercase tracking-widest text-center">Transfer</span>
                        </button>
                        <button onclick="window.openModal('accounts')" class="flex flex-col items-center justify-center p-6 rounded-3xl border-2 border-slate-100 hover:bg-slate-50 text-slate-600 active:scale-95 transition-all text-center">
                            <i data-lucide="wallet" class="w-6 h-6 mb-2 mx-auto text-emerald-600 text-center"></i><span class="text-[10px] font-black uppercase text-center text-center">Asset</span>
                        </button>
                        <button onclick="window.openModal('debt')" class="flex flex-col items-center justify-center p-6 rounded-3xl border-2 border-slate-100 hover:bg-slate-50 text-slate-600 active:scale-95 transition-all text-center">
                            <i data-lucide="users" class="w-6 h-6 mb-2 mx-auto text-amber-500 text-center"></i><span class="text-[10px] font-black uppercase text-center">Debts</span>
                        </button>
                    </div>
                </div>
            </section>

            <!-- Tables -->
            <section class="grid grid-cols-1 lg:grid-cols-2 gap-8 text-left text-center">
                <div>
                    <h3 class="flex items-center font-black text-slate-400 text-[11px] uppercase tracking-widest px-2 mb-4 justify-center lg:justify-start text-center"><img src="https://flagcdn.com/ae.svg" class="w-5 h-3.5 mr-2 rounded shadow-sm text-center"> UAE Vault</h3>
                    <div id="uae-list" class="grid gap-4 text-center"></div>
                </div>
                <div>
                    <h3 class="flex items-center font-black text-slate-400 text-[11px] uppercase tracking-widest px-2 mb-4 justify-center lg:justify-start text-center text-center text-center"><img src="https://flagcdn.com/in.svg" class="w-5 h-3.5 mr-2 rounded shadow-sm text-center text-center"> India Portfolio</h3>
                    <div id="india-list" class="grid gap-4 text-center text-center"></div>
                </div>
            </section>

            <section class="bg-white rounded-[2.5rem] border border-slate-200 overflow-hidden shadow-sm text-center text-center">
                <div class="px-8 py-6 border-b border-slate-100 flex justify-between items-center text-center text-center">
                    <h3 class="font-black text-slate-800 text-sm uppercase tracking-widest flex items-center text-center text-center text-center"><i data-lucide="history" class="w-4 h-4 mr-2 text-emerald-500 mx-auto text-center text-center"></i> Ledger</h3>
                    <button onclick="window.openModal('reports')" class="text-[10px] font-black text-emerald-600 uppercase tracking-widest hover:underline text-center text-center">Export Full</button>
                </div>
                <div class="overflow-x-auto text-center">
                    <table class="w-full text-left text-center text-center text-center">
                        <thead>
                            <tr class="text-[9px] uppercase tracking-widest text-slate-400 bg-slate-50/50 text-center text-center">
                                <th class="px-6 py-4 font-black text-left text-center">Date</th>
                                <th class="px-6 py-4 font-black text-left text-center">Details</th>
                                <th class="px-6 py-4 font-black text-center text-center">Account</th>
                                <th class="px-6 py-4 font-black text-right text-center text-center">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="master-ledger-body" class="divide-y divide-slate-100 text-center text-center text-center"></tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <div id="reminder-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[110] hidden items-center justify-center p-6 text-center text-center text-center">
        <div class="bg-white rounded-[2.5rem] w-full max-w-md shadow-2xl p-8 space-y-6 border-t-8 border-amber-500 fade-in text-center text-center text-center text-center">
            <div class="flex items-center justify-center space-x-4 text-center">
                <div class="bg-amber-50 p-3 rounded-2xl text-amber-600 mx-auto text-center text-center"><i data-lucide="bell-ring" class="w-8 h-8 mx-auto text-center text-center"></i></div>
                <div class="text-left text-center text-center"><h2 class="text-xl font-black text-slate-900 tracking-tight text-left">Due Today</h2><p class="text-sm text-slate-500 text-left text-center text-center">A settlement target reached.</p></div>
            </div>
            <div id="reminder-details" class="bg-slate-50 p-6 rounded-3xl space-y-2 font-bold text-slate-700 text-center text-center"></div>
            <div class="grid grid-cols-2 gap-4 text-center">
                <button id="remit-settle-btn" class="bg-emerald-500 text-white py-4 rounded-2xl font-bold shadow-lg text-center text-center">Settle Now</button>
                <button id="remit-resched-btn" class="bg-slate-100 text-slate-600 py-4 rounded-2xl font-bold text-center text-center text-center">Later</button>
            </div>
            <button onclick="window.closeReminder()" class="w-full text-xs font-bold text-slate-400 uppercase tracking-widest text-center text-center text-center">Ignore</button>
        </div>
    </div>

    <div id="modal-backdrop" class="fixed inset-0 bg-white z-[100] hidden flex-col overflow-hidden text-center text-center">
        <div class="h-20 bg-white border-b border-slate-100 px-6 flex justify-between items-center text-center">
            <div class="flex items-center space-x-3 text-center text-center text-center text-center">
                <button onclick="window.closeModal()" class="p-3 bg-slate-50 rounded-2xl text-slate-600 hover:bg-slate-100 transition-all mr-2 text-center text-center text-center text-center text-center">
                    <i data-lucide="arrow-left" class="w-6 h-6 mx-auto text-center text-center text-center text-center text-center"></i>
                </button>
                <h2 id="modal-title" class="text-2xl font-black text-slate-900 tracking-tight text-left text-center text-center text-center text-center text-center">Title</h2>
            </div>
            <button onclick="window.closeModal()" class="p-3 text-slate-400 hover:text-slate-600 text-center text-center text-center text-center">
                <i data-lucide="x" class="w-8 h-8 mx-auto text-center text-center"></i>
            </button>
        </div>
        <div id="modal-content" class="flex-grow p-8 max-w-4xl mx-auto w-full overflow-y-auto custom-scrollbar fade-in text-center text-center text-center"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCbYXBMRtIDhB49nQexCTHQY2YPeInHLJ8", authDomain: "my-finance-454c2.firebaseapp.com", projectId: "my-finance-454c2", storageBucket: "my-finance-454c2.firebasestorage.app", messagingSenderId: "18874709232", appId: "1:18874709232:web:b9b007e07042fb0cf87e35" };
        const app = initializeApp(firebaseConfig); 
        const auth = getAuth(app); 
        const db = getFirestore(app); 
        const appId = 'finshaanire-v2';

        let state = { user: null, data: { accounts: [], transactions: [], debts: [], budgets: {}, settings: { rate: 22.75, isPrivate: false }, incomeCategories: ['Salary', 'Bonus', 'Investment Return', 'Other'], expenseCategories: ['Rent', 'Food', 'Utilities', 'Investment', 'Family', 'Other'], assetTypes: ['Bank Account', 'Cash', 'Savings', 'Investment'] } };

        // --- GLOBAL FUNCTION ASSIGNMENTS ---
        window.closeModal = () => document.getElementById('modal-backdrop').classList.replace('flex', 'hidden');
        window.closeReminder = () => document.getElementById('reminder-overlay').classList.add('hidden');
        window.updateDb = async () => { if (!state.user) return; await setDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'finance', 'main'), state.data); };
        
        // Math Helper: Ensures strict 2 decimal places to avoid floating point errors (e.g. 0.1 + 0.2 = 0.3000004)
        window.toCurrency = (num) => parseFloat(Number(num).toFixed(2));
        
        // ID Helper: Generates robust unique IDs
        window.genId = () => Date.now().toString() + '_' + Math.floor(Math.random() * 1000);

        // Helper: Toggle Button State to prevent double-clicks
        window.setBtnLoading = (btnId, isLoading) => {
            const btn = document.getElementById(btnId);
            if (!btn) return;
            if (isLoading) {
                btn.disabled = true;
                btn.dataset.originalText = btn.innerText;
                btn.innerText = "Processing...";
                btn.classList.add('opacity-70', 'cursor-not-allowed');
            } else {
                btn.disabled = false;
                if(btn.dataset.originalText) btn.innerText = btn.dataset.originalText;
                btn.classList.remove('opacity-70', 'cursor-not-allowed');
            }
        };

        // SIGN OUT FIX: Added a global handler for sign out
        window.handleSignOut = async function() {
            try {
                await signOut(auth);
                location.reload();
            } catch (err) {
                console.error("Sign out error", err);
            }
        };

        // --- CORE APPLICATION FUNCTIONS ---

        function checkDueDebts() {
            const today = new Date().toISOString().split('T')[0];
            const due = state.data.debts.find(d => !d.settled && d.repaymentDate && d.repaymentDate <= today);
            if (due) {
                const overlay = document.getElementById('reminder-overlay'), details = document.getElementById('reminder-details');
                if (overlay && details) {
                    details.innerHTML = `<p class="text-xl font-bold">${due.amount} ${due.currency}</p><p class="text-sm font-medium text-slate-500">Party: ${due.party}</p>`;
                    document.getElementById('remit-settle-btn').onclick = () => window.openSettleFlow(due.id);
                    document.getElementById('remit-resched-btn').onclick = () => window.openRescheduleFlow(due.id);
                    overlay.classList.replace('hidden', 'flex'); lucide.createIcons();
                }
            }
        }
        window.checkDueDebts = checkDueDebts;

        async function fetchExchangeRate() {
            try {
                const res = await fetch('https://api.exchangerate-api.com/v4/latest/AED');
                const d = await res.json();
                if (d.rates && d.rates.INR) {
                    state.data.settings.rate = d.rates.INR;
                    document.getElementById('exchange-rate-badge')?.classList.add('rate-live');
                    window.renderApp();
                }
            } catch (e) { console.warn("Live rate unavailable."); }
        }
        window.fetchExchangeRate = fetchExchangeRate;

        function renderApp() {
            const dashboard = document.getElementById('app-content'); if (!dashboard || dashboard.style.display === 'none') return;
            const { accounts, transactions, debts, settings } = state.data;
            const r = settings.rate, priv = settings.isPrivate;
            const ut = (id, val) => { const el = document.getElementById(id); if (el) el.innerText = val; };
            ut('rate-display', r.toFixed(2));
            let uae = 0, ind = 0, inv = 0;
            accounts.forEach(a => { if (a.currency === 'AED') uae += a.balance; else ind += a.balance; if (!['Bank Account', 'Cash'].includes(a.type)) inv += (a.currency === 'AED' ? a.balance * r : a.balance); });
            const pay = debts.filter(d=>!d.settled && d.type==='payable').reduce((s,d)=>s+(Number(d.amount)*(d.currency==='AED'?r:1)),0), rec = debts.filter(d=>!d.settled && d.type==='receivable').reduce((s,d)=>s+(Number(d.amount)*(d.currency==='AED'?r:1)),0);
            const net = (uae * r) + ind + rec - pay;
            const fmt = (v, c) => priv ? '••••••' : new Intl.NumberFormat('en-US', { style: 'currency', currency: c }).format(v);
            ut('total-primary', fmt(net, 'INR')); ut('total-secondary', `AED ${priv ? '••••' : (net/r).toFixed(2)}`);
            ut('uae-val', fmt(uae, 'AED')); ut('india-val', fmt(ind, 'INR')); ut('pay-val', fmt(pay, 'INR')); ut('inv-val', fmt(inv, 'INR'));
            if (state.user) document.getElementById('user-label').innerText = state.user.email.split('@')[0];
            window.renderAssetsList('uae', accounts.filter(a => a.currency === 'AED'));
            window.renderAssetsList('india', accounts.filter(a => a.currency === 'INR'));
            window.renderLedger(transactions);
            window.renderNotifications();
            lucide.createIcons();
        }
        window.renderApp = renderApp;

        function renderNotifications() {
            const list = document.getElementById('upcoming-dues-list'), panel = document.getElementById('notification-panel');
            if (!list) return;
            const limit = new Date(); limit.setDate(new Date().getDate() + 2);
            const upcoming = state.data.debts.filter(d => !d.settled && d.repaymentDate && new Date(d.repaymentDate) <= limit).sort((a,b) => new Date(a.repaymentDate) - new Date(b.repaymentDate));
            if (upcoming.length === 0) { panel.classList.add('hidden'); return; }
            panel.classList.remove('hidden');
            list.innerHTML = upcoming.map(d => `<div class="bg-white p-4 rounded-2xl border-l-4 ${d.type==='receivable'?'border-emerald-500':'border-amber-500'} shadow-sm flex flex-col justify-between text-center"><div class="flex justify-between items-start mb-3 text-center"><div class="text-left text-center"><p class="text-[8px] font-black uppercase text-slate-400 mb-0.5">${d.type==='receivable'?'Money In':'Money Out'}</p><p class="font-bold text-slate-800 text-sm text-center">${d.party}</p><p class="text-[9px] font-bold text-slate-400 uppercase text-center text-center">Target: ${d.repaymentDate}</p></div><p class="font-black text-slate-900">${d.amount} ${d.currency}</p></div><div class="grid grid-cols-2 gap-2 text-center text-center"><button onclick="window.openSettleFlow('${d.id}')" class="bg-emerald-500 text-white py-1.5 rounded-lg text-[9px] font-bold uppercase shadow-sm text-center text-center">Settle</button><button onclick="window.openRescheduleFlow('${d.id}')" class="bg-slate-50 text-slate-600 py-1.5 rounded-lg text-[9px] font-bold uppercase text-center text-center">Later</button></div></div>`).join('');
        }
        window.renderNotifications = renderNotifications;

        function renderAssetsList(reg, items) {
            const container = document.getElementById(`${reg}-list`); if (!container) return;
            if (items.length === 0) { container.innerHTML = `<div class="p-8 border border-dashed border-slate-100 rounded-[2rem] text-center text-slate-300 uppercase text-[10px] font-black">No accounts</div>`; return; }
            container.innerHTML = items.map(a => `<div class="bg-white p-4 rounded-2xl flex justify-between items-center border border-slate-100 shadow-sm cursor-pointer hover:bg-slate-50 transition-all text-center text-center" onclick="window.viewAccountLedger('${a.id}')"><div class="flex items-center space-x-3 text-left text-center"><div class="fs-logo w-9 h-9 rounded-xl flex items-center justify-center text-white text-center text-center text-center"><i data-lucide="layers" class="w-4 h-4 mx-auto text-center text-center"></i></div><div><p class="font-bold text-slate-900 text-sm text-left text-center">${a.name}</p><p class="text-[8px] text-slate-400 uppercase font-black text-left text-center">${a.type}</p></div></div><div class="text-right text-center text-center"><p class="font-black text-slate-900 text-sm">${state.data.settings.isPrivate ? '••••' : a.balance.toFixed(2)}</p><span class="text-[8px] font-black text-emerald-600 uppercase">${a.currency}</span></div></div>`).join('');
        }
        window.renderAssetsList = renderAssetsList;

        function renderLedger(items) {
            const body = document.getElementById('master-ledger-body'); if (!body) return;
            const sorted = [...items].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 10);
            body.innerHTML = sorted.map(t => {
                let accName = 'N/A';
                if (t.accountId === 'virtual_writeoff') {
                    accName = 'Write-off Record';
                } else {
                    accName = state.data.accounts.find(a=>a.id===t.accountId)?.name||'N/A';
                }
                const isTransfer = t.type.includes('transfer');
                const isIncome = t.type === 'income' || t.type === 'transfer_in';
                const colorClass = isTransfer ? 'text-slate-500' : (isIncome ? 'text-emerald-500' : 'text-red-400');
                const sign = isIncome ? '+' : '-';
                const displayType = isTransfer ? (t.type === 'transfer_in' ? 'Inflow' : 'Outflow') : (t.type === 'income' ? 'Income' : 'Expense');
                
                return `<tr class="hover:bg-slate-50 text-center">
                    <td class="px-6 py-4 text-left">
                        <p class="text-xs font-bold text-slate-800">${new Date(t.date).toLocaleDateString()}</p>
                        <p class="text-[9px] font-black text-slate-400 uppercase">${new Date(t.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                    </td>
                    <td class="px-6 py-4 text-left">
                        <p class="text-xs font-bold text-slate-800">${t.category || displayType}</p>
                        <p class="text-[10px] text-slate-400 font-medium truncate max-w-[120px]">${t.note || '-'}</p>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <span class="text-[9px] font-black uppercase px-2 py-0.5 bg-slate-100 text-slate-500 rounded-full">${accName}</span>
                    </td>
                    <td class="px-6 py-4 text-right font-black ${colorClass}">
                        ${sign}${state.data.settings.isPrivate?'••••':t.amount.toFixed(2)}
                    </td>
                </tr>`;
            }).join('');
        }
        window.renderLedger = renderLedger;

        // --- MODAL VIEWS ---

        window.openModal = function(type) {
            const b = document.getElementById('modal-backdrop'), t = document.getElementById('modal-title'), c = document.getElementById('modal-content');
            b.classList.replace('hidden', 'flex');
            switch(type) {
                // FIXED: Sign Out button now uses window.handleSignOut()
                case 'auth': t.innerText = 'System Profile'; c.innerHTML = `<div class="space-y-8 py-10 text-center"><div class="fs-logo w-24 h-24 rounded-3xl flex items-center justify-center text-white font-black text-4xl mx-auto shadow-xl text-center">FS</div><p class="font-black text-xl text-slate-800 text-center">${state.user.email}</p><button onclick="window.handleSignOut()" class="w-full max-w-sm mx-auto bg-slate-900 text-white p-5 rounded-3xl font-black uppercase text-sm text-center">Sign Out</button></div>`; break;
                case 'accounts': t.innerText = 'Asset Registration'; c.innerHTML = `<div class="max-w-md mx-auto bg-slate-50 p-10 rounded-[3rem] border text-center text-center"><input type="text" id="an" placeholder="Identifier" class="w-full p-4 border rounded-xl font-bold mb-4 outline-none focus:border-emerald-500"><div class="grid grid-cols-2 gap-4 mb-4 text-center"><select id="ac" class="p-4 border rounded-xl font-bold text-center text-center text-center"><option value="AED">AED</option><option value="INR">INR</option></select><select id="at" class="p-4 border rounded-xl font-bold text-center text-center text-center">${state.data.assetTypes.map(ty=>`<option value="${ty}">${ty}</option>`).join('')}</select></div><input type="number" id="ab" step="0.01" placeholder="Initial Volume" class="w-full p-4 border rounded-xl font-black mb-6 text-center text-center"><button id="btn-save-acc" onclick="window.saveAccount()" class="w-full bg-emerald-500 text-white p-4 rounded-2xl font-black uppercase shadow-lg text-center text-center">Commit Node</button></div>`; break;
                case 'transaction': t.innerText = 'Data Movement'; c.innerHTML = `<div class="max-w-md mx-auto bg-white p-10 rounded-[3rem] border shadow-xl text-center"><div class="grid grid-cols-2 gap-4 mb-6 text-center text-center"><button id="be" onclick="window.setT('expense')" class="p-4 rounded-xl border-4 border-emerald-500 bg-emerald-50 text-emerald-700 font-black text-xs uppercase">Expense</button><button id="bi" onclick="window.setT('income')" class="p-4 rounded-xl border-4 border-slate-100 text-slate-300 font-black text-xs uppercase">Income</button></div><input type="hidden" id="tt" value="expense"><select id="ta" class="w-full p-4 border rounded-xl font-bold mb-4 text-center text-center">${state.data.accounts.map(a=>`<option value="${a.id}">${a.name} (${a.currency})</option>`).join('')}</select><div class="grid grid-cols-2 gap-4 mb-4 text-center text-center"><select id="tc" class="p-4 border rounded-xl font-bold text-sm text-center">${state.data.expenseCategories.map(cat=>`<option value="${cat}">${cat}</option>`).join('')}</select><input type="number" id="tam" placeholder="0.00" class="p-4 border rounded-xl font-black text-center focus:border-emerald-500"></div><input type="text" id="tn" placeholder="Note" class="w-full p-4 border rounded-xl mb-6 outline-none focus:border-emerald-500"><button id="btn-save-tx" onclick="window.saveTransaction()" class="w-full bg-slate-900 text-white p-4 rounded-2xl font-black uppercase shadow-lg text-center text-center">Authorize entry</button></div>`; break;
                case 'transfer': t.innerText = 'Transfer & Invest'; c.innerHTML = `<div class="max-w-lg mx-auto bg-white p-10 rounded-[3rem] border shadow-2xl text-center text-center text-center text-center text-center text-center"><div class="grid grid-cols-2 gap-4 mb-6 text-center text-center text-center text-center"><div><label class="text-[9px] font-black uppercase text-slate-400 block mb-1 text-left ml-2 text-center text-center">From (Source)</label><select id="ts" class="w-full p-4 border rounded-xl font-bold text-center text-center text-center">${state.data.accounts.map(a=>`<option value="${a.id}">${a.name} (${a.currency})</option>`).join('')}</select></div><div><label class="text-[9px] font-black uppercase text-slate-400 block mb-1 text-left ml-2 text-center text-center">To (Dest)</label><select id="ttg" class="w-full p-4 border rounded-xl font-bold text-center text-center text-center">${state.data.accounts.map(a=>`<option value="${a.id}">${a.name} (${a.currency})</option>`).join('')}</select></div></div><input type="number" id="tamt" oninput="window.calcRemit(this.value)" class="w-full p-6 border-2 rounded-2xl font-black text-3xl text-center mb-4 text-center outline-none focus:border-emerald-500" placeholder="Sending Amount"><div id="remit-preview" class="text-xs font-black text-emerald-600 mb-6 h-4 text-center text-center"></div><input type="text" id="trn" placeholder="Transfer Node / Description" class="w-full p-4 border rounded-xl mb-6 text-center outline-none focus:border-emerald-500"><button id="btn-do-transfer" onclick="window.doTransfer()" class="w-full bg-emerald-500 text-white p-5 rounded-2xl font-black uppercase shadow-xl text-center text-center">Authorize Transfer</button><p class="mt-4 text-[10px] text-slate-400 font-bold">Use this to move funds to Investment Accounts or Remit.</p></div>`; break;
                case 'debt': t.innerText = 'Liability Management'; c.innerHTML = window.renderDebtUI(); break;
                case 'settings': t.innerText = 'Configuration Hub'; c.innerHTML = window.renderSettingsUI(); break;
                case 'reports': t.innerText = 'Summaries'; c.innerHTML = window.renderDistributionInsights(); break;
                case 'analytics': t.innerText = 'Financial Health Board'; window.renderAnalytics(); break;
                case 'budget': t.innerText = 'Monthly Budgeting'; c.innerHTML = window.renderBudgetUI(); break;
            }
            lucide.createIcons();
        };

        window.renderAnalytics = function() {
            const c = document.getElementById('modal-content');
            c.innerHTML = `<div class="space-y-12 py-4 text-center">
                <div class="bg-white p-8 rounded-[3rem] border shadow-sm text-center"><h4 class="text-[10px] font-black uppercase text-slate-400 mb-4 tracking-[0.2em] text-center">Retention Ratio</h4><div class="max-w-[280px] mx-auto text-center text-center"><canvas id="savingsGauge"></canvas></div><div id="savingsRateTxt" class="text-3xl font-black text-emerald-500 mt-[-40px] text-center text-center">0%</div></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-center text-center"><div class="bg-white p-6 rounded-[3rem] border shadow-sm text-center text-center"><h4 class="text-[10px] font-black uppercase text-slate-400 mb-6 text-center text-center">Equity vs Liability</h4><canvas id="debtRatioChart" height="150"></canvas></div><div class="bg-white p-6 rounded-[3rem] border shadow-sm text-center text-center text-center"><h4 class="text-[10px] font-black uppercase text-slate-400 mb-6 text-center text-center">Cash vs Growth</h4><canvas id="liquidChart"></canvas></div></div>
                <div class="bg-white p-8 rounded-[3rem] border shadow-sm text-center text-center text-center"><h4 class="text-[10px] font-black uppercase text-slate-400 mb-6 text-center text-center">Cash Flow comparison</h4><canvas id="incomeVsExpenseBarChart" height="200"></canvas></div>
                <div class="bg-white p-8 rounded-[3rem] border shadow-sm text-center text-center text-center"><h4 class="text-[10px] font-black uppercase text-slate-400 mb-6 text-center text-center">Exposure Audit</h4><div class="max-w-[300px] mx-auto text-center text-center"><canvas id="currencyChart"></canvas></div></div>
            </div>`;
            const ts = [...state.data.transactions], r = state.data.settings.rate;
            // Updated analytics to IGNORE internal transfers (logic: investment is not expense)
            const inc = ts.filter(t=>t.type==='income').reduce((s,t)=>{ const acc = state.data.accounts.find(a=>a.id===t.accountId); const cur = t.currency || acc?.currency || 'AED'; return s + (Number(t.amount) * (cur === 'AED' ? r : 1)); }, 0);
            const exp = ts.filter(t=>t.type==='expense').reduce((s,t)=>{ const acc = state.data.accounts.find(a=>a.id===t.accountId); const cur = t.currency || acc?.currency || 'AED'; return s + (Number(t.amount) * (cur === 'AED' ? r : 1)); }, 0);
            const sRate = inc > 0 ? Math.max(0, Math.round(((inc - exp) / inc) * 100)) : 0;
            document.getElementById('savingsRateTxt').innerText = `${sRate}%`;
            new Chart(document.getElementById('savingsGauge'), { type: 'doughnut', data: { datasets: [{ data: [sRate, 100 - sRate], backgroundColor: ['#10b981', '#f1f5f9'], borderWidth: 0 }] }, options: { rotation: 270, circumference: 180, cutout: '80%', plugins: { legend: { display: false } } } });
            const totalAssets = state.data.accounts.reduce((s,a)=>s+(a.balance*(a.currency==='AED'?r:1)),0), totalDebts = state.data.debts.filter(d=>!d.settled && d.type==='payable').reduce((s,d)=>s+(Number(d.amount)*(d.currency==='AED'?r:1)),0);
            new Chart(document.getElementById('debtRatioChart'), { type: 'bar', data: { labels: ['Wealth'], datasets: [{ label: 'Equity', data: [totalAssets - totalDebts], backgroundColor: '#10b981' }, { label: 'Liability', data: [totalDebts], backgroundColor: '#f87171' }] }, options: { indexAxis: 'y', scales: { x: { stacked: true, display: false }, y: { stacked: true, display: false } }, plugins: { legend: { position: 'bottom' } } } });
            const cash = state.data.accounts.filter(a=>['Bank Account', 'Cash'].includes(a.type)).reduce((s,a)=>s+(a.balance*(a.currency==='AED'?r:1)),0), inv = state.data.accounts.filter(a=>!['Bank Account', 'Cash'].includes(a.type)).reduce((s,a)=>s+(a.balance*(a.currency==='AED'?r:1)),0);
            new Chart(document.getElementById('liquidChart'), { type: 'doughnut', data: { labels: ['Liquid', 'Invested'], datasets: [{ data: [cash, inv], backgroundColor: ['#3b82f6', '#10b981'], borderWidth: 0 }] }, options: { plugins: { legend: { position: 'bottom' } } } });
            const monthly = {}; for(let i=5; i>=0; i--) { const d = new Date(); d.setMonth(d.getMonth()-i); const m = d.toLocaleString('default', {month:'short'}); monthly[m] = { income: 0, expense: 0 }; }
            ts.forEach(t => { const m = new Date(t.date).toLocaleString('default', {month:'short'}); if(monthly[m]) { const acc = state.data.accounts.find(a=>a.id===t.accountId); const cur = t.currency || acc?.currency || 'AED'; const v = Number(t.amount)*(cur==='AED'?r:1); if(t.type==='income') monthly[m].income+=v; else if(t.type==='expense') monthly[m].expense+=v; } });
            new Chart(document.getElementById('incomeVsExpenseBarChart'), { type: 'bar', data: { labels: Object.keys(monthly), datasets: [{ label: 'Earnings', data: Object.values(monthly).map(v=>v.income), backgroundColor: '#10b981' }, { label: 'Spending', data: Object.values(monthly).map(v=>v.expense), backgroundColor: '#f87171' }] }, options: { scales: { x: { grid: { display: false } } } } });
            const aed = state.data.accounts.filter(a=>a.currency==='AED').reduce((s,a)=>s+a.balance,0), inr = state.data.accounts.filter(a=>a.currency==='INR').reduce((s,a)=>s+a.balance,0);
            new Chart(document.getElementById('currencyChart'), { type: 'pie', data: { labels: ['AED Node', 'INR Node'], datasets: [{ data: [aed*r, inr], backgroundColor: ['#0d9488', '#f59e0b'], borderWidth: 0 }] } });
        };

        window.renderSettingsUI = function() {
            return `<div class="max-w-2xl mx-auto space-y-12 py-4">
                <div class="bg-slate-50 p-10 rounded-[3rem] border flex justify-between items-center text-left"><div><p class="font-black text-slate-900 text-2xl tracking-tighter">Privacy Mode</p><p class="text-xs text-slate-400 font-bold">Hide primary balances</p></div><button onclick="window.toggleVisibility()" class="p-5 ${state.data.settings.isPrivate ? 'bg-emerald-500 text-white' : 'bg-white'} rounded-3xl border transition-all text-center"><i data-lucide="${state.data.settings.isPrivate ? 'eye-off' : 'eye'}" class="w-8 h-8 mx-auto text-center"></i></button></div>
                <div class="bg-slate-50 p-10 rounded-[3rem] border text-center text-center"><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Rate adjustment</p><div class="flex items-center justify-center space-x-4 text-3xl font-black"><span>1 AED =</span><input type="number" id="sr" step="0.01" value="${state.data.settings.rate}" class="w-32 p-3 border rounded-2xl text-center outline-none focus:border-emerald-500 font-black"><span>INR</span></div></div>
                <div class="bg-emerald-50 p-10 rounded-[3rem] border border-emerald-100 text-center text-center"><p class="text-[10px] font-black text-emerald-700 uppercase mb-6 tracking-widest text-center">Backup System</p><div class="grid grid-cols-2 gap-4 text-center text-center"><button onclick="window.exportBackup()" class="bg-emerald-600 text-white p-4 rounded-xl font-black uppercase text-[10px] shadow-md text-center">Export Full Data</button><label class="bg-slate-900 text-white p-4 rounded-xl font-black uppercase text-[10px] shadow-md cursor-pointer text-center">Import Node History<input type="file" class="hidden text-center" onchange="window.importBackup(this)"></label></div></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-center">
                    <div class="bg-white p-8 rounded-[3rem] border shadow-sm text-center"><h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-6">Income Sources</h4><div class="flex space-x-2 mb-6 text-center text-center text-center"><input type="text" id="new-inc-cat" placeholder="Source" class="flex-1 p-3 border rounded-xl outline-none focus:border-emerald-500 text-center"><button onclick="window.addCategory('income')" class="bg-slate-900 text-white px-4 rounded-xl font-bold uppercase text-[10px] text-center">Add</button></div><div class="space-y-2">${state.data.incomeCategories.map(c => `<div class="flex justify-between items-center p-3 bg-slate-50 border rounded-xl text-center"><span class="text-[10px] font-black uppercase text-center">${c}</span><button onclick="window.delCategory('income', '${c}')" class="text-red-300"><i data-lucide="x" class="w-3 h-3 text-center"></i></button></div>`).join('')}</div></div>
                    <div class="bg-white p-8 rounded-[3rem] border shadow-sm text-center text-center"><h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-6 text-center">Expense Types</h4><div class="flex space-x-2 mb-6 text-center text-center"><input type="text" id="new-exp-cat" placeholder="Type" class="flex-1 p-3 border rounded-xl outline-none focus:border-emerald-500 text-center"><button onclick="window.addCategory('expense')" class="bg-slate-900 text-white px-4 rounded-xl font-bold uppercase text-[10px] text-center">Add</button></div><div class="space-y-2 text-center">${state.data.expenseCategories.map(c => `<div class="flex justify-between items-center p-3 bg-slate-50 border rounded-xl text-center"><span class="text-[10px] font-black uppercase text-center">${c}</span><button onclick="window.delCategory('expense', '${c}')" class="text-red-300 text-center"><i data-lucide="x" class="w-3 h-3 text-center"></i></button></div>`).join('')}</div></div>
                </div>
                <button onclick="window.svS()" class="w-full bg-emerald-500 text-white p-5 rounded-[2rem] font-black shadow-2xl uppercase tracking-widest text-center">Authorize Changes</button>
                <div class="mt-8 p-6 bg-red-50 rounded-[2rem] border border-red-100 text-center">
                    <p class="text-[10px] font-black text-red-400 uppercase tracking-widest mb-4">Danger Zone</p>
                    <button onclick="window.resetData()" class="bg-red-500 text-white px-6 py-3 rounded-xl font-black uppercase text-xs shadow-lg hover:bg-red-600 transition-all">Reset All Data</button>
                </div>
            </div>`;
        }
        
        window.resetData = async function() {
            if(!confirm("⚠️ DANGER ZONE ⚠️\n\nThis will permanently delete ALL accounts, transactions, and settings.\n\nAre you sure you want to reset everything?")) return;
            
            try {
                // Reset to defaults
                state.data = { 
                    accounts: [], 
                    transactions: [], 
                    debts: [], 
                    budgets: {}, 
                    settings: { rate: 22.75, isPrivate: false }, 
                    incomeCategories: ['Salary', 'Bonus', 'Investment Return', 'Other'], 
                    expenseCategories: ['Rent', 'Food', 'Utilities', 'Investment', 'Family', 'Other'], 
                    assetTypes: ['Bank Account', 'Cash', 'Savings', 'Investment'] 
                };
                
                await updateDb();
                alert("System Reset Complete.");
                window.location.reload(); // Force reload to ensure clean state
            } catch (error) {
                console.error("Reset failed:", error);
                alert("Reset failed: " + error.message);
            }
        };

        window.renderBudgetUI = function() {
            const now = new Date(); const mStart = new Date(now.getFullYear(), now.getMonth(), 1); const mEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            const spent = {}; state.data.transactions.filter(t => t.type === 'expense' && new Date(t.date) >= mStart && new Date(t.date) <= mEnd).forEach(t => { const acc = state.data.accounts.find(a=>a.id===t.accountId); const cur = t.currency || acc?.currency || 'AED'; spent[t.category] = (spent[t.category] || 0) + (Number(t.amount) * (cur === 'AED' ? state.data.settings.rate : 1)); });
            return `<div class="max-w-2xl mx-auto space-y-10 py-4 text-center"><div class="flex justify-between items-center px-4"><div class="text-left text-center"><h3>Monthly Budget</h3><p class="text-xs text-slate-400 font-bold uppercase text-left">Targets (INR)</p></div><button onclick="window.openBudgetSettings()" class="bg-slate-900 text-white p-3 rounded-2xl font-black uppercase text-[10px] text-center">Config</button></div><div class="space-y-6">${state.data.expenseCategories.map(cat => { const s = spent[cat] || 0; const b = state.data.budgets[cat] || 0; const p = b > 0 ? Math.min(100, (s / b) * 100) : (s > 0 ? 100 : 0); const col = p > 90 ? 'bg-red-500' : (p > 70 ? 'bg-amber-500' : 'bg-emerald-500'); return `<div class="bg-white p-6 rounded-[2rem] border shadow-sm space-y-4 text-center"><div class="flex justify-between items-center"><span class="font-black uppercase text-xs">${cat}</span><div><span class="font-black text-sm">₹${Math.round(s).toLocaleString()}</span><span class="text-[10px] text-slate-300 ml-1">/ ₹${Math.round(b).toLocaleString()}</span></div></div><div class="h-3 w-full bg-slate-50 rounded-full overflow-hidden text-center"><div class="${col} h-full text-center" style="width: ${p}%"></div></div></div>`; }).join('')}</div></div>`;
        }

        window.renderDebtUI = function() {
            const p = state.data.debts.filter(d=>!d.settled && d.type==='payable'), r = state.data.debts.filter(d=>!d.settled && d.type==='receivable');
            const item = (d) => `<div class="grid grid-cols-[auto,1fr,auto] gap-4 items-center p-5 bg-white border border-slate-100 rounded-[2rem] shadow-sm mb-4 text-center"><div class="bg-slate-50 p-3 rounded-2xl text-slate-300 text-center"><i data-lucide="user" class="w-5 h-5 mx-auto text-center text-center text-center"></i></div><div class="text-left text-center"><p class="text-sm font-black text-slate-800 leading-none mb-1 text-left text-center">${d.party}</p><p class="text-[9px] font-bold text-slate-400 uppercase text-left text-center">Target: ${d.repaymentDate || '...'}</p></div><div class="flex items-center space-x-2 text-center text-center">${d.type==='receivable'?`<button onclick="window.copyReminder('${d.party}','${d.amount}','${d.currency}','${d.repaymentDate}')" class="p-2.5 text-slate-400 hover:text-emerald-500 border border-slate-50 rounded-xl"><i data-lucide="message-square" class="w-4 h-4 mx-auto"></i></button>`:''}<p class="font-black text-sm text-slate-900">${d.amount} <span class="text-[9px] opacity-40">${d.currency}</span></p><button onclick="window.openSettleFlow('${d.id}')" class="bg-emerald-50 text-emerald-600 p-2.5 rounded-xl hover:bg-emerald-500 hover:text-white transition-all text-center"><i data-lucide="check" class="w-4 h-4 mx-auto"></i></button><button onclick="window.writeOffDebt('${d.id}')" class="bg-red-50 text-red-400 p-2.5 rounded-xl hover:bg-red-500 hover:text-white transition-all text-center" title="Write Off / Forgive"><i data-lucide="x" class="w-4 h-4 mx-auto"></i></button></div></div>`;
            return `<div class="max-w-2xl mx-auto space-y-12 text-center text-center text-center">
                <div class="bg-slate-50 p-10 rounded-[3rem] border space-y-6 text-center text-center text-center">
                    <div class="grid grid-cols-2 gap-4 text-center text-center"><select id="dt" class="p-4 border rounded-xl font-bold bg-white text-sm text-center"><option value="payable">I Owe (Liability)</option><option value="receivable">Owed to me (Asset)</option></select><input type="text" id="dw" placeholder="Person / Entity" class="p-4 border rounded-xl font-bold text-sm text-center text-center"></div>
                    <div class="grid grid-cols-2 gap-4 text-center text-center"><select id="dc" class="p-4 border rounded-xl font-bold bg-white text-sm text-center"><option value="AED">AED</option><option value="INR">INR</option></select><input type="number" id="da" placeholder="Amount" class="p-4 border rounded-xl font-black text-sm text-center text-center"></div>
                    
                    <div class="bg-white p-4 rounded-2xl border border-slate-100">
                        <p class="text-[9px] font-black uppercase text-slate-400 mb-2">Linked Account (Optional)</p>
                        <select id="ds" class="w-full p-3 border rounded-xl font-bold bg-slate-50 text-xs text-center">
                            <option value="">-- No Balance Adjustment --</option>
                            ${state.data.accounts.map(a => `<option value="${a.id}">${a.name} (${a.currency})</option>`).join('')}
                        </select>
                    </div>

                    <input type="date" id="drd" class="w-full p-4 border rounded-xl font-bold text-center text-center text-center">
                    <button id="btn-commit-debt" onclick="window.commitDebt()" class="w-full bg-amber-500 text-white p-4 rounded-xl font-black uppercase text-xs shadow-lg active:scale-95 text-center text-center">Commit Node</button>
                </div>
                <div><h4 class="text-[10px] font-black text-red-400 uppercase tracking-widest ml-4 mb-4 text-left text-center">Liabilities</h4>${p.map(item).join('') || '<p class="text-center py-4 text-slate-200 uppercase font-black text-center text-center text-center">Cleared</p>'}</div>
                <div><h4 class="text-[10px] font-black text-emerald-500 uppercase tracking-widest ml-4 mb-4 text-left text-center">Assets</h4>${r.map(item).join('') || '<p class="text-center py-4 text-slate-200 uppercase font-black text-center text-center text-center">Cleared</p>'}</div>
            </div>`;
        }

        window.renderDistributionInsights = function() {
            const spend = state.data.transactions.filter(t => t.type === 'expense'), total = spend.reduce((s, t) => { const acc = state.data.accounts.find(a=>a.id===t.accountId); const cur = t.currency || acc?.currency || 'AED'; return s + (Number(t.amount) * (cur === 'AED' ? state.data.settings.rate : 1)); }, 0);
            return `<div class="max-w-xl mx-auto p-10 bg-white rounded-[3rem] border text-center shadow-sm text-center text-center text-center text-center"><h4 class="text-[10px] font-black uppercase text-slate-400 mb-10 tracking-widest text-center text-center text-center">Weight distribution</h4><div class="space-y-8 text-center text-center text-center text-center text-center">${[...new Set(spend.map(t=>t.category))].map(cat => { const val = spend.filter(t=>t.category===cat).reduce((s, t) => { const acc = state.data.accounts.find(a=>a.id===t.accountId); const cur = t.currency || acc?.currency || 'AED'; return s + (Number(t.amount) * (cur === 'AED' ? state.data.settings.rate : 1)); }, 0), p = total > 0 ? (val / total * 100) : 0; return `<div class="space-y-3 text-left text-center text-center text-center text-center text-center text-center"><div class="flex justify-between text-[10px] font-black uppercase text-center text-center text-center"><span>${cat}</span><span>₹${Math.round(val).toLocaleString()}</span></div><div class="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden text-center text-center text-center text-center text-center text-center text-center" style="width: 100%"><div class="h-full bg-emerald-500 text-center text-center text-center text-center text-center text-center text-center" style="width: ${p}%"></div></div></div>`; }).join('') || '<p class="text-xs italic text-slate-300">No records</p>'}</div></div>`;
        }

        window.addCategory = async function(type) { 
            const inpId = type === 'income' ? 'new-inc-cat' : 'new-exp-cat'; 
            const listKey = type === 'income' ? 'incomeCategories' : 'expenseCategories';
            const val = document.getElementById(inpId)?.value?.trim();
            if(!val || state.data[listKey].includes(val)) return;
            state.data[listKey].push(val); await updateDb(); window.openModal('settings');
        };

        window.delCategory = async function(type, cat) {
            const listKey = type === 'income' ? 'incomeCategories' : 'expenseCategories';
            state.data[listKey] = state.data[listKey].filter(c => c !== cat);
            await updateDb(); window.openModal('settings');
        };

        window.handleLogin = function() {
            const e = document.getElementById('login-email').value, p = document.getElementById('login-pass').value;
            signInWithEmailAndPassword(auth, e, p).catch(() => {
                const msg = document.getElementById('auth-error-msg');
                if(msg) { msg.innerText = "Invalid credentials."; msg.classList.remove('hidden'); }
            });
        };

        window.handleRegister = function() {
            const e = document.getElementById('login-email').value, p = document.getElementById('login-pass').value;
            createUserWithEmailAndPassword(auth, e, p).catch(() => alert("Registry failed."));
        };

        window.openBudgetSettings = function() {
            document.getElementById('modal-content').innerHTML = `<div class="max-w-md mx-auto bg-slate-50 p-10 rounded-[3rem] border space-y-6 text-center text-center text-center text-center text-center text-center text-center"><p class="text-[10px] font-black uppercase text-center text-center text-center">Limits (INR)</p><div class="space-y-4 text-center text-center text-center text-center text-center text-center">${state.data.expenseCategories.map(cat => `<div class="flex items-center space-x-4 text-center text-center text-center text-center text-center"><span class="w-1/3 text-xs font-black text-left text-center text-center text-center text-center text-center text-center text-center">${cat}</span><input type="number" id="budget-${cat}" value="${state.data.budgets[cat] || 0}" class="w-2/3 p-4 border rounded-xl font-black text-center text-center text-center text-center text-center text-center"></div>`).join('')}</div><button onclick="window.saveBudgets()" class="w-full bg-emerald-500 text-white p-5 rounded-2xl font-black uppercase text-center text-center text-center text-center text-center text-center text-center">Update Targets</button></div>`;
        };

        window.saveBudgets = async function() { state.data.expenseCategories.forEach(cat => { state.data.budgets[cat] = parseFloat(document.getElementById(`budget-${cat}`).value) || 0; }); await updateDb(); window.openModal('budget'); };
        window.toggleVisibility = function() { state.data.settings.isPrivate = !state.data.settings.isPrivate; updateDb().then(renderApp); };
        window.svS = async function() { const r = parseFloat(document.getElementById('sr').value); if(!isNaN(r)) state.data.settings.rate = r; await updateDb(); closeModal(); };
        window.exportBackup = function() { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(state.data)], {type:'application/json'})); a.download = `Wealth_Back_${new Date().toISOString().split('T')[0]}.json`; a.click(); };
        window.importBackup = function(i) { const reader = new FileReader(); reader.onload = async (e) => { try { const imp = JSON.parse(e.target.result); if (imp.accounts) { state.data = imp; await updateDb(); alert("Restored."); closeModal(); } } catch(err) { alert("Error."); } }; if(i.files[0]) reader.readAsText(i.files[0]); };
        window.copyReminder = function(party, amount, currency, date) { const msg = `Hi ${party}, a friendly reminder regarding the repayment of ${amount} ${currency} scheduled for ${date || 'today'}. Please settle it when you have a moment. Thanks!`; const el = document.createElement('textarea'); el.value = msg; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); alert("Draft Copied!"); };
        window.delAccount = async function(id) { if(!confirm("Permanently wipe?")) return; state.data.accounts = state.data.accounts.filter(x=>x.id!==id); await updateDb(); closeModal(); };
        
        window.commitDebt = function() { 
            const t = document.getElementById('dt').value; 
            const w = document.getElementById('dw').value;
            const c = document.getElementById('dc').value;
            const a = parseFloat(document.getElementById('da').value);
            const r = document.getElementById('drd').value;
            const sAccId = document.getElementById('ds').value;

            if(!w || isNaN(a)) return;
            
            // LOCK BUTTON
            window.setBtnLoading('btn-commit-debt', true);

            // Handle Balance Adjustment
            if (sAccId) {
                const accIdx = state.data.accounts.findIndex(acc => acc.id === sAccId);
                if (accIdx > -1) {
                    const acc = state.data.accounts[accIdx];
                    const rate = state.data.settings.rate;
                    let adjAmount = a; 

                    if (acc.currency !== c) {
                        if (acc.currency === 'AED' && c === 'INR') adjAmount = a / rate; 
                        else if (acc.currency === 'INR' && c === 'AED') adjAmount = a * rate; 
                    }

                    if (t === 'receivable') {
                        state.data.accounts[accIdx].balance = window.toCurrency(state.data.accounts[accIdx].balance - adjAmount);
                        state.data.transactions.push({ id: window.genId(), accountId: sAccId, amount: window.toCurrency(adjAmount), type: 'transfer_out', category: 'Lending', note: `Lent to ${w}`, date: new Date().toISOString() });
                    } else {
                        state.data.accounts[accIdx].balance = window.toCurrency(state.data.accounts[accIdx].balance + adjAmount);
                        state.data.transactions.push({ id: window.genId(), accountId: sAccId, amount: window.toCurrency(adjAmount), type: 'transfer_in', category: 'Borrowing', note: `Borrowed from ${w}`, date: new Date().toISOString() });
                    }
                }
            }

            state.data.debts.push({ id: window.genId(), type: t, party: w, currency: c, amount: a, repaymentDate: r, settled: false }); 
            updateDb().then(() => {
                window.openModal('debt');
                // No need to reset button loading state here as modal refreshes content
            }); 
        };
        
        window.writeOffDebt = async function(id) {
            const dIdx = state.data.debts.findIndex(i => i.id === id);
            const d = state.data.debts[dIdx];
            const isReceivable = d.type === 'receivable';
            const msg = isReceivable ? 
                "Write off this Bad Debt? (Records as Expense, no cash received)" : 
                "Mark as Forgiven? (Records as Income, no cash paid)";
            
            if(!confirm(msg)) return;

            state.data.debts[dIdx].settled = true;
            
            // Create a Ledger Entry for the Record
            state.data.transactions.push({
                id: window.genId(),
                accountId: 'virtual_writeoff', // Special ID
                amount: window.toCurrency(d.amount),
                currency: d.currency, // Store currency directly in transaction for these cases
                type: isReceivable ? 'expense' : 'income', // Expense = Loss of asset, Income = Loss of liability
                category: isReceivable ? 'Bad Debt' : 'Forgiven Debt',
                note: `Write-off: ${d.party}`,
                date: new Date().toISOString()
            });
            
            await updateDb();
            window.renderDebtUI();
            window.renderApp(); 
        };

        window.calcRemit = function(v) { 
            const sId = document.getElementById('ts').value, tId = document.getElementById('ttg').value;
            const sAcc = state.data.accounts.find(a=>a.id===sId), tAcc = state.data.accounts.find(a=>a.id===tId);
            const rate = state.data.settings.rate;
            let est = 0;
            if(sAcc && tAcc) {
                if(sAcc.currency === tAcc.currency) est = parseFloat(v);
                else if(sAcc.currency === 'AED' && tAcc.currency === 'INR') est = parseFloat(v) * rate;
                else if(sAcc.currency === 'INR' && tAcc.currency === 'AED') est = parseFloat(v) / rate;
                else est = parseFloat(v); 
            }
            const el = document.getElementById('remit-preview'); 
            if(el) el.innerText = `Estimate: ${est.toFixed(2)} ${tAcc ? tAcc.currency : ''}`; 
        };
        
        window.setT = function(t) {
            document.getElementById('tt').value = t;
            const list = t === 'income' ? state.data.incomeCategories : state.data.expenseCategories;
            const select = document.getElementById('tc');
            if(select) select.innerHTML = list.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('be').className = t==='expense' ? "p-4 rounded-xl border-4 border-emerald-500 bg-emerald-50 text-emerald-700 font-black text-xs uppercase" : "p-4 rounded-xl border-4 border-slate-100 text-slate-300 font-black text-xs uppercase";
            document.getElementById('bi').className = t==='income' ? "p-4 rounded-xl border-4 border-emerald-500 bg-emerald-50 text-emerald-700 font-black text-xs uppercase" : "p-4 rounded-xl border-4 border-slate-100 text-slate-300 font-black text-xs uppercase";
        };

        window.saveAccount = async function() {
            const n = document.getElementById('an').value, c = document.getElementById('ac').value, t = document.getElementById('at').value, b = parseFloat(document.getElementById('ab').value)||0;
            if(!n) return; 
            window.setBtnLoading('btn-save-acc', true);
            state.data.accounts.push({ id: window.genId(), name: n, currency: c, type: t, balance: window.toCurrency(b) });
            await updateDb(); closeModal();
        };

        window.saveTransaction = async function() {
            const aId = document.getElementById('ta').value, amt = parseFloat(document.getElementById('tam').value), type = document.getElementById('tt').value, cat = document.getElementById('tc').value, note = document.getElementById('tn').value;
            if(!aId || isNaN(amt)) return; 
            
            window.setBtnLoading('btn-save-tx', true);
            
            const idx = state.data.accounts.findIndex(a=>a.id===aId);
            const currentBal = state.data.accounts[idx].balance;
            state.data.accounts[idx].balance = window.toCurrency(type==='income' ? currentBal + amt : currentBal - amt);
            
            state.data.transactions.push({ id: window.genId(), accountId: aId, amount: window.toCurrency(amt), type, category: cat, note, date: new Date().toISOString() });
            await updateDb(); closeModal();
        };

        window.doTransfer = async function() {
            const sId = document.getElementById('ts').value, tId = document.getElementById('ttg').value, val = parseFloat(document.getElementById('tamt').value), n = document.getElementById('trn').value;
            if(!sId || !tId || isNaN(val)) return; 
            
            window.setBtnLoading('btn-do-transfer', true);

            const rate = state.data.settings.rate;
            const sIdx = state.data.accounts.findIndex(x=>x.id===sId), tIdx = state.data.accounts.findIndex(x=>x.id===tId);
            const sAcc = state.data.accounts[sIdx], tAcc = state.data.accounts[tIdx];
            
            let finalAmt = val;
            if(sAcc.currency !== tAcc.currency) {
                if(sAcc.currency === 'AED' && tAcc.currency === 'INR') finalAmt = val * rate;
                else if(sAcc.currency === 'INR' && tAcc.currency === 'AED') finalAmt = val / rate;
            }

            state.data.accounts[sIdx].balance = window.toCurrency(state.data.accounts[sIdx].balance - val);
            state.data.accounts[tIdx].balance = window.toCurrency(state.data.accounts[tIdx].balance + finalAmt);
            
            state.data.transactions.push({ id: window.genId(), accountId: sId, amount: window.toCurrency(val), type: 'transfer_out', category: 'Transfer', note: `To ${tAcc.name}: ${n}`, date: new Date().toISOString() });
            state.data.transactions.push({ id: window.genId(), accountId: tId, amount: window.toCurrency(finalAmt), type: 'transfer_in', category: 'Transfer', note: `From ${sAcc.name}: ${n}`, date: new Date().toISOString() });
            
            await updateDb(); closeModal();
        };

        window.openSettleFlow = function(id) {
            const d = state.data.debts.find(x=>x.id===id), c = document.getElementById('modal-content');
            document.getElementById('modal-title').innerText = "Process Settlement";
            c.innerHTML = `<div class="max-w-md mx-auto bg-slate-50 p-10 rounded-[3rem] border space-y-6 text-center shadow-xl">
                <p class="text-[10px] font-black uppercase">Entity: ${d.party}</p>
                <p class="text-3xl font-black">${d.amount} <span class="text-xs opacity-30">${d.currency}</span></p>
                <div class="text-left text-center"><label class="text-[10px] font-black uppercase block mb-1">Enter Volume</label><input type="number" id="samt" step="0.01" value="${d.amount}" class="w-full p-4 border rounded-xl font-black text-xl text-center outline-none"></div>
                <div class="text-left text-center"><label class="text-[10px] font-black uppercase block mb-1">Select account</label><select id="sacc" class="w-full p-4 border rounded-xl bg-white font-bold text-center">${state.data.accounts.map(acc=>`<option value="${acc.id}">${acc.name} (${acc.currency})</option>`).join('')}</select></div>
                <button id="btn-finalize-settle" onclick="window.finalizeSettle('${id}')" class="w-full bg-emerald-500 text-white p-5 rounded-2xl font-black uppercase shadow-lg text-center text-center">Authorize Movement</button>
            </div>`;
            window.closeReminder(); document.getElementById('modal-backdrop').classList.replace('hidden', 'flex');
        };

        window.finalizeSettle = async function(id) {
            const aId = document.getElementById('sacc').value, amt = parseFloat(document.getElementById('samt').value);
            const dIdx = state.data.debts.findIndex(d => d.id === id), d = state.data.debts[dIdx], aIdx = state.data.accounts.findIndex(a=>a.id===aId);
            if (aIdx === -1 || isNaN(amt) || amt <= 0 || amt > d.amount) return;
            
            window.setBtnLoading('btn-finalize-settle', true);

            const currentBal = state.data.accounts[aIdx].balance;
            state.data.accounts[aIdx].balance = window.toCurrency(d.type==='receivable' ? currentBal + amt : currentBal - amt);
            
            state.data.transactions.push({ id: window.genId(), accountId: aId, amount: window.toCurrency(amt), type: d.type==='receivable'?'income':'expense', category: 'Settlement', note: d.party, date: new Date().toISOString() });
            
            if (amt === d.amount) state.data.debts[dIdx].settled = true; 
            else state.data.debts[dIdx].amount = window.toCurrency(d.amount - amt);
            
            await updateDb(); renderApp();
            document.getElementById('modal-content').innerHTML = `<div class="flex flex-col items-center justify-center space-y-4 py-20 fade-in text-center text-center"><div class="w-20 h-20 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto text-center"><i data-lucide="check-circle-2" class="w-10 h-10"></i></div><h3 class="text-2xl font-black">Success!</h3><button onclick="window.closeModal()" class="px-8 py-3 bg-slate-900 text-white rounded-xl font-bold uppercase text-[10px] text-center">Done</button></div>`;
            lucide.createIcons();
        };

        window.openRescheduleFlow = function(id) {
            const d = state.data.debts.find(x=>x.id===id), b = document.getElementById('modal-backdrop'), t = document.getElementById('modal-title'), c = document.getElementById('modal-content');
            t.innerText = "Schedule Later";
            c.innerHTML = `<div class="max-w-md mx-auto bg-white p-10 rounded-[3rem] border shadow-xl space-y-6 text-center text-center"><p class="text-[10px] font-black uppercase text-slate-400">Extension for ${d.party}</p><div class="text-left text-center"><label class="text-[10px] font-black uppercase block mb-2 text-center text-center">New Date</label><input type="date" id="new-date" class="w-full p-4 border rounded-xl font-bold text-center outline-none"></div><button id="btn-resched" onclick="window.finalizeReschedule('${id}')" class="w-full bg-slate-900 text-white p-5 rounded-3xl font-black uppercase shadow-lg text-center text-center">Commit</button></div>`;
            b.classList.replace('hidden', 'flex'); window.closeReminder(); lucide.createIcons();
        };

        window.finalizeReschedule = async function(id) {
            const dt = document.getElementById('new-date').value; if (!dt) return;
            window.setBtnLoading('btn-resched', true);
            state.data.debts[state.data.debts.findIndex(i => i.id === id)].repaymentDate = dt;
            await updateDb(); renderApp();
            document.getElementById('modal-content').innerHTML = `<div class="flex flex-col items-center justify-center space-y-6 py-20 fade-in text-center text-center text-center"><div class="w-20 h-20 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center mx-auto text-center"><i data-lucide="calendar-check" class="w-12 h-12"></i></div><h3 class="text-2xl font-black text-center text-center">Updated</h3><button onclick="window.closeModal()" class="px-8 py-3 bg-slate-900 text-white rounded-xl font-bold uppercase text-[10px] text-center">Done</button></div>`;
            lucide.createIcons();
        };

        window.viewAccountLedger = function(id) {
            const a = state.data.accounts.find(x=>x.id===id), ts = state.data.transactions.filter(t=>t.accountId===id).sort((x,y)=>new Date(y.date)-new Date(x.date));
            const t = document.getElementById('modal-title'), c = document.getElementById('modal-content');
            t.innerText = a.name + " Analytics";
            c.innerHTML = `<div class="space-y-10 text-center"><div class="bg-slate-900 text-white p-10 rounded-[3rem] text-center space-y-2 shadow-xl"><p class="text-[10px] text-emerald-400 font-black uppercase mb-2">Balance</p><p class="text-5xl font-black text-center">${a.balance.toFixed(2)} ${a.currency}</p><button onclick="window.delAccount('${id}')" class="text-red-400 text-xs font-bold pt-4 hover:underline">Delete node</button></div><div class="space-y-4 text-left"><h4 class="text-xs font-black uppercase text-slate-400 tracking-widest px-2">Audit history</h4>${ts.map(t=> {
                const isPositive = t.type === 'income' || t.type === 'transfer_in';
                const color = isPositive ? 'text-emerald-500' : 'text-red-400';
                const sign = isPositive ? '+' : '-';
                return `<div class="p-6 bg-white border border-slate-100 rounded-3xl flex justify-between items-center shadow-sm text-center"><div><p class="font-bold text-left">${t.category}</p><p class="text-[10px] font-black text-slate-400 uppercase text-left">${new Date(t.date).toLocaleDateString()} — ${t.note||'...'}</p></div><p class="font-black text-lg ${color} text-right">${sign}${t.amount.toFixed(2)}</p></div>`;
            }).join('') || '<p class="text-center py-10 text-slate-300 italic text-center">Zero logs</p>'}</div></div>`;
            document.getElementById('modal-backdrop').classList.replace('hidden', 'flex'); lucide.createIcons();
        };

        onAuthStateChanged(auth, (user) => {
            state.user = user;
            const projectTag = document.getElementById('project-tag');
            if (user && !user.isAnonymous) {
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-content').style.display = 'flex';
                onSnapshot(doc(db, 'artifacts', appId, 'users', user.uid, 'finance', 'main'), (snap) => {
                    if (snap.exists()) { 
                        state.data = { ...state.data, ...snap.data() }; 
                        window.checkDueDebts(); 
                        window.fetchExchangeRate(); 
                    } 
                    else { window.updateDb(); }
                    window.renderApp();
                });
            } else { 
                document.getElementById('auth-screen').style.display = 'flex'; 
                document.getElementById('app-content').style.display = 'none'; 
                if (projectTag) projectTag.innerText = `ID: ${firebaseConfig.projectId}`;
            }
            lucide.createIcons();
        });
    </script>
</body>
</html>
